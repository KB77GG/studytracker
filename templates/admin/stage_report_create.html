{% extends "base.html" %}

{% block page_subtitle %}Stage Report{% endblock %}
{% block page_title %}é˜¶æ®µå­¦ä¹ æŠ¥å‘Šç¼–è¾‘{% endblock %}

{% block content_dashboard %}
<div class="stage-wrap">
  <form method="post" class="stage-form">
    <!-- â”€â”€ åŸºç¡€ä¿¡æ¯ï¼ˆä¸å¯å…³é—­ï¼‰ â”€â”€ -->
    <section class="card panel">
      <div class="panel-head">
        <div class="panel-head-icon">ğŸ“‹</div>
        <div>
          <h2>æŠ¥å‘ŠåŸºç¡€ä¿¡æ¯</h2>
          <p class="panel-desc">é€‰æ‹©å­¦ç”Ÿå’Œé˜¶æ®µåŒºé—´ï¼Œç³»ç»Ÿè‡ªåŠ¨è®¡ç®—åˆ†ææ•°æ®</p>
        </div>
      </div>
      <div class="field-grid">
        <div class="field field-title">
          <label for="title">æŠ¥å‘Šæ ‡é¢˜</label>
          <input id="title" name="title" value="{{ title_value }}">
        </div>
        <div class="field">
          <label for="student_id">å­¦ç”Ÿ</label>
          <select id="student_id" name="student_id" required>
            {% for student in students %}
            <option value="{{ student.id }}" {% if selected_student and student.id == selected_student.id %}selected{% endif %}>
              {{ student.full_name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="field">
          <label for="start_date">é˜¶æ®µå¼€å§‹</label>
          <input id="start_date" type="date" name="start_date" value="{{ start_date.isoformat() if start_date else '' }}">
        </div>
        <div class="field">
          <label for="end_date">é˜¶æ®µç»“æŸ</label>
          <input id="end_date" type="date" name="end_date" value="{{ end_date.isoformat() if end_date else '' }}">
        </div>
      </div>
      <div class="actions">
        <button type="submit" class="btn btn-primary">ä¿å­˜æŠ¥å‘Š</button>
        {% if report %}
        <a class="btn btn-pdf" href="{{ url_for('export_stage_report_pdf', report_id=report.id) }}" target="_blank">ğŸ“„ ä¸‹è½½PDF</a>
        {% endif %}
        <a class="btn btn-outline" href="{{ url_for('stage_report_list') }}">è¿”å›åˆ—è¡¨</a>
        <a id="regenerateLink" class="btn btn-outline"
          href="{{ url_for('stage_report_create', student_id=selected_student.id if selected_student else '', start=start_date.isoformat() if start_date else '', end=end_date.isoformat() if end_date else '') }}"
        >ğŸ”„ é‡æ–°ç”Ÿæˆåˆ†æ</a>
      </div>
    </section>

    {% if stage_data %}
    {% set secs = stage_data.get('visible_sections', {}) %}

    <!-- â”€â”€ é˜¶æ®µæ¦‚è§ˆ â”€â”€ -->
    <section class="card panel togglable {{ '' if secs.get('overview', true) else 'collapsed' }}" data-key="overview">
      <input type="hidden" name="sec_overview" value="{{ '1' if secs.get('overview', true) else '0' }}">
      <div class="panel-head">
        <div class="panel-head-icon">ğŸ“Š</div>
        <h2>é˜¶æ®µæ¦‚è§ˆ</h2>
        <label class="toggle" title="åœ¨ PDF ä¸­æ˜¾ç¤º/éšè—æ­¤æ¨¡å—"><input type="checkbox" {{ 'checked' if secs.get('overview', true) }}><span class="slider"></span></label>
      </div>
      <div class="panel-body">
        <div class="metrics">
          <div class="metric"><span>é˜¶æ®µä»»åŠ¡</span><strong>{{ stage_data.total_items or 0 }}</strong></div>
          <div class="metric"><span>å®¡æ ¸å®Œæˆ</span><strong>{{ stage_data.reviewed_items or 0 }} / {{ stage_data.total_items or 0 }}</strong></div>
          <div class="metric {{ 'metric-good' if (stage_data.stage_completion_rate or 0) >= 80 else ('metric-warn' if (stage_data.stage_completion_rate or 0) >= 50 else 'metric-low') }}"><span>å®Œæˆç‡</span><strong>{{ stage_data.stage_completion_rate or 0 }}%</strong></div>
          <div class="metric {{ 'metric-good' if (stage_data.avg_mastery or 0) >= 80 else ('metric-warn' if (stage_data.avg_mastery or 0) >= 50 else 'metric-low') }}"><span>å¹³å‡æŒæ¡åº¦</span><strong>{{ stage_data.avg_mastery or 0 }}%</strong></div>
          <div class="metric"><span>è®¡åˆ’æ—¶é•¿</span><strong>{{ stage_data.planned_total or 0 }} åˆ†</strong></div>
          <div class="metric"><span>å®é™…æ—¶é•¿</span><strong>{{ stage_data.actual_total or 0 }} åˆ†</strong></div>
        </div>
        <div class="field">
          <label for="overall_comment">æ€»ä½“é˜¶æ®µè¯„ä»·</label>
          <textarea id="overall_comment" name="overall_comment" rows="3">{{ stage_data.overall_comment or '' }}</textarea>
        </div>
      </div>
    </section>

    <!-- â”€â”€ è¯¾åæ•™è¾…å®Œæˆæƒ…å†µ â”€â”€ -->
    <section class="card panel togglable {{ '' if secs.get('subjects', true) else 'collapsed' }}" data-key="subjects">
      <input type="hidden" name="sec_subjects" value="{{ '1' if secs.get('subjects', true) else '0' }}">
      <div class="panel-head">
        <div class="panel-head-icon">ğŸ“š</div>
        <h2>è¯¾åæ•™è¾…å®Œæˆæƒ…å†µ</h2>
        <label class="toggle" title="åœ¨ PDF ä¸­æ˜¾ç¤º/éšè—æ­¤æ¨¡å—"><input type="checkbox" {{ 'checked' if secs.get('subjects', true) }}><span class="slider"></span></label>
      </div>
      <div class="panel-body">
        <div class="table-wrap">
          <table class="branded-table">
            <thead><tr><th>å­¦ç§‘æ¨¡å—</th><th>å­¦ä¹ å†…å®¹</th><th>æŒæ¡åº¦</th><th>è®¡åˆ’/å®é™…</th><th>å®¡æ ¸ç‡</th><th>è€å¸ˆè¯„ä»·ï¼ˆå¯ç¼–è¾‘ï¼‰</th></tr></thead>
            <tbody>
              {% for row in stage_data.subject_rows or [] %}
              <tr>
                <td class="subject-cell">{{ row.module }}</td>
                <td>{{ row.content_text }}</td>
                <td><span class="mastery-badge {{ 'badge-good' if row.mastery_score >= 80 else ('badge-warn' if row.mastery_score >= 50 else 'badge-low') }}">{{ row.mastery_label }}ï¼ˆ{{ row.mastery_score }}%ï¼‰</span></td>
                <td>{{ row.planned_minutes }} / {{ row.actual_minutes }} åˆ†</td>
                <td>{{ row.review_rate }}%</td>
                <td><input name="teacher_comment_{{ loop.index0 }}" value="{{ row.teacher_comment or '' }}"></td>
              </tr>
              {% else %}
              <tr><td colspan="6" class="muted" style="text-align:center;">æš‚æ— å­¦ç§‘å­¦ä¹ æ•°æ®ã€‚</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- â”€â”€ å¬è¯´è¯»å†™ä¸Šè¯¾æƒ…å†µ â”€â”€ -->
    <section class="card panel togglable {{ '' if secs.get('class_summary', true) else 'collapsed' }}" data-key="class_summary">
      <input type="hidden" name="sec_class_summary" value="{{ '1' if secs.get('class_summary', true) else '0' }}">
      <div class="panel-head">
        <div class="panel-head-icon">ğŸ“</div>
        <h2>å¬è¯´è¯»å†™ä¸Šè¯¾æƒ…å†µæ€»ç»“</h2>
        <label class="toggle" title="åœ¨ PDF ä¸­æ˜¾ç¤º/éšè—æ­¤æ¨¡å—"><input type="checkbox" {{ 'checked' if secs.get('class_summary', true) }}><span class="slider"></span></label>
      </div>
      <div class="panel-body">
        <textarea
          id="class_summary_text"
          name="class_summary_text"
          rows="4"
          placeholder="è¯·å¡«å†™å¬è¯´è¯»å†™å››é—¨è¯¾ç¨‹æ•´ä½“ä¸Šè¯¾æƒ…å†µæ€»ç»“ï¼ˆè¯¾å ‚å†…å®¹ã€è¯¾å ‚è¡¨ç°ã€é—®é¢˜ä¸æ”¹è¿›è®¡åˆ’ç­‰ï¼‰..."
        >{{ stage_data.class_summary_text or '' }}</textarea>
      </div>
    </section>

    <!-- â”€â”€ æ¨¡è€ƒç‚¹è¯„ â”€â”€ -->
    <section class="card panel togglable {{ '' if secs.get('mock_exam', true) else 'collapsed' }}" data-key="mock_exam">
      <input type="hidden" name="sec_mock_exam" value="{{ '1' if secs.get('mock_exam', true) else '0' }}">
      <div class="panel-head">
        <div class="panel-head-icon">ğŸ¯</div>
        <h2>æ¨¡è€ƒç‚¹è¯„</h2>
        <label class="toggle" title="åœ¨ PDF ä¸­æ˜¾ç¤º/éšè—æ­¤æ¨¡å—"><input type="checkbox" {{ 'checked' if secs.get('mock_exam', true) }}><span class="slider"></span></label>
      </div>
      <div class="panel-body">
        <div class="table-wrap">
          <table class="branded-table">
            <thead>
              <tr>
                <th style="width: 12%;">å­¦ç§‘</th>
                <th style="width: 18%;">æ­£ç¡®ç‡</th>
                <th style="width: 18%;">æ¨¡è€ƒæˆç»©</th>
                <th>è€å¸ˆç‚¹è¯„</th>
              </tr>
            </thead>
            <tbody>
              {% for row in stage_data.mock_review_rows or [] %}
              <tr>
                <td class="subject-cell">{{ row.subject }}</td>
                <td><input name="mock_accuracy_{{ loop.index0 }}" value="{{ row.accuracy_rate or '' }}" placeholder="å¦‚ 78%"></td>
                <td><input name="mock_score_{{ loop.index0 }}" value="{{ row.mock_score or '' }}" placeholder="å¦‚ 6.0"></td>
                <td><input name="mock_comment_{{ loop.index0 }}" value="{{ row.teacher_comment or '' }}" placeholder="å¦‚ï¼šå®¡é¢˜ç¨³å®šï¼Œç»†èŠ‚ä»éœ€åŠ å¼º"></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- â”€â”€ ä¸‹é˜¶æ®µå­¦ä¹ é‡ç‚¹ä¸å»ºè®® â”€â”€ -->
    <section class="card panel togglable {{ '' if secs.get('next_plan', (secs.get('focus', true) or secs.get('suggestions', true))) else 'collapsed' }}" data-key="next_plan">
      <input type="hidden" name="sec_next_plan" value="{{ '1' if secs.get('next_plan', (secs.get('focus', true) or secs.get('suggestions', true))) else '0' }}">
      <div class="panel-head">
        <div class="panel-head-icon">ğŸ”‘</div>
        <h2>ä¸‹é˜¶æ®µå­¦ä¹ é‡ç‚¹ä¸å»ºè®®</h2>
        <label class="toggle" title="åœ¨ PDF ä¸­æ˜¾ç¤º/éšè—æ­¤æ¨¡å—"><input type="checkbox" {{ 'checked' if secs.get('next_plan', (secs.get('focus', true) or secs.get('suggestions', true))) }}><span class="slider"></span></label>
      </div>
      <div class="panel-body">
        <textarea
          id="next_stage_plan_text"
          name="next_stage_plan_text"
          rows="6"
          placeholder="è¯·å¡«å†™ä¸‹é˜¶æ®µé‡ç‚¹ä¸å»ºè®®ï¼ˆå¯æŒ‰å­¦ç§‘åˆ†æ®µï¼‰..."
        >{{ stage_data.next_stage_plan_text or '' }}</textarea>
      </div>
    </section>

    {% else %}
    <section class="card panel muted" style="text-align:center;padding:40px;">æš‚æ— å¯ç”Ÿæˆæ•°æ®ï¼Œè¯·å…ˆè¡¥å……å­¦ç”Ÿå’Œé˜¶æ®µä¿¡æ¯ã€‚</section>
    {% endif %}
  </form>
</div>

<style>
  .stage-wrap { max-width: 1100px; }
  .stage-form { display: grid; gap: 14px; }

  /* â”€â”€ Panels â”€â”€ */
  .panel { padding: 18px 20px; border-radius: 14px; }
  .panel-head {
    display: flex; align-items: center; gap: 10px; margin-bottom: 14px;
  }
  .panel-head-icon { font-size: 20px; line-height: 1; }
  .panel-head h2 { font-size: 17px; margin: 0; color: #0f766e; flex: 1; }
  .panel-desc { margin: 2px 0 0; font-size: 13px; color: #6b7280; }

  /* â”€â”€ Toggle switch â”€â”€ */
  .toggle { position: relative; display: inline-block; width: 40px; height: 22px; flex-shrink: 0; cursor: pointer; }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .slider {
    position: absolute; inset: 0; background: #cbd5e1; border-radius: 22px;
    transition: background 0.2s;
  }
  .slider::before {
    content: ''; position: absolute; left: 2px; top: 2px; width: 18px; height: 18px;
    background: #fff; border-radius: 50%; transition: transform 0.2s;
  }
  .toggle input:checked + .slider { background: #0f766e; }
  .toggle input:checked + .slider::before { transform: translateX(18px); }

  /* â”€â”€ Collapsible â”€â”€ */
  .togglable .panel-body { transition: max-height 0.25s ease, opacity 0.2s ease; overflow: hidden; }
  .togglable.collapsed .panel-body { max-height: 0; opacity: 0.3; pointer-events: none; }
  .togglable.collapsed { opacity: 0.55; }

  /* â”€â”€ Fields â”€â”€ */
  .field-grid { display: grid; gap: 12px; grid-template-columns: 2fr 1fr 1fr 1fr; }
  .field-title { min-width: 280px; }
  .field label { display: block; font-size: 12px; color: #6b7280; margin-bottom: 5px; font-weight: 600; }
  input, select, textarea {
    width: 100%; border: 1px solid #dbe2ea; border-radius: 8px;
    padding: 8px 10px; background: #fff; font-size: 14px;
    transition: border-color 0.15s, box-shadow 0.15s; box-sizing: border-box;
  }
  input:focus, select:focus, textarea:focus {
    outline: none; border-color: #0f766e; box-shadow: 0 0 0 3px rgba(15,118,110,0.1);
  }

  /* â”€â”€ Actions â”€â”€ */
  .actions { margin-top: 14px; display: flex; gap: 10px; flex-wrap: wrap; }
  .btn-outline { border: 1px solid #c9d4df; background: #fff; color: #334155 !important; }
  .btn-outline:hover { background: #f8fafc; border-color: #94a3b8; }
  .btn-pdf { border: 1px solid #0f766e; background: #f0fdfa; color: #0f766e !important; font-weight: 600; }
  .btn-pdf:hover { background: #ccfbf1; }

  /* â”€â”€ Metrics â”€â”€ */
  .metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 12px; }
  .metric {
    border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px;
    background: #fbfdff; border-left: 3px solid #e5e7eb;
  }
  .metric span { font-size: 12px; color: #6b7280; display: block; margin-bottom: 2px; }
  .metric strong { font-size: 20px; line-height: 1.2; color: #1f2937; }
  .metric-good { border-left-color: #10b981; background: #f0fdf4; }
  .metric-good strong { color: #059669; }
  .metric-warn { border-left-color: #f59e0b; background: #fffbeb; }
  .metric-warn strong { color: #d97706; }
  .metric-low { border-left-color: #ef4444; background: #fef2f2; }
  .metric-low strong { color: #dc2626; }

  /* â”€â”€ Tables â”€â”€ */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  .branded-table th {
    background: #0f766e; color: #fff; font-size: 13px; font-weight: 600;
    padding: 9px 8px; border: none; border-bottom: 2px solid #0d6962;
  }
  .branded-table td {
    border: none; border-bottom: 1px solid #e5e7eb; padding: 9px 8px;
    vertical-align: middle; font-size: 13px;
  }
  .branded-table tbody tr:hover { background: #f0fdfa; }
  .branded-table tbody tr:nth-child(even) { background: #f8fcfb; }
  .subject-cell { font-weight: 600; color: #0f766e; }
  .mastery-badge { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
  .badge-good { background: #dcfce7; color: #166534; }
  .badge-warn { background: #fef3c7; color: #92400e; }
  .badge-low  { background: #fee2e2; color: #991b1b; }

  /* â”€â”€ Skill cards â”€â”€ */
  .skill-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .skill-card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; background: #fafcfb; }
  .skill-label { font-size: 13px; font-weight: 700; color: #0f766e; margin-bottom: 6px; padding-bottom: 5px; border-bottom: 1px dashed #d1d5db; }
  .skill-card textarea { border-color: #e5e7eb; background: #fff; border-radius: 8px; }

  .muted { color: #6b7280; }

  /* â”€â”€ Responsive â”€â”€ */
  @media (max-width: 1200px) {
    .field-grid { grid-template-columns: 1fr 1fr; }
    .metrics { grid-template-columns: repeat(3, 1fr); }
  }
  @media (max-width: 960px) {
    .field-grid, .skill-grid { grid-template-columns: 1fr; }
    .metrics { grid-template-columns: repeat(2, 1fr); }
  }
</style>

<script>
  /* â”€â”€ Section toggle logic â”€â”€ */
  document.querySelectorAll('.togglable').forEach(function(section) {
    var cb = section.querySelector('.toggle input[type="checkbox"]');
    var hidden = section.querySelector('input[type="hidden"]');
    if (!cb || !hidden) return;
    cb.addEventListener('change', function() {
      if (cb.checked) {
        section.classList.remove('collapsed');
        hidden.value = '1';
      } else {
        section.classList.add('collapsed');
        hidden.value = '0';
      }
    });
  });

  /* â”€â”€ Auto title / regenerate link (create mode only) â”€â”€ */
  (function () {
    var isCreateMode = {{ 'true' if not report else 'false' }};
    if (!isCreateMode) return;

    var studentEl = document.getElementById('student_id');
    var startEl = document.getElementById('start_date');
    var endEl = document.getElementById('end_date');
    var titleEl = document.getElementById('title');
    var regenerateLink = document.getElementById('regenerateLink');
    if (!studentEl || !startEl || !endEl) return;

    var baseUrl = "{{ url_for('stage_report_create') }}";
    var titleTouched = false;

    function buildTitle() {
      var studentName = studentEl.options[studentEl.selectedIndex]?.text?.trim() || "";
      var start = startEl.value || "";
      var end = endEl.value || "";
      if (!studentName) return "é˜¶æ®µå­¦ä¹ æŠ¥å‘Š";
      if (start && end) return studentName + " é˜¶æ®µå­¦ä¹ æŠ¥å‘Š (" + start + " è‡³ " + end + ")";
      return studentName + " é˜¶æ®µå­¦ä¹ æŠ¥å‘Š";
    }

    function buildQuery() {
      var params = new URLSearchParams();
      if (studentEl.value) params.set('student_id', studentEl.value);
      if (startEl.value) params.set('start', startEl.value);
      if (endEl.value) params.set('end', endEl.value);
      return params.toString();
    }

    function syncRegenerateLink() {
      if (!regenerateLink) return;
      var qs = buildQuery();
      regenerateLink.href = qs ? baseUrl + '?' + qs : baseUrl;
    }

    function maybeSyncTitle() {
      if (!titleEl || titleTouched) return;
      titleEl.value = buildTitle();
    }

    function refreshAnalysis() {
      var qs = buildQuery();
      window.location.href = qs ? baseUrl + '?' + qs : baseUrl;
    }

    if (titleEl) titleEl.addEventListener('input', function() { titleTouched = true; });

    function onFilterChange() { maybeSyncTitle(); syncRegenerateLink(); refreshAnalysis(); }

    studentEl.addEventListener('change', onFilterChange);
    startEl.addEventListener('change', onFilterChange);
    endEl.addEventListener('change', onFilterChange);
    maybeSyncTitle();
    syncRegenerateLink();
  })();
</script>
{% endblock %}
