{% extends "base.html" %}

{% block page_subtitle %}Stage Report{% endblock %}
{% block page_title %}阶段学习报告编辑{% endblock %}

{% block content_dashboard %}
<div class="stage-wrap">
  <form method="post" class="stage-form">
    <section class="card panel">
      <div class="panel-head">
        <h2>报告基础信息</h2>
      </div>
      <div class="field-grid">
        <div class="field field-title">
          <label for="title">报告标题</label>
          <input id="title" name="title" value="{{ title_value }}">
        </div>
        <div class="field">
          <label for="student_id">学生</label>
          <select id="student_id" name="student_id" required>
            {% for student in students %}
            <option value="{{ student.id }}" {% if selected_student and student.id == selected_student.id %}selected{% endif %}>
              {{ student.full_name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="field">
          <label for="start_date">阶段开始</label>
          <input id="start_date" type="date" name="start_date" value="{{ start_date.isoformat() if start_date else '' }}">
        </div>
        <div class="field">
          <label for="end_date">阶段结束</label>
          <input id="end_date" type="date" name="end_date" value="{{ end_date.isoformat() if end_date else '' }}">
        </div>
      </div>
      <div class="actions">
        <button type="submit" class="btn btn-primary">保存报告</button>
        {% if report %}
        <a class="btn btn-outline" href="{{ url_for('export_stage_report_pdf', report_id=report.id) }}" target="_blank">下载PDF</a>
        {% endif %}
        <a class="btn btn-outline" href="{{ url_for('stage_report_list') }}">返回列表</a>
        <a
          id="regenerateLink"
          class="btn btn-outline"
          href="{{ url_for('stage_report_create', student_id=selected_student.id if selected_student else '', start=start_date.isoformat() if start_date else '', end=end_date.isoformat() if end_date else '') }}"
        >重新生成分析</a>
      </div>
    </section>

    {% if stage_data %}
    <section class="card panel">
      <div class="panel-head">
        <h2>阶段概览</h2>
      </div>
      <div class="metrics">
        <div class="metric"><span>阶段任务</span><strong>{{ stage_data.total_items or 0 }}</strong></div>
        <div class="metric"><span>审核完成</span><strong>{{ stage_data.reviewed_items or 0 }} / {{ stage_data.total_items or 0 }}</strong></div>
        <div class="metric"><span>完成率</span><strong>{{ stage_data.stage_completion_rate or 0 }}%</strong></div>
        <div class="metric"><span>平均掌握度</span><strong>{{ stage_data.avg_mastery or 0 }}%</strong></div>
        <div class="metric"><span>计划时长</span><strong>{{ stage_data.planned_total or 0 }} 分</strong></div>
        <div class="metric"><span>实际时长</span><strong>{{ stage_data.actual_total or 0 }} 分</strong></div>
      </div>
      <div class="field">
        <label for="overall_comment">总体阶段评价</label>
        <textarea id="overall_comment" name="overall_comment" rows="3">{{ stage_data.overall_comment or '' }}</textarea>
      </div>
    </section>

    <section class="card panel">
      <div class="panel-head">
        <h2>各学科学习情况</h2>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>学科模块</th>
              <th>学习内容</th>
              <th>掌握度</th>
              <th>计划/实际</th>
              <th>审核率</th>
              <th>老师评价（可编辑）</th>
            </tr>
          </thead>
          <tbody>
            {% for row in stage_data.subject_rows or [] %}
            <tr>
              <td>{{ row.module }}</td>
              <td>{{ row.content_text }}</td>
              <td>{{ row.mastery_label }}（{{ row.mastery_score }}%）</td>
              <td>{{ row.planned_minutes }} / {{ row.actual_minutes }} 分</td>
              <td>{{ row.review_rate }}%</td>
              <td><input name="teacher_comment_{{ loop.index0 }}" value="{{ row.teacher_comment or '' }}"></td>
            </tr>
            {% else %}
            <tr>
              <td colspan="6" class="muted">暂无学科学习数据。</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <section class="card panel score-grid">
      <div>
        <div class="panel-head">
          <h2>{{ stage_data.score_scope_label or '分数记录' }}</h2>
        </div>
        <ul class="score-list">
          {% for score in stage_data.score_records or [] %}
          <li>
            <strong>{{ score.taken_on }} · {{ score.assessment_name }}</strong>
            <span>{% if score.total_score is not none %}总分 {{ score.total_score }}{% else %}未记录总分{% endif %}</span>
            {% if score.component_scores %}
            <div class="muted small">
              {% for key, value in score.component_scores.items() %}
              {{ key }}: {{ value }}{% if not loop.last %}；{% endif %}
              {% endfor %}
            </div>
            {% endif %}
          </li>
          {% else %}
          <li class="muted">暂无分数记录。</li>
          {% endfor %}
        </ul>
      </div>
      <div class="prediction-box">
        <h3>分数判断</h3>
        <p>最近分数：{% if stage_data.latest_score is not none %}{{ stage_data.latest_score }}{% else %}暂无{% endif %}</p>
        <p>预估下阶段分数：{% if stage_data.predicted_score is not none %}{{ stage_data.predicted_score }}{% else %}暂无{% endif %}</p>
        <p class="muted small">{{ stage_data.prediction_basis or '' }}</p>
      </div>
    </section>

    <section class="card panel text-grid">
      <div class="field">
        <label for="focus_points_text">下阶段学习重点（可编辑）</label>
        <textarea id="focus_points_text" name="focus_points_text" rows="7">{{ stage_data.focus_points_text or '' }}</textarea>
      </div>
      <div class="field">
        <label for="suggestions_text">下阶段学习建议（可编辑）</label>
        <textarea id="suggestions_text" name="suggestions_text" rows="7">{{ stage_data.suggestions_text or '' }}</textarea>
      </div>
    </section>
    {% else %}
    <section class="card panel muted">暂无可生成数据，请先补充学生和阶段信息。</section>
    {% endif %}
  </form>
</div>

<style>
  .stage-form {
    display: grid;
    gap: 14px;
  }
  .panel {
    padding: 14px;
  }
  .panel-head h2 {
    font-size: 22px;
    margin: 0 0 10px 0;
  }
  .field-grid {
    display: grid;
    gap: 10px;
    grid-template-columns: 2fr 1fr 1fr 1fr;
  }
  .field-title {
    min-width: 280px;
  }
  .field label {
    display: block;
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 6px;
  }
  input,
  select,
  textarea {
    width: 100%;
    border: 1px solid #dbe2ea;
    border-radius: 10px;
    padding: 9px 10px;
    background: #fff;
  }
  .actions {
    margin-top: 12px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  .btn-outline {
    border: 1px solid #c9d4df;
    background: #fff;
    color: #334155 !important;
  }
  .metrics {
    display: grid;
    grid-template-columns: repeat(6, minmax(120px, 1fr));
    gap: 10px;
    margin-bottom: 12px;
  }
  .metric {
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 10px;
    background: #fbfdff;
  }
  .metric span {
    font-size: 12px;
    color: #6b7280;
    display: block;
  }
  .metric strong {
    font-size: 20px;
    line-height: 1.2;
  }
  .table-wrap {
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th,
  td {
    border: 1px solid #e5e7eb;
    padding: 8px;
    text-align: left;
    vertical-align: top;
  }
  th {
    background: #f8fafc;
    font-size: 13px;
  }
  .score-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 12px;
  }
  .score-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 8px;
  }
  .score-list li {
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 10px;
    background: #fafcff;
  }
  .prediction-box {
    border: 1px dashed #cbd5e1;
    border-radius: 10px;
    padding: 10px;
    background: #f8fafc;
    align-self: start;
  }
  .prediction-box h3 {
    margin-top: 0;
    margin-bottom: 8px;
  }
  .text-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .muted {
    color: #6b7280;
  }
  .small {
    font-size: 12px;
  }
  @media (max-width: 1200px) {
    .field-grid {
      grid-template-columns: 1fr 1fr;
    }
    .metrics {
      grid-template-columns: repeat(3, minmax(120px, 1fr));
    }
  }
  @media (max-width: 960px) {
    .field-grid {
      grid-template-columns: 1fr;
    }
    .score-grid,
    .text-grid {
      grid-template-columns: 1fr;
    }
    .metrics {
      grid-template-columns: repeat(2, minmax(120px, 1fr));
    }
  }
</style>

<script>
  (function () {
    const isCreateMode = {{ 'true' if not report else 'false' }};
    if (!isCreateMode) return;

    const studentEl = document.getElementById('student_id');
    const startEl = document.getElementById('start_date');
    const endEl = document.getElementById('end_date');
    const titleEl = document.getElementById('title');
    const regenerateLink = document.getElementById('regenerateLink');
    if (!studentEl || !startEl || !endEl) return;

    const baseUrl = "{{ url_for('stage_report_create') }}";
    let titleTouched = false;

    function buildTitle() {
      const studentName = studentEl.options[studentEl.selectedIndex]?.text?.trim() || "";
      const start = startEl.value || "";
      const end = endEl.value || "";
      if (!studentName) return "阶段学习报告";
      if (start && end) return `${studentName} 阶段学习报告 (${start} 至 ${end})`;
      return `${studentName} 阶段学习报告`;
    }

    function buildQuery() {
      const params = new URLSearchParams();
      if (studentEl.value) params.set('student_id', studentEl.value);
      if (startEl.value) params.set('start', startEl.value);
      if (endEl.value) params.set('end', endEl.value);
      return params.toString();
    }

    function syncRegenerateLink() {
      if (!regenerateLink) return;
      const qs = buildQuery();
      regenerateLink.href = qs ? `${baseUrl}?${qs}` : baseUrl;
    }

    function maybeSyncTitle() {
      if (!titleEl) return;
      if (titleTouched) return;
      titleEl.value = buildTitle();
    }

    function refreshAnalysis() {
      const qs = buildQuery();
      window.location.href = qs ? `${baseUrl}?${qs}` : baseUrl;
    }

    if (titleEl) {
      titleEl.addEventListener('input', () => {
        titleTouched = true;
      });
    }

    function onFilterChange() {
      maybeSyncTitle();
      syncRegenerateLink();
      refreshAnalysis();
    }

    studentEl.addEventListener('change', onFilterChange);
    startEl.addEventListener('change', onFilterChange);
    endEl.addEventListener('change', onFilterChange);
    maybeSyncTitle();
    syncRegenerateLink();
  })();
</script>
{% endblock %}
