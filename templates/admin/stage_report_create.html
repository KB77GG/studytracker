{% extends "base.html" %}

{% block page_subtitle %}Stage Report{% endblock %}
{% block page_title %}é˜¶æ®µå­¦ä¹ æŠ¥å‘Šç¼–è¾‘{% endblock %}

{% block content_dashboard %}
<div class="stage-wrap">
  <form method="post" class="stage-form">
    <!-- â”€â”€ åŸºç¡€ä¿¡æ¯ â”€â”€ -->
    <section class="card panel">
      <div class="panel-head">
        <div class="panel-head-icon">ğŸ“‹</div>
        <div>
          <h2>æŠ¥å‘ŠåŸºç¡€ä¿¡æ¯</h2>
          <p class="panel-desc">é€‰æ‹©å­¦ç”Ÿå’Œé˜¶æ®µåŒºé—´ï¼Œç³»ç»Ÿè‡ªåŠ¨è®¡ç®—åˆ†ææ•°æ®</p>
        </div>
      </div>
      <div class="field-grid">
        <div class="field field-title">
          <label for="title">æŠ¥å‘Šæ ‡é¢˜</label>
          <input id="title" name="title" value="{{ title_value }}">
        </div>
        <div class="field">
          <label for="student_id">å­¦ç”Ÿ</label>
          <select id="student_id" name="student_id" required>
            {% for student in students %}
            <option value="{{ student.id }}" {% if selected_student and student.id == selected_student.id %}selected{% endif %}>
              {{ student.full_name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="field">
          <label for="start_date">é˜¶æ®µå¼€å§‹</label>
          <input id="start_date" type="date" name="start_date" value="{{ start_date.isoformat() if start_date else '' }}">
        </div>
        <div class="field">
          <label for="end_date">é˜¶æ®µç»“æŸ</label>
          <input id="end_date" type="date" name="end_date" value="{{ end_date.isoformat() if end_date else '' }}">
        </div>
      </div>
      <div class="actions">
        <button type="submit" class="btn btn-primary">ä¿å­˜æŠ¥å‘Š</button>
        {% if report %}
        <a class="btn btn-pdf" href="{{ url_for('export_stage_report_pdf', report_id=report.id) }}" target="_blank">ğŸ“„ ä¸‹è½½PDF</a>
        {% endif %}
        <a class="btn btn-outline" href="{{ url_for('stage_report_list') }}">è¿”å›åˆ—è¡¨</a>
        <a
          id="regenerateLink"
          class="btn btn-outline"
          href="{{ url_for('stage_report_create', student_id=selected_student.id if selected_student else '', start=start_date.isoformat() if start_date else '', end=end_date.isoformat() if end_date else '') }}"
        >ğŸ”„ é‡æ–°ç”Ÿæˆåˆ†æ</a>
      </div>
    </section>

    {% if stage_data %}
    <!-- â”€â”€ é˜¶æ®µæ¦‚è§ˆ â”€â”€ -->
    <section class="card panel">
      <div class="panel-head">
        <div class="panel-head-icon">ğŸ“Š</div>
        <h2>é˜¶æ®µæ¦‚è§ˆ</h2>
      </div>
      <div class="metrics">
        <div class="metric">
          <span>é˜¶æ®µä»»åŠ¡</span>
          <strong>{{ stage_data.total_items or 0 }}</strong>
        </div>
        <div class="metric">
          <span>å®¡æ ¸å®Œæˆ</span>
          <strong>{{ stage_data.reviewed_items or 0 }} / {{ stage_data.total_items or 0 }}</strong>
        </div>
        <div class="metric {{ 'metric-good' if (stage_data.stage_completion_rate or 0) >= 80 else ('metric-warn' if (stage_data.stage_completion_rate or 0) >= 50 else 'metric-low') }}">
          <span>å®Œæˆç‡</span>
          <strong>{{ stage_data.stage_completion_rate or 0 }}%</strong>
        </div>
        <div class="metric {{ 'metric-good' if (stage_data.avg_mastery or 0) >= 80 else ('metric-warn' if (stage_data.avg_mastery or 0) >= 50 else 'metric-low') }}">
          <span>å¹³å‡æŒæ¡åº¦</span>
          <strong>{{ stage_data.avg_mastery or 0 }}%</strong>
        </div>
        <div class="metric">
          <span>è®¡åˆ’æ—¶é•¿</span>
          <strong>{{ stage_data.planned_total or 0 }} åˆ†</strong>
        </div>
        <div class="metric">
          <span>å®é™…æ—¶é•¿</span>
          <strong>{{ stage_data.actual_total or 0 }} åˆ†</strong>
        </div>
      </div>
      <div class="field">
        <label for="overall_comment">æ€»ä½“é˜¶æ®µè¯„ä»·</label>
        <textarea id="overall_comment" name="overall_comment" rows="3">{{ stage_data.overall_comment or '' }}</textarea>
      </div>
    </section>

    <!-- â”€â”€ å„å­¦ç§‘å­¦ä¹ æƒ…å†µ â”€â”€ -->
    <section class="card panel">
      <div class="panel-head">
        <div class="panel-head-icon">ğŸ“š</div>
        <h2>å„å­¦ç§‘å­¦ä¹ æƒ…å†µ</h2>
      </div>
      <div class="table-wrap">
        <table class="branded-table">
          <thead>
            <tr>
              <th>å­¦ç§‘æ¨¡å—</th>
              <th>å­¦ä¹ å†…å®¹</th>
              <th>æŒæ¡åº¦</th>
              <th>è®¡åˆ’/å®é™…</th>
              <th>å®¡æ ¸ç‡</th>
              <th>è€å¸ˆè¯„ä»·ï¼ˆå¯ç¼–è¾‘ï¼‰</th>
            </tr>
          </thead>
          <tbody>
            {% for row in stage_data.subject_rows or [] %}
            <tr>
              <td class="subject-cell">{{ row.module }}</td>
              <td>{{ row.content_text }}</td>
              <td>
                <span class="mastery-badge {{ 'badge-good' if row.mastery_score >= 80 else ('badge-warn' if row.mastery_score >= 50 else 'badge-low') }}">
                  {{ row.mastery_label }}ï¼ˆ{{ row.mastery_score }}%ï¼‰
                </span>
              </td>
              <td>{{ row.planned_minutes }} / {{ row.actual_minutes }} åˆ†</td>
              <td>{{ row.review_rate }}%</td>
              <td><input name="teacher_comment_{{ loop.index0 }}" value="{{ row.teacher_comment or '' }}"></td>
            </tr>
            {% else %}
            <tr>
              <td colspan="6" class="muted" style="text-align:center;">æš‚æ— å­¦ç§‘å­¦ä¹ æ•°æ®ã€‚</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- â”€â”€ å¬è¯´è¯»å†™ä¸Šè¯¾æƒ…å†µ â”€â”€ -->
    <section class="card panel">
      <div class="panel-head">
        <div class="panel-head-icon">ğŸ“</div>
        <h2>å¬è¯´è¯»å†™ä¸Šè¯¾æƒ…å†µæ€»ç»“ï¼ˆæ•™å¸ˆå¡«å†™ï¼‰</h2>
      </div>
      <div class="skill-grid">
        {% for row in stage_data.class_summary_rows or [] %}
        <div class="skill-card">
          <div class="skill-label">{{ row.subject }}</div>
          <textarea name="class_summary_{{ loop.index0 }}" rows="4" placeholder="è¯·å¡«å†™{{ row.subject }}ä¸Šè¯¾å†…å®¹ã€è¯¾å ‚è¡¨ç°ã€é—®é¢˜ä¸æ”¹è¿›è®¡åˆ’...">{{ row.summary or '' }}</textarea>
        </div>
        {% endfor %}
      </div>
    </section>

    <!-- â”€â”€ æ¨¡è€ƒç‚¹è¯„ â”€â”€ -->
    <section class="card panel panel-accent-amber">
      <div class="panel-head">
        <div class="panel-head-icon">ğŸ¯</div>
        <h2>æ¨¡è€ƒç‚¹è¯„ï¼ˆè‡ªç”±ç¼–è¾‘ï¼‰</h2>
      </div>
      <div class="field">
        <textarea
          id="mock_exam_review_text"
          name="mock_exam_review_text"
          rows="6"
          placeholder="è¯·å¡«å†™æœ¬é˜¶æ®µæ¨¡è€ƒè¡¨ç°ã€åˆ†é¡¹é—®é¢˜ã€æåˆ†ç­–ç•¥å’Œä¸‹é˜¶æ®µæ¨¡è€ƒå®‰æ’..."
        >{{ stage_data.mock_exam_review_text or '' }}</textarea>
      </div>
    </section>

    <!-- â”€â”€ é‡ç‚¹ä¸å»ºè®® â”€â”€ -->
    <section class="card panel text-grid">
      <div class="text-col text-col-focus">
        <div class="text-col-head">ğŸ”‘ ä¸‹é˜¶æ®µå­¦ä¹ é‡ç‚¹</div>
        <textarea id="focus_points_text" name="focus_points_text" rows="7">{{ stage_data.focus_points_text or '' }}</textarea>
      </div>
      <div class="text-col text-col-suggest">
        <div class="text-col-head">ğŸ’¡ ä¸‹é˜¶æ®µå­¦ä¹ å»ºè®®</div>
        <textarea id="suggestions_text" name="suggestions_text" rows="7">{{ stage_data.suggestions_text or '' }}</textarea>
      </div>
    </section>
    {% else %}
    <section class="card panel muted" style="text-align:center;padding:40px;">æš‚æ— å¯ç”Ÿæˆæ•°æ®ï¼Œè¯·å…ˆè¡¥å……å­¦ç”Ÿå’Œé˜¶æ®µä¿¡æ¯ã€‚</section>
    {% endif %}
  </form>
</div>

<style>
  .stage-wrap {
    max-width: 1200px;
  }
  .stage-form {
    display: grid;
    gap: 16px;
  }
  .panel {
    padding: 18px 20px;
    border-radius: 14px;
  }

  /* â”€â”€ Panel heads â”€â”€ */
  .panel-head {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 14px;
  }
  .panel-head-icon {
    font-size: 22px;
    line-height: 1;
  }
  .panel-head h2 {
    font-size: 20px;
    margin: 0;
    color: #0f766e;
  }
  .panel-desc {
    margin: 2px 0 0 0;
    font-size: 13px;
    color: #6b7280;
  }

  /* â”€â”€ Accent borders â”€â”€ */
  .panel-accent-amber {
    border-left: 4px solid #d97706;
  }

  /* â”€â”€ Field grid â”€â”€ */
  .field-grid {
    display: grid;
    gap: 12px;
    grid-template-columns: 2fr 1fr 1fr 1fr;
  }
  .field-title {
    min-width: 280px;
  }
  .field label {
    display: block;
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 6px;
    font-weight: 600;
  }
  input,
  select,
  textarea {
    width: 100%;
    border: 1px solid #dbe2ea;
    border-radius: 10px;
    padding: 9px 12px;
    background: #fff;
    font-size: 14px;
    transition: border-color 0.15s, box-shadow 0.15s;
    box-sizing: border-box;
  }
  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: #0f766e;
    box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
  }

  /* â”€â”€ Actions â”€â”€ */
  .actions {
    margin-top: 14px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  .btn-outline {
    border: 1px solid #c9d4df;
    background: #fff;
    color: #334155 !important;
  }
  .btn-outline:hover {
    background: #f8fafc;
    border-color: #94a3b8;
  }
  .btn-pdf {
    border: 1px solid #0f766e;
    background: #f0fdfa;
    color: #0f766e !important;
    font-weight: 600;
  }
  .btn-pdf:hover {
    background: #ccfbf1;
  }

  /* â”€â”€ Metrics â”€â”€ */
  .metrics {
    display: grid;
    grid-template-columns: repeat(6, minmax(120px, 1fr));
    gap: 10px;
    margin-bottom: 14px;
  }
  .metric {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 12px;
    background: #fbfdff;
    border-top: 3px solid #e5e7eb;
    transition: transform 0.15s;
  }
  .metric:hover {
    transform: translateY(-1px);
  }
  .metric span {
    font-size: 12px;
    color: #6b7280;
    display: block;
    margin-bottom: 2px;
  }
  .metric strong {
    font-size: 22px;
    line-height: 1.2;
    color: #1f2937;
  }
  .metric-good {
    border-top-color: #10b981;
    background: #f0fdf4;
  }
  .metric-good strong { color: #059669; }
  .metric-warn {
    border-top-color: #f59e0b;
    background: #fffbeb;
  }
  .metric-warn strong { color: #d97706; }
  .metric-low {
    border-top-color: #ef4444;
    background: #fef2f2;
  }
  .metric-low strong { color: #dc2626; }

  /* â”€â”€ Tables â”€â”€ */
  .table-wrap {
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  .branded-table th {
    background: #0f766e;
    color: #fff;
    font-size: 13px;
    font-weight: 600;
    padding: 10px 8px;
    border: none;
    border-bottom: 2px solid #0d6962;
  }
  .branded-table td {
    border: none;
    border-bottom: 1px solid #e5e7eb;
    padding: 10px 8px;
    vertical-align: middle;
    font-size: 14px;
  }
  .branded-table tbody tr:hover {
    background: #f0fdfa;
  }
  .branded-table tbody tr:nth-child(even) {
    background: #f8fcfb;
  }
  .branded-table tbody tr:nth-child(even):hover {
    background: #ecfdf5;
  }
  .subject-cell {
    font-weight: 600;
    color: #0f766e;
  }

  /* â”€â”€ Mastery badges â”€â”€ */
  .mastery-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
  }
  .badge-good { background: #dcfce7; color: #166534; }
  .badge-warn { background: #fef3c7; color: #92400e; }
  .badge-low  { background: #fee2e2; color: #991b1b; }

  /* â”€â”€ Skill cards â”€â”€ */
  .skill-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .skill-card {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 14px;
    background: #fafcfb;
  }
  .skill-label {
    font-size: 14px;
    font-weight: 700;
    color: #0f766e;
    margin-bottom: 8px;
    padding-bottom: 6px;
    border-bottom: 1px dashed #d1d5db;
  }
  .skill-card textarea {
    border-color: #e5e7eb;
    background: #fff;
    border-radius: 8px;
  }

  /* â”€â”€ Text grid (focus + suggestions) â”€â”€ */
  .text-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }
  .text-col {
    border-radius: 12px;
    padding: 14px;
  }
  .text-col-focus {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
  }
  .text-col-suggest {
    background: #eff6ff;
    border: 1px solid #bfdbfe;
  }
  .text-col-head {
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 10px;
  }
  .text-col-focus .text-col-head { color: #0f766e; }
  .text-col-suggest .text-col-head { color: #2563eb; }
  .text-col textarea {
    background: #fff;
    border-radius: 8px;
  }

  .muted {
    color: #6b7280;
  }

  /* â”€â”€ Responsive â”€â”€ */
  @media (max-width: 1200px) {
    .field-grid {
      grid-template-columns: 1fr 1fr;
    }
    .metrics {
      grid-template-columns: repeat(3, minmax(120px, 1fr));
    }
  }
  @media (max-width: 960px) {
    .field-grid {
      grid-template-columns: 1fr;
    }
    .text-grid, .skill-grid {
      grid-template-columns: 1fr;
    }
    .metrics {
      grid-template-columns: repeat(2, minmax(120px, 1fr));
    }
  }
</style>

<script>
  (function () {
    const isCreateMode = {{ 'true' if not report else 'false' }};
    if (!isCreateMode) return;

    const studentEl = document.getElementById('student_id');
    const startEl = document.getElementById('start_date');
    const endEl = document.getElementById('end_date');
    const titleEl = document.getElementById('title');
    const regenerateLink = document.getElementById('regenerateLink');
    if (!studentEl || !startEl || !endEl) return;

    const baseUrl = "{{ url_for('stage_report_create') }}";
    let titleTouched = false;

    function buildTitle() {
      const studentName = studentEl.options[studentEl.selectedIndex]?.text?.trim() || "";
      const start = startEl.value || "";
      const end = endEl.value || "";
      if (!studentName) return "é˜¶æ®µå­¦ä¹ æŠ¥å‘Š";
      if (start && end) return `${studentName} é˜¶æ®µå­¦ä¹ æŠ¥å‘Š (${start} è‡³ ${end})`;
      return `${studentName} é˜¶æ®µå­¦ä¹ æŠ¥å‘Š`;
    }

    function buildQuery() {
      const params = new URLSearchParams();
      if (studentEl.value) params.set('student_id', studentEl.value);
      if (startEl.value) params.set('start', startEl.value);
      if (endEl.value) params.set('end', endEl.value);
      return params.toString();
    }

    function syncRegenerateLink() {
      if (!regenerateLink) return;
      const qs = buildQuery();
      regenerateLink.href = qs ? `${baseUrl}?${qs}` : baseUrl;
    }

    function maybeSyncTitle() {
      if (!titleEl) return;
      if (titleTouched) return;
      titleEl.value = buildTitle();
    }

    function refreshAnalysis() {
      const qs = buildQuery();
      window.location.href = qs ? `${baseUrl}?${qs}` : baseUrl;
    }

    if (titleEl) {
      titleEl.addEventListener('input', () => {
        titleTouched = true;
      });
    }

    function onFilterChange() {
      maybeSyncTitle();
      syncRegenerateLink();
      refreshAnalysis();
    }

    studentEl.addEventListener('change', onFilterChange);
    startEl.addEventListener('change', onFilterChange);
    endEl.addEventListener('change', onFilterChange);
    maybeSyncTitle();
    syncRegenerateLink();
  })();
</script>
{% endblock %}
