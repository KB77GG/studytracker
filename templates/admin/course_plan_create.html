{% extends "base.html" %}

{% block content_dashboard %}
<!-- Tailwind CSS for this page only -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    brand: {
                        50: '#f0fdfa',
                        100: '#ccfbf1',
                        200: '#99f6e4',
                        300: '#5eead4',
                        400: '#2dd4bf',
                        500: '#14b8a6',
                        600: '#0d9488',
                        700: '#0f766e',
                        800: '#115e59',
                        900: '#134e4a',
                    }
                }
            }
        }
    }
</script>

<!-- React & Babel -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<div id="root" class="min-h-screen bg-slate-50 pb-20"></div>

<script type="text/babel">
    const { useState, useEffect } = React;

    // --- ICONS (Mocking Lucide) ---
    const IconWrapper = ({ children, className }) => (
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24" height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
            className={className}
        >
            {children}
        </svg>
    );

    const Plus = ({ className }) => <IconWrapper className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconWrapper>;
    const Trash2 = ({ className }) => <IconWrapper className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconWrapper>;
    const Wand2 = ({ className }) => <IconWrapper className={className}><path d="m19 2 2 2-2 2-2-2 2-2Z"></path><path d="m5 2 2 2-2 2-2-2 2-2Z"></path><path d="m15 11 2 2-2 2-2-2 2-2Z"></path><path d="m19 15 2 2-2 2-2-2 2-2Z"></path><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 12Z"></path><path d="M21 12v9"></path></IconWrapper>;
    const BookOpen = ({ className }) => <IconWrapper className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></IconWrapper>;
    const Calculator = ({ className }) => <IconWrapper className={className}><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><path d="M16 10h.01"></path><path d="M12 10h.01"></path><path d="M8 10h.01"></path><path d="M12 14h.01"></path><path d="M8 14h.01"></path><path d="M12 18h.01"></path><path d="M8 18h.01"></path></IconWrapper>;
    const Sprout = ({ className }) => <IconWrapper className={className}><path d="M7 20h10"></path><path d="M10 20c5.5-2.5.8-6.4 3-10"></path><path d="M9.5 9.4c1.1.8 1.8 2.2 2.3 3.7-2 .4-3.5.4-4.8-.3-1.2-.6-2.3-1.9-3-4.2 2.8-.5 4.4 0 5.5.8z"></path><path d="M14.1 6a7 7 0 0 0-1.1 4c1.9-.1 3.3-.6 4.3-1.4 1-1 1.6-2.3 1.7-4.6-2.7.1-4 1-4.9 2z"></path></IconWrapper>;
    const ChevronDown = ({ className }) => <IconWrapper className={className}><polyline points="6 9 12 15 18 9"></polyline></IconWrapper>;
    const ListChecks = ({ className }) => <IconWrapper className={className}><line x1="10" y1="6" x2="21" y2="6"></line><line x1="10" y1="12" x2="21" y2="12"></line><line x1="10" y1="18" x2="21" y2="18"></line><polyline points="3 6 4 7 6 5"></polyline><polyline points="3 12 4 13 6 11"></polyline><polyline points="3 18 4 19 6 17"></polyline></IconWrapper>;


    // --- CONSTANTS & DATA HELPERS ---
    const EXAM_TYPES = [
        { value: "IELTS", label: "ÈõÖÊÄù IELTS" },
        { value: "TOEFL", label: "ÊâòÁ¶è TOEFL" },
    ];

    const EXAM_LABELS = {
        IELTS: "ÈõÖÊÄù",
        TOEFL: "ÊâòÁ¶è",
    };

    const SCORE_OPTIONS = {
        IELTS: ["4.0", "4.5", "5.0", "5.5", "6.0", "6.5", "7.0", "7.5", "8.0", "8.5", "9.0"],
        TOEFL: ["60", "65", "70", "75", "80", "85", "90", "95", "100", "105", "110", "115", "120"],
    };

    const SUB_SCORE_OPTIONS = {
        IELTS: ["4.0", "4.5", "5.0", "5.5", "6.0", "6.5", "7.0", "7.5", "8.0", "8.5", "9.0"],
        TOEFL: ["15", "18", "20", "22", "24", "26", "28", "30"],
    };

    const SUBJECT_OPTIONS = {
        IELTS: ["ÈõÖÊÄùÂê¨Âäõ", "ÈõÖÊÄùÈòÖËØª", "ÈõÖÊÄùÂÜô‰Ωú", "ÈõÖÊÄùÂè£ËØ≠"],
        TOEFL: ["ÊâòÁ¶èÂê¨Âäõ", "ÊâòÁ¶èÈòÖËØª", "ÊâòÁ¶èÂÜô‰Ωú", "ÊâòÁ¶èÂè£ËØ≠"],
    };

    const getNext24Months = () => {
        const dates = [];
        const today = new Date();
        for (let i = 0; i < 24; i++) {
            const d = new Date(today.getFullYear(), today.getMonth() + i, 1);
            dates.push(`${d.getFullYear()}Âπ¥${d.getMonth() + 1}Êúà`);
        }
        return dates;
    };

    const EXAM_DATES = getNext24Months();

    const FOCUS_PRESETS = {
        IELTS: {
            "Âü∫Á°ÄÂ§ØÂÆû (5.5ÂàÜÁõÆÊ†á)": {
                L: "Section 1/2 Âú∫ÊôØËØçÊ±áÂê¨ÂÜôÔºåÂü∫Á°ÄÂÆö‰ΩçÊäÄÂ∑ßÔºåÊï∞Â≠ó/ÊãºÂÜô‰∏ìÈ°πËÆ≠ÁªÉ",
                R: "Âü∫Á°ÄËØ≠Ê≥ïÈïøÈöæÂè•ÂàÜÊûêÔºåÈ¢òÂûãÊâ´Áõ≤ÔºåÂ°´Á©∫È¢ò/Âà§Êñ≠È¢òËß£È¢òÊäÄÂ∑ß",
                W: "Â∞è‰ΩúÊñáÊï∞ÊçÆË°®ËææÁßØÁ¥ØÔºåÂ§ß‰ΩúÊñáÂü∫Á°ÄÂè•Âûã‰∏éÈÄªËæëÊ°ÜÊû∂Êê≠Âª∫",
                S: "Part 1 ËØùÈ¢òÁ¥†ÊùêÁßØÁ¥ØÔºåÂèëÈü≥Á∫†Ê≠£ÔºåÊµÅÂà©Â∫¶Âü∫Á°ÄËÆ≠ÁªÉ"
            },
            "Âº∫ÂåñÂÜ≤Âà∫ (6.5ÂàÜÁõÆÊ†á)": {
                L: "Section 3/4 ÈÄâÊã©È¢ò/ÈÖçÂØπÈ¢òÊäÄÂ∑ßÔºåÂêå‰πâÊõøÊç¢ÁßØÁ¥ØÔºåÂÄçÈÄüÂê¨Èü≥ËÆ≠ÁªÉ",
                R: "ÊÆµËêΩ‰∏ªÊó®È¢ò/HeadingÈ¢òÊîªÂÖãÔºåÂπ≥Ë°åÈòÖËØªÊ≥ïËÆ≠ÁªÉÔºåÈïøÊñáÂø´ÈÄüÂÆö‰Ωç",
                W: "Â§ß‰ΩúÊñáÂÆ°È¢ò‰∏éËÆ∫ÁÇπÊâ©Â±ïÔºåÈ´òÂàÜËØçÊ±áÊõøÊç¢ÔºåÈÄªËæëËøûÊé•ËØçËøêÁî®",
                S: "Part 2 ‰∏≤È¢òÊäÄÂ∑ßÔºåPart 3 ÊäΩË±°ËØùÈ¢òÊÄùÁª¥ÊãìÂ±ïÔºåÂú∞ÈÅì‰π†ËØ≠‰ΩøÁî®"
            },
            "È´òÂàÜÁ™ÅÁ†¥ (7.0+ÁõÆÊ†á)": {
                L: "ÂÖ®ÁúüÊ®°ËÄÉÊäóÂπ≤Êâ∞ËÆ≠ÁªÉÔºåÁ≤æÂê¨Ë∑üËØªÔºåÂº±ËØª/ËøûËØªËØ≠Èü≥Áé∞Ë±°ÊîªÂÖã",
                R: "ÈôêÊó∂Ê®°ËÄÉËÆ≠ÁªÉÔºåÈîôÈ¢òÊ∑±Â∫¶ÂΩíÂõ†ÔºåÂ≠¶ÊúØÁ±ªÊñáÁ´†ÁªìÊûÑÊãÜËß£",
                W: "ÂêÑÁ±ªËØùÈ¢òËåÉÊñáÁ≤æÊûêÔºåÊâπÂà§ÊÄßÊÄùÁª¥ËÆ≠ÁªÉÔºåÊñáÁ´†ËøûË¥ØÊÄß‰∏é‰∏ÄËá¥ÊÄßÊèêÂçá",
                S: "ÂÖ®ÁúüÊ®°ÊãüÈù¢ËØïÔºåÈ´òÈöæÂ∫¶ËØùÈ¢òÂç≥ÂÖ¥Ë°®ËææÔºåÂ§çÊùÇËØ≠Ê≥ïÁªìÊûÑÁÅµÊ¥ªËøêÁî®"
            }
        },
        TOEFL: {
            "Âü∫Á°ÄÊïëÁîüÂúà (Foundation & Survival)": {
                L: "Âê¨Èü≥Ëæ®‰πâÔºöÈ´ò‰∏≠3500+ÊâòÁ¶èÂê¨ÂäõÈ´òÈ¢ëËØçÔºåÊØèÊó•100ËØçÔºåÊ≠£Á°ÆÁéá>90%ÔºõÂçïËØçÂê¨ÂÜôÊØèÊó•30-50ËØçÔºõÁõ≤Âê¨Á£®ËÄ≥ÔºöTPO Conversation ÊØèÊó•2-3ÁØáÔºå30ÁßíËØ≠Èü≥Ê¶ÇÊã¨„ÄÇ",
                R: "ÈïøÈöæÂè•ÊãÜËß£ÔºöÊØèÊó•3-5Âè•ÔºåÂè™Âúà‰∏ªË∞ìÂÆæÔºåËß£ÂÜ≥‚ÄúÁúã‰∏çÊáÇ‚Äù„ÄÇ",
                W: "Ê®°ÊùøËÇåËÇâËÆ∞ÂøÜÔºöÁªºÂêà/Áã¨Á´ãÊ®°ÊùøÊØèÊó•ÈôêÊó∂Êï≤1ÈÅçÔºà‚â§3ÂàÜÈíüÔºâ„ÄÇ",
                S: "ÂéüÈü≥Ë∑üËØªÔºöTPO Task1/2 ÊñáÊú¨Ê®°‰ªøËØ≠Èü≥ËØ≠Ë∞ÉÔºåÊØèÊó•10-15ÂàÜÈíüÂΩïÈü≥„ÄÇ"
            },
            "ËøõÈò∂Âº∫Âåñ (Development & Logic)": {
                L: "Âè•Â≠êÂê¨ÂÜôÔºöTPO Lecture ÊØèÊó•3-5Âè•ÔºåÊ£ÄÊü•‰ªãËØç/ÂÜ†ËØç/Êó∂ÊÄÅÔºõ‰ø°Âè∑ËØçÊçïÊçâÔºöÊØèÊó•1ÁØáËÆ∞ÂΩïÊèêÁ§∫ËØç+Ê†∏ÂøÉÂêçËØç„ÄÇ",
                R: "ÊÆµËêΩÊÄªÁªìÔºöÊØèÊó•2ÊÆµ TPO ÊñáÁ´†ÔºåÁî®‰∏≠Êñá‰∏ÄÂè•ËØùÊ¶ÇÊã¨ÊéíÈô§ÁªÜËäÇÂπ≤Êâ∞„ÄÇ",
                W: "ËØ≠ÊñôÈÄ†Âè•ÔºöÈ´òÁ∫ßÁü≠ËØ≠/Âè•ÂûãÊØèÊó•3Âè•ÔºåËûçÂÖ•ÂΩìÂ§©ÂÜô‰ΩúËØùÈ¢ò„ÄÇ",
                S: "ÂÖ≥ÈîÆËØçÂ§çËø∞ÔºöTPO Task2/3/4 ÊØèÊó•1È¢òÔºåÁúãÁ¨îËÆ∞ÂÅö60ÁßíÂ§çËø∞ÔºåË¶ÜÁõñË¶ÅÁÇπ„ÄÇ"
            },
            "È´òÂàÜÂÜ≤Âà∫ (Advanced & Polishing)": {
                L: "ÂÄçÈÄüËôêËÄ≥ÔºöTPO Lecture 1.2x-1.25x ÊØèÊó•1ÁØáÔºåÂÅöÈ¢òÊàñÂ§çËø∞ÔºåÊ†áËÆ∞ÈîôÈ¢òÂéüÂõ†„ÄÇ",
                R: "ÈôêÊó∂Âà∑È¢òÔºö18ÂàÜÈíüÂÆåÊàê‰∏ÄÁØáÈòÖËØªÔºåÈöîÊó•1ÁØáÔºå‰∏ªÊîªÂÆö‰Ωç‰∏éÊäóÂπ≤Êâ∞„ÄÇ",
                W: "ÊÆµËêΩÊîπÂÜôÔºöÊØèÂë®2Ê¨°ÔºåÁî®Âú∞ÈÅìË°®ËææÂíåÂ§öÊ†∑Âè•ÂºèÂçáÁ∫ßÊóßÁ®øÔºå‰º¥ÈöèÈîôÈ¢òÂΩíÂõ†„ÄÇ",
                S: "One Take ÊåëÊàòÔºöÊØèÊó•Task1ÈöèÊú∫È¢òÔºå‰∏ÄÊ¨°ÂΩïÈü≥45ÁßíÔºåÈÄºÁúüËÄÉËØïÂéãÂäõ„ÄÇ"
            }
        }
    };

    const MATERIAL_PRESETS = {
        IELTS: {
            "Ê†áÂáÜÂ•óÈ§ê": `„ÄäÁùøÁÑ∂ËØ≠Ê≥ïËÆ≠ÁªÉ„ÄãÂ§ØÂÆûËØ≠Ê≥ïÂü∫Á°ÄÔºåÂ¢ûÂä†ËØ≠Ê≥ïÁü•ËØÜÁÇπÁÜüÊÇâÁ®ãÂ∫¶ÂíåËøêÁî®ËÉΩÂäõ
„ÄäÁùøÁÑ∂Âè£ËØ≠ÊùêÊñôÊúóËØªËÆ≠ÁªÉ„ÄãÁÜüÊÇâÂü∫Êú¨Ë°®ËææÔºåÊèêÂçáËØ≠Ë®ÄÊµÅÂà©Á®ãÂ∫¶
„ÄäÁùøÁÑ∂ÂÜô‰ΩúÈÄªËæëÈìæËÆ≠ÁªÉ„ÄãÂ¢ûÂä†Â§ß‰ΩúÊñáÊ°ÜÊû∂ÁÜüÊÇâÂ∫¶ÔºåÂª∫Á´ãÊÄùÁª¥ÈÄªËæë‰π†ÊÉØ
Âü∫Á°ÄËØçÊ±áËÉåËØµÔºå‰∏ÄÂØπ‰∏ÄÂê¨ÂÜô
Âê¨ÂäõÂ≠¶ÁßëËØçÊ±áËÉåËØµÔºå‰∏ÄÂØπ‰∏ÄÂê¨ÂÜôÔºåÂä†Âº∫ÂçïËØçÂèëÈü≥ÁÜüÊÇâÁ®ãÂ∫¶ÔºåÂª∫Á´ãÈü≥ÂΩ¢ÂØπÁÖßÂÖ≥Á≥ª
„ÄäÁùøÁÑ∂Âè£ËØ≠È¢òÂ∫ì„Äã‰∏ÄÂØπ‰∏ÄÂØπÁªÉÔºåÊ®°ÊãüËÄÉËØïÂú∫ÊôØÔºåÂ¢ûÂä†ËÄÉËØïÁÜüÊÇâÁ®ãÂ∫¶`,
            "ÈòÖËØª‰∏ìÈ°π": "„ÄäÁùøÁÑ∂ÈõÖÊÄùÈòÖËØªÈïøÈöæÂè•Á≤æËÆ≤„Äã\n„ÄäÂâëÊ°•ÈõÖÊÄùÁúüÈ¢òÈòÖËØªÂàÜÂÜå„Äã\n„Ää‰πùÂàÜËææ‰∫∫ÈòÖËØª„Äã",
            "Âè£ËØ≠‰∏ìÈ°π": "„ÄäÁùøÁÑ∂ÈõÖÊÄùÂè£ËØ≠È¢òÂ∫ì„Äã\n„ÄäÁùøÁÑ∂ÈõÖÊÄùÂè£ËØ≠Á¥†ÊùêÊúóËØª„Äã\n‰∏ÄÂØπ‰∏ÄÂè£ËØ≠ÂØπÁªÉ",
            "ÂÜô‰Ωú‰∏ìÈ°π": "„ÄäÁùøÁÑ∂ÈõÖÊÄùÂÜô‰ΩúÈÄªËæëÁêèËÆ≠ÁªÉ„Äã\n„ÄäÁùøÁÑ∂ÈõÖÊÄùÂÜô‰ΩúÈ¢òÂ∫ìÁ¥†ÊùêÁßØÁ¥Ø„Äã\n„ÄäÁùøÁÑ∂ÈõÖÊÄùÂÜô‰ΩúÁøªËØëÁªÉ‰π†„Äã"
        },
        TOEFL: {
            "Âü∫Á°ÄÊïëÁîüÂúà (Foundation & Survival)": `ËØçÊ±áÔºöÂê¨Èü≥Ëæ®‰πâÔºàÈ´ò‰∏≠3500+ÊâòÁ¶èÂê¨ÂäõÈ´òÈ¢ëÔºâÊØèÊó•100ËØçÔºåÊ≠£Á°ÆÁéá>90%ÊâçÁÆóÊâìÂç°„ÄÇ
Âê¨ÂäõÔºöÂçïËØçÂê¨ÂÜôÊØèÊó•30-50ËØçÔºåÈîôËØçÁΩöÊäÑ/ÈáçÂê¨ÔºõÁõ≤Âê¨Á£®ËÄ≥ÔºöTPO Conversation ÊØèÊó•2-3ÁØáÔºåÊèê‰∫§30ÁßíËØ≠Èü≥Ê¶ÇÊã¨„ÄÇ
ÈòÖËØªÔºöÈïøÈöæÂè•ÊãÜËß£ÊØèÊó•3-5Âè•ÔºåÂè™Âúà‰∏ªË∞ìÂÆæÂπ∂Êà™Âõæ„ÄÇ
Âè£ËØ≠ÔºöÂéüÈü≥Ë∑üËØª TPO Task1/2 ÊØèÊó•10-15ÂàÜÈíüÂΩïÈü≥ÔºåÂÖ≥Ê≥®ÊµÅÂà©Â∫¶„ÄÇ
ÂÜô‰ΩúÔºöÊ®°ÊùøËÇåËÇâËÆ∞ÂøÜÁªºÂêàÊàñÁã¨Á´ãÊ®°ÊùøÊØèÊó•ÈôêÊó∂Êï≤1ÈÅçÔºà‚â§3ÂàÜÈíüÔºâÔºåÊà™ÂõæÊâìÂç°„ÄÇ`,
            "ËøõÈò∂Âº∫Âåñ (Development & Logic)": `ËØçÊ±áÔºöÂêå‰πâËØçÈÖçÂØπÊØèÊó•5ÁªÑÔºåÁªÉÊõøÊç¢Ë°®Ëææ„ÄÇ
Âê¨ÂäõÔºöÂè•Â≠êÂê¨ÂÜô TPO Lecture ÊØèÊó•3-5Âè•ÔºàÁïôÊÑè‰ªãËØç/ÂÜ†ËØç/Êó∂ÊÄÅÔºâÔºõ‰ø°Âè∑ËØçÊçïÊçâÊØèÊó•1ÁØáÔºåËÆ∞ÂΩïÊèêÁ§∫ËØçÂèäÊ†∏ÂøÉÂêçËØç„ÄÇ
ÈòÖËØªÔºöÊÆµËêΩÊÄªÁªìÊØèÊó•2ÊÆµÔºåÁî®‰∏≠Êñá‰∏ÄÂè•ËØùÊ¶ÇÊã¨ÊéíÈô§ÁªÜËäÇÂπ≤Êâ∞„ÄÇ
Âè£ËØ≠ÔºöÂÖ≥ÈîÆËØçÂ§çËø∞ TPO Task2/3/4 ÊØèÊó•1È¢òÔºåÊåâÁ¨îËÆ∞Â§çËø∞60ÁßíÂΩïÈü≥„ÄÇ
ÂÜô‰ΩúÔºöËØ≠ÊñôÈÄ†Âè•ÊØèÊó•3Âè•Ôºå‰ΩøÁî®ÂΩìÊó•È´òÁ∫ßÁü≠ËØ≠/Âè•ÂûãÔºåËÄÅÂ∏àÁÇπËØÑËØ≠Ê≥ï„ÄÇ`,
            "È´òÂàÜÂÜ≤Âà∫ (Advanced & Polishing)": `Âê¨ÂäõÔºöÂÄçÈÄüËôêËÄ≥ TPO Lecture ÊØèÊó•1ÁØáÔºà1.2x-1.25xÔºâÔºåÂÅöÈ¢òÊàñÂ§çËø∞Âπ∂Êèê‰∫§Ê≠£Á°ÆÁéáÊà™Âõæ„ÄÇ
ÈòÖËØªÔºöÈôêÊó∂Âà∑È¢òÈöîÊó•1ÁØáÔºå18ÂàÜÈíüÂÆåÊàêÔºåË∂ÖÊó∂Âç≥Â§±Ë¥•„ÄÇ
Âè£ËØ≠ÔºöOne TakeÊåëÊàòÊØèÊó•1È¢òÔºå‰ªÖ‰∏ÄÊ¨°ÂΩïÈü≥Êú∫‰ºöÔºåËØ¥Êª°45Áßí„ÄÇ
ÂÜô‰ΩúÔºöÊÆµËêΩÊîπÂÜôÊØèÂë®2Ê¨°ÔºåÁî®Âú∞ÈÅìËØçÊ±áÂíåÂ§öÊ†∑Âè•ÂºèÂçáÁ∫ßÊóßÁ®øÔºå‰∏ä‰º†ÂâçÂêéÂØπÊØî„ÄÇ
ÁªºÂêàÔºöÊ®°ËÄÉÂêéÂÅöÈîôÈ¢òÂΩíÂõ†ÔºåÊ†áËÆ∞ÊòØËØçÊ±á/ÂÆö‰Ωç/ÈÄªËæëÁêÜËß£ÈóÆÈ¢ò„ÄÇ`
        }
    };

    const TOEFL_PHASE_LIBRARY = [
        {
            name: "Á¨¨‰∏ÄÈò∂ÊÆµÔºöÂü∫Á°ÄÊïëÁîüÂúà (Foundation & Survival)",
            timeRange: "",
            weeklySchedule: "ÊØèÊó•ËØçÊ±áÂê¨Ëæ®+Âê¨ÂÜôÔºåÁõ≤Âê¨TPOÔºåÈïøÈöæÂè•ÊãÜËß£ÔºåÊ®°ÊùøÁªÉ‰π†",
            lessonLength: "1.5Â∞èÊó∂",
            showFocus: true,
            showMaterials: true,
            focusListening: "Âê¨Èü≥Ëæ®‰πâÔºöÈ´ò‰∏≠3500+ÊâòÁ¶èÈ´òÈ¢ëÔºåÊØèÊó•100ËØçÔºåÊ≠£Á°ÆÁéá>90%ÔºõÂçïËØçÂê¨ÂÜôÊØèÊó•30-50ËØçÔºåÈîôËØçÈáçÂê¨/ÁΩöÊäÑÔºõÁõ≤Âê¨Á£®ËÄ≥ÔºöTPO Conversation ÊØèÊó•2-3ÁØáÔºå30ÁßíËØ≠Èü≥Ê¶ÇÊã¨„ÄÇ",
            focusReading: "ÈïøÈöæÂè•ÊãÜËß£ÔºöÊØèÊó•3-5Âè•ÔºåÂè™Âúà‰∏ªË∞ìÂÆæÔºåÊâìÈÄöËØ≠Ê≥ïÁêÜËß£„ÄÇ",
            focusWriting: "Ê®°ÊùøËÇåËÇâËÆ∞ÂøÜÔºöÁªºÂêà/Áã¨Á´ãÂÜô‰ΩúÊ®°ÊùøÊØèÊó•ÈôêÊó∂Êï≤1ÈÅçÔºà‚â§3ÂàÜÈíüÔºâ„ÄÇ",
            focusSpeaking: "ÂéüÈü≥Ë∑üËØªÔºöTPO Task1/2 ÊñáÊú¨Ê®°‰ªøËØ≠Èü≥ËØ≠Ë∞ÉÔºåÊØèÊó•10-15ÂàÜÈíüÂΩïÈü≥„ÄÇ",
            teachingMaterialTasks: ""
        },
        {
            name: "Á¨¨‰∫åÈò∂ÊÆµÔºöËøõÈò∂Âº∫Âåñ (Development & Logic)",
            timeRange: "",
            weeklySchedule: "ÊØèÊó•Á≤æÂê¨+Á¨îËÆ∞ÔºåÂêå‰πâÊõøÊç¢ÔºåÊÆµËêΩÊÄªÁªìÔºåÂ§çËø∞‰∏éÈÄ†Âè•",
            lessonLength: "1.5Â∞èÊó∂",
            showFocus: true,
            showMaterials: true,
            focusListening: "Âè•Â≠êÂê¨ÂÜôÔºöTPO Lecture ÊØèÊó•3-5Âè•ÔºåÂÖ≥Ê≥®‰ªãËØç/ÂÜ†ËØç/Êó∂ÊÄÅÔºõ‰ø°Âè∑ËØçÊçïÊçâÔºöÊØèÊó•1ÁØáËÆ∞ÂΩïÊèêÁ§∫ËØç+Ê†∏ÂøÉÂêçËØç„ÄÇ",
            focusReading: "ÊÆµËêΩÊÄªÁªìÔºöÊØèÊó•2ÊÆµ TPO ÊñáÁ´†ÔºåÁî®‰∏≠Êñá‰∏ÄÂè•ËØùÊ¶ÇÊã¨ÔºåÂéãÁº©‰ø°ÊÅØ„ÄÇ",
            focusWriting: "ËØ≠ÊñôÈÄ†Âè•ÔºöÈ´òÁ∫ßÁü≠ËØ≠/Âè•ÂûãÊØèÊó•3Âè•ÔºåÂ∫îÁî®ÂΩìÂ§©ÂÜô‰ΩúËØùÈ¢ò„ÄÇ",
            focusSpeaking: "ÂÖ≥ÈîÆËØçÂ§çËø∞ÔºöTPO Task2/3/4 ÊØèÊó•1È¢òÔºåÊåâÁ¨îËÆ∞ÂÅö60ÁßíÂ§çËø∞ÔºåË¶ÜÁõñË¶ÅÁÇπ„ÄÇ",
            teachingMaterialTasks: ""
        },
        {
            name: "Á¨¨‰∏âÈò∂ÊÆµÔºöÈ´òÂàÜÂÜ≤Âà∫ (Advanced & Polishing)",
            timeRange: "",
            weeklySchedule: "ÂÄçÈÄüÂê¨Âäõ + ÈôêÊó∂ÈòÖËØª + One Take Âè£ËØ≠ + ÊÆµËêΩÊîπÂÜô",
            lessonLength: "1.5Â∞èÊó∂",
            showFocus: true,
            showMaterials: true,
            focusListening: "ÂÄçÈÄüËôêËÄ≥ÔºöTPO Lecture 1.2x-1.25x ÊØèÊó•1ÁØáÔºåÂÅöÈ¢òÊàñÂ§çËø∞ÔºåÊ†áËÆ∞ÈîôÈ¢òÂéüÂõ†„ÄÇ",
            focusReading: "ÈôêÊó∂Âà∑È¢òÔºö18ÂàÜÈíüÂÆåÊàê‰∏ÄÁØáÈòÖËØªÔºåÈöîÊó•1ÁØáÔºåÂüπÂÖªÂÆö‰ΩçÂíåÊäóÂπ≤Êâ∞„ÄÇ",
            focusWriting: "ÊÆµËêΩÊîπÂÜôÔºöÊØèÂë®2Ê¨°ÔºåÁî®Âú∞ÈÅìË°®Ëææ‰∏éÂ§öÊ†∑Âè•ÂºèÂçáÁ∫ßÊóßÁ®øÔºåÁªìÂêàÈîôÈ¢òÂΩíÂõ†„ÄÇ",
            focusSpeaking: "One Take ÊåëÊàòÔºöÊØèÊó•Task1ÈöèÊú∫È¢òÔºå‰∏ÄÊ¨°ÂΩïÈü≥45ÁßíÔºåÈÄºÁúüËÄÉËØïÂéãÂäõ„ÄÇ",
            teachingMaterialTasks: ""
        }
    ];

    // --- COMPONENT ---
    const StudyPlanForm = ({ initialData, onGenerate, isGenerating }) => {
        const buildInitialStudent = () => {
            const examType = initialData?.student?.examType || "IELTS";
            const defaultTotal = examType === "TOEFL" ? "90" : "6.5";
            const defaultSub = examType === "TOEFL" ? "22" : "6.0";
            return {
                name: initialData?.student?.name || "",
                currentGradeAndPlan: initialData?.student?.currentGradeAndPlan || "",
                examDate: initialData?.student?.examDate || "",
                targetTotalScore: initialData?.student?.targetTotalScore || defaultTotal,
                targetSubScore: initialData?.student?.targetSubScore || defaultSub,
                examType,
            };
        };

        const [student, setStudent] = useState(buildInitialStudent());
        const [phases, setPhases] = useState(initialData?.phases || []);
        const [pricing, setPricing] = useState(initialData?.pricing || []);

        // Initialize exam date if empty
        useEffect(() => {
            if (!student.examDate && EXAM_DATES.length > 0) {
                setStudent(prev => ({ ...prev, examDate: EXAM_DATES[3] })); // Default to ~3 months out
            }
        }, []);

        const handleStudentChange = (e) => {
            const { name, value } = e.target;
            if (name === "examType") {
                const totalOptions = SCORE_OPTIONS[value] || [];
                const subOptions = SUB_SCORE_OPTIONS[value] || [];
                const updatedTotal = totalOptions.includes(student.targetTotalScore) ? student.targetTotalScore : (value === "TOEFL" ? "90" : "6.5");
                const updatedSub = student.targetSubScore === "Êó†Ë¶ÅÊ±Ç"
                    ? "Êó†Ë¶ÅÊ±Ç"
                    : (subOptions.includes(student.targetSubScore) ? student.targetSubScore : (value === "TOEFL" ? "22" : "6.0"));

                setStudent(prev => ({
                    ...prev,
                    examType: value,
                    targetTotalScore: updatedTotal,
                    targetSubScore: updatedSub,
                }));

                setPricing(rows => rows.map(row => {
                    const options = SUBJECT_OPTIONS[value] || [];
                    return options.includes(row.subject) ? row : { ...row, subject: options[0] || row.subject };
                }));
            } else {
                setStudent({ ...student, [name]: value });
            }
        };

        const focusPresets = FOCUS_PRESETS[student.examType] || {};
        const materialPresets = MATERIAL_PRESETS[student.examType] || {};
        const examLabel = EXAM_LABELS[student.examType] || "ÈõÖÊÄù/ÊâòÁ¶è";
        const scoreOptions = SCORE_OPTIONS[student.examType] || [];
        const subScoreOptions = SUB_SCORE_OPTIONS[student.examType] || [];
        const subjectOptions = SUBJECT_OPTIONS[student.examType] || SUBJECT_OPTIONS.IELTS;
        const teachingPlaceholder = student.examType === "TOEFL"
            ? "‰æãÂ¶ÇÔºöÁõ≤Âê¨ TPO Conversation + Âêå‰πâËØçÈÖçÂØπÊØèÊó•‰ªªÂä°..."
            : "‰æãÂ¶ÇÔºö„ÄäÁùøÁÑ∂ÈõÖÊÄùÈòÖËØªÊïôËæÖ„ÄãUnit 1‚Äì3...";

        const displayTotalScoreOptions = [...scoreOptions];
        if (student.targetTotalScore && !displayTotalScoreOptions.includes(student.targetTotalScore)) {
            displayTotalScoreOptions.unshift(student.targetTotalScore);
        }
        const displaySubScoreOptions = [...subScoreOptions];
        if (student.targetSubScore && student.targetSubScore !== "Êó†Ë¶ÅÊ±Ç" && !displaySubScoreOptions.includes(student.targetSubScore)) {
            displaySubScoreOptions.unshift(student.targetSubScore);
        }

        // Ensure pricing rows always have a valid subject for current exam type
        useEffect(() => {
            const opts = subjectOptions || [];
            if (!opts.length) return;
            setPricing(rows =>
                rows.map(row => {
                    if (!row.subject || !opts.includes(row.subject)) {
                        return { ...row, subject: opts[0] };
                    }
                    return row;
                })
            );
        }, [subjectOptions]);

        const buildToeflPhasesWithMaterials = () => TOEFL_PHASE_LIBRARY.map(phase => ({
            ...phase,
            id: crypto.randomUUID(),
            teachingMaterialTasks: MATERIAL_PRESETS.TOEFL?.[phase.name] || phase.teachingMaterialTasks || "",
        }));

        const applyToeflPreset = () => {
            setStudent(prev => ({
                ...prev,
                examType: "TOEFL",
                targetTotalScore: SCORE_OPTIONS.TOEFL.includes(prev.targetTotalScore) ? prev.targetTotalScore : "90",
                targetSubScore: prev.targetSubScore === "Êó†Ë¶ÅÊ±Ç" ? "Êó†Ë¶ÅÊ±Ç" : (SUB_SCORE_OPTIONS.TOEFL.includes(prev.targetSubScore) ? prev.targetSubScore : "22"),
            }));
            setPhases(buildToeflPhasesWithMaterials());
            setPricing(rows => rows.map(row => {
                const options = SUBJECT_OPTIONS.TOEFL;
                return options.includes(row.subject) ? row : { ...row, subject: options[0] || row.subject };
            }));
        };

        // Phase Handlers
        const addPhase = () => {
            const newPhase = {
                id: crypto.randomUUID(),
                name: `Á¨¨${phases.length + 1}Èò∂ÊÆµÔºö[ÂêçÁß∞]`,
                timeRange: "",
                weeklySchedule: "",
                lessonLength: "1.5Â∞èÊó∂",
                showFocus: true,
                showMaterials: true,
                focusListening: "",
                focusReading: "",
                focusWriting: "",
                focusSpeaking: "",
                teachingMaterialTasks: "",
            };
            setPhases([...phases, newPhase]);
        };

        const removePhase = (id) => {
            setPhases(phases.filter((p) => p.id !== id));
        };

        const handlePhaseChange = (id, field, value) => {
            setPhases(
                phases.map((p) => (p.id === id ? { ...p, [field]: value } : p))
            );
        };

        const applyFocusPreset = (id, presetName) => {
            const preset = focusPresets[presetName];
            if (preset) {
                setPhases(phases.map(p => p.id === id ? {
                    ...p,
                    focusListening: preset.L,
                    focusReading: preset.R,
                    focusWriting: preset.W,
                    focusSpeaking: preset.S
                } : p));
            }
        };

        const applyMaterialPreset = (id, presetName) => {
            const preset = materialPresets[presetName];
            if (preset) {
                setPhases(phases.map(p => {
                    if (p.id === id) {
                        const currentText = p.teachingMaterialTasks || "";
                        // If text exists, append with newline; otherwise just set it
                        const newText = currentText ? `${currentText}\n${preset}` : preset;
                        return { ...p, teachingMaterialTasks: newText };
                    }
                    return p;
                }));
            }
        };

        // Pricing Handlers
        const addPricingRow = () => {
            const newRow = {
                id: crypto.randomUUID(),
                phase: phases.length > 0 ? phases[0].name.split("Ôºö")[0] : "",
                subject: subjectOptions[0] || "",
                duration: 1.5,
                count: 0,
                totalDuration: 0,
                unitPrice: 800,
                subtotal: 0,
            };
            setPricing([...pricing, newRow]);
        };

        const removePricingRow = (id) => {
            setPricing(pricing.filter((r) => r.id !== id));
        };

        const handlePricingChange = (id, field, value) => {
            setPricing((prevPricing) =>
                prevPricing.map((r) => {
                    if (r.id === id) {
                        const updatedRow = { ...r, [field]: value };
                        if (field === "duration" || field === "count") {
                            const d = field === "duration" ? Number(value) : r.duration;
                            const c = field === "count" ? Number(value) : r.count;
                            updatedRow.totalDuration = d * c;
                            updatedRow.subtotal = updatedRow.totalDuration * r.unitPrice;
                        }
                        if (field === "unitPrice") {
                            const p = Number(value);
                            updatedRow.subtotal = r.totalDuration * p;
                        }
                        return updatedRow;
                    }
                    return r;
                })
            );
        };

        const calculateTotal = () => {
            return pricing.reduce((sum, row) => sum + row.subtotal, 0);
        };

        const handleSubmit = (e) => {
            e.preventDefault();
            onGenerate({ student, phases, pricing });
        };

        return (
            <div className="max-w-5xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
                {/* Brand Header */}
                <div className="flex flex-col items-center justify-center mb-12">
                    <div className="bg-brand-600 p-3 rounded-2xl shadow-lg mb-4">
                        <Sprout className="w-10 h-10 text-white" />
                    </div>
                    <h1 className="text-3xl font-bold text-slate-900 tracking-tight">
                        Sage Path <span className="text-brand-600">ÁùøÁÑ∂ÂõΩÈôÖÊïôËÇ≤</span>
                    </h1>
                    <p className="text-slate-500 mt-2 font-medium flex items-center gap-2">
                        ÈõÖÊÄù / ÊâòÁ¶èÂ≠¶‰π†ÊñπÊ°àÁîüÊàêÁ≥ªÁªü
                        <span className="px-3 py-1 rounded-full bg-brand-100 text-brand-700 text-xs font-semibold">{examLabel}ÊñπÊ°à</span>
                    </p>
                </div>

                <form onSubmit={handleSubmit} className="space-y-8">
                    {/* Section 1: Student Info */}
                    <section className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div className="border-b border-slate-100 bg-slate-50/50 px-6 py-4 flex items-center">
                            <span className="flex items-center justify-center w-8 h-8 rounded-full bg-brand-100 text-brand-700 font-bold text-sm mr-3">
                                1
                            </span>
                            <h2 className="text-lg font-semibold text-slate-800">
                                Â≠¶ÁîüÂü∫Êú¨‰ø°ÊÅØ
                            </h2>
                        </div>

                        <div className="p-6 flex flex-col md:flex-row gap-8">
                            <div className="flex-shrink-0 flex justify-center md:justify-start">
                                <div className="relative group">
                                    <div className="w-32 h-32 rounded-full bg-slate-100 flex items-center justify-center text-6xl border-4 border-slate-50 shadow-md">
                                        üßë‚Äçüéì
                                    </div>
                                    <div className="absolute bottom-1 right-1 bg-green-500 w-4 h-4 rounded-full border-2 border-white shadow-sm"></div>
                                </div>
                            </div>

                            <div className="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        Â≠¶ÁîüÂßìÂêç
                                    </label>
                                    <input
                                        type="text"
                                        name="name"
                                        required
                                        value={student.name}
                                        onChange={handleStudentChange}
                                        className="w-full rounded-lg border-slate-200 shadow-sm focus:border-brand-500 focus:ring-brand-500 p-2.5 border"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        ËÄÉËØïÁ±ªÂûã
                                    </label>
                                    <div className="relative">
                                        <select
                                            name="examType"
                                            value={student.examType}
                                            onChange={handleStudentChange}
                                            className="w-full rounded-lg border-slate-200 shadow-sm focus:border-brand-500 focus:ring-brand-500 p-2.5 border appearance-none bg-white"
                                        >
                                            {EXAM_TYPES.map(option => (
                                                <option key={option.value} value={option.value}>{option.label}</option>
                                            ))}
                                        </select>
                                        <ChevronDown className="absolute right-3 top-3 w-4 h-4 text-slate-400 pointer-events-none" />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        ÁõÆÊ†áËÄÉËØïÊó∂Èó¥
                                    </label>
                                    <div className="relative">
                                        <select
                                            name="examDate"
                                            value={student.examDate}
                                            onChange={handleStudentChange}
                                            className="w-full rounded-lg border-slate-200 shadow-sm focus:border-brand-500 focus:ring-brand-500 p-2.5 border appearance-none bg-white"
                                        >
                                            <option value="">ËØ∑ÈÄâÊã©Êó∂Èó¥...</option>
                                            {EXAM_DATES.map(date => (
                                                <option key={date} value={date}>{date}</option>
                                            ))}
                                        </select>
                                        <ChevronDown className="absolute right-3 top-3 w-4 h-4 text-slate-400 pointer-events-none" />
                                    </div>
                                </div>

                                {/* Split Score Selection */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        ÁõÆÊ†áÊÄªÂàÜ
                                    </label>
                                    <div className="relative">
                                        <select
                                            name="targetTotalScore"
                                            value={student.targetTotalScore}
                                            onChange={handleStudentChange}
                                            className="w-full rounded-lg border-slate-200 shadow-sm focus:border-brand-500 focus:ring-brand-500 p-2.5 border appearance-none bg-white"
                                        >
                                            {displayTotalScoreOptions.map(score => (
                                                <option key={score} value={score}>{score}ÂàÜ</option>
                                            ))}
                                        </select>
                                        <ChevronDown className="absolute right-3 top-3 w-4 h-4 text-slate-400 pointer-events-none" />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        ÂçïÁßëË¶ÅÊ±Ç (Â∞èÂàÜ)
                                    </label>
                                    <div className="relative">
                                        <select
                                            name="targetSubScore"
                                            value={student.targetSubScore}
                                            onChange={handleStudentChange}
                                            className="w-full rounded-lg border-slate-200 shadow-sm focus:border-brand-500 focus:ring-brand-500 p-2.5 border appearance-none bg-white"
                                        >
                                            <option value="Êó†Ë¶ÅÊ±Ç">Êó†Ë¶ÅÊ±Ç</option>
                                            {displaySubScoreOptions.map(score => (
                                                <option key={score} value={score}>‰∏ç‰Ωé‰∫é {score}</option>
                                            ))}
                                        </select>
                                        <ChevronDown className="absolute right-3 top-3 w-4 h-4 text-slate-400 pointer-events-none" />
                                    </div>
                                </div>

                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        ÂΩìÂâçÂπ¥Á∫ß‰∏éËßÑÂàí / ÂÖ•Â≠¶ÊÉÖÂÜµ
                                    </label>
                                    <textarea
                                        name="currentGradeAndPlan"
                                        required
                                        rows={3}
                                        value={student.currentGradeAndPlan}
                                        onChange={handleStudentChange}
                                        className="w-full rounded-lg border-slate-200 shadow-sm focus:border-brand-500 focus:ring-brand-500 p-2.5 border"
                                        placeholder="ÊèèËø∞Â≠¶ÁîüÂπ¥Á∫ß„ÄÅÁïôÂ≠¶ÁõÆÁöÑÂú∞„ÄÅÂΩìÂâçËã±ËØ≠Ê∞¥Âπ≥ÊàñËÄÉËØïÊàêÁª©..."
                                    />
                                </div>
                            </div>
                        </div>
                    </section>

                    {/* Section 2: Course Phases */}
                    <section className="space-y-6">
                        <div className="flex justify-between items-center px-2">
                            <div className="flex items-center">
                                <span className="flex items-center justify-center w-8 h-8 rounded-full bg-brand-100 text-brand-700 font-bold text-sm mr-3">
                                    2
                                </span>
                                <h2 className="text-xl font-semibold text-slate-800">
                                    ËØæÁ®ãÈò∂ÊÆµËßÑÂàí
                                </h2>
                            </div>
                            <div className="flex items-center gap-3">
                                <button
                                    type="button"
                                    onClick={applyToeflPreset}
                                    className="inline-flex items-center px-4 py-2 border border-brand-200 text-sm leading-4 font-medium rounded-lg text-brand-700 bg-white hover:bg-brand-50 transition-colors"
                                    title="‰∏ÄÈîÆÂ°´ÂÖÖÊâòÁ¶è‰∏âÈò∂ÊÆµÊ®°Êùø"
                                >
                                    <Wand2 className="h-4 w-4 mr-1.5" /> ÊâòÁ¶è‰∏âÈò∂ÊÆµÊ®°Êùø
                                </button>
                                <button
                                    type="button"
                                    onClick={addPhase}
                                    className="inline-flex items-center px-4 py-2 border border-transparent text-sm leading-4 font-medium rounded-lg text-brand-700 bg-brand-50 hover:bg-brand-100 transition-colors"
                                >
                                    <Plus className="h-4 w-4 mr-1.5" /> Ê∑ªÂä†Èò∂ÊÆµ
                                </button>
                            </div>
                        </div>

                        {phases.map((phase, index) => (
                            <div
                                key={phase.id}
                                className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 relative group hover:shadow-md transition-shadow"
                            >
                                <div className="absolute top-4 right-4">
                                    <button
                                        type="button"
                                        onClick={() => removePhase(phase.id)}
                                        className="text-slate-300 hover:text-red-500 transition-colors"
                                    >
                                        <Trash2 className="h-5 w-5" />
                                    </button>
                                </div>

                                <div className="mb-4">
                                    <h3 className="text-lg font-medium text-brand-900">
                                        Èò∂ÊÆµ {index + 1}
                                    </h3>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Èò∂ÊÆµÂêçÁß∞</label>
                                        <input
                                            type="text"
                                            value={phase.name}
                                            onChange={(e) => handlePhaseChange(phase.id, "name", e.target.value)}
                                            className="w-full rounded-md border-slate-300 p-2 border"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Êó∂Èó¥ËåÉÂõ¥</label>
                                        <input
                                            type="text"
                                            value={phase.timeRange}
                                            onChange={(e) => handlePhaseChange(phase.id, "timeRange", e.target.value)}
                                            placeholder="2025Âπ¥9Êúà‚Äì10Êúà"
                                            className="w-full rounded-md border-slate-300 p-2 border"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">ÂçïÊ¨°ËØæÊó∂Èïø</label>
                                        <input
                                            type="text"
                                            value={phase.lessonLength}
                                            onChange={(e) => handlePhaseChange(phase.id, "lessonLength", e.target.value)}
                                            placeholder="1.5Â∞èÊó∂"
                                            className="w-full rounded-md border-slate-300 p-2 border"
                                        />
                                    </div>
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-slate-700 mb-1">ÊØèÂë®ÂÆâÊéí</label>
                                        <input
                                            type="text"
                                            value={phase.weeklySchedule}
                                            onChange={(e) => handlePhaseChange(phase.id, "weeklySchedule", e.target.value)}
                                            placeholder="ÊØèÂë®2Ê¨°ÈòÖËØªÔºå1Ê¨°Âè£ËØ≠"
                                            className="w-full rounded-md border-slate-300 p-2 border"
                                        />
                                    </div>

                                    {/* Training Focus Grid - WITH TOGGLE & PRESET */}
                                    <div className="md:col-span-2 bg-slate-50 p-4 rounded-lg border border-slate-100">
                                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                                            <div className="flex items-center">
                                                <div className="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                                    <input
                                                        type="checkbox"
                                                        name={`toggle-focus-${phase.id}`}
                                                        id={`toggle-focus-${phase.id}`}
                                                        checked={phase.showFocus}
                                                        onChange={(e) => handlePhaseChange(phase.id, "showFocus", e.target.checked)}
                                                        className="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer checked:right-0 right-5"
                                                    />
                                                    <label htmlFor={`toggle-focus-${phase.id}`} className={`toggle-label block overflow-hidden h-5 rounded-full cursor-pointer ${phase.showFocus ? 'bg-brand-500' : 'bg-slate-300'}`}></label>
                                                </div>
                                                <label htmlFor={`toggle-focus-${phase.id}`} className="text-sm font-medium text-slate-700 cursor-pointer select-none">
                                                    ÂåÖÂê´ËÆ≠ÁªÉÈáçÁÇπ
                                                </label>
                                            </div>

                                            {phase.showFocus && (
                                                <div className="relative w-full sm:w-64">
                                                    <select
                                                        onChange={(e) => applyFocusPreset(phase.id, e.target.value)}
                                                        className="w-full text-xs rounded-md border-slate-300 shadow-sm p-1.5 border bg-white pl-8"
                                                        defaultValue=""
                                                    >
                                                        <option value="" disabled>‚ú® Âø´ÈÄüÂ°´ÂÖÖ (ÈÄâÊã©Ê®°Êùø)</option>
                                                        {Object.keys(focusPresets).map(key => (
                                                            <option key={key} value={key}>{key}</option>
                                                        ))}
                                                    </select>
                                                    <ListChecks className="w-3.5 h-3.5 absolute left-2.5 top-2.5 text-slate-400" />
                                                </div>
                                            )}
                                        </div>

                                        {phase.showFocus && (
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 animate-in fade-in slide-in-from-top-2 duration-300">
                                                <div>
                                                    <label className="block text-xs font-semibold text-slate-500 mb-1">Âê¨Âäõ (Listening)</label>
                                                    <textarea rows={2} value={phase.focusListening} onChange={(e) => handlePhaseChange(phase.id, "focusListening", e.target.value)} className="w-full rounded-md border-slate-300 p-2 border text-sm" />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-semibold text-slate-500 mb-1">ÈòÖËØª (Reading)</label>
                                                    <textarea rows={2} value={phase.focusReading} onChange={(e) => handlePhaseChange(phase.id, "focusReading", e.target.value)} className="w-full rounded-md border-slate-300 p-2 border text-sm" />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-semibold text-slate-500 mb-1">ÂÜô‰Ωú (Writing)</label>
                                                    <textarea rows={2} value={phase.focusWriting} onChange={(e) => handlePhaseChange(phase.id, "focusWriting", e.target.value)} className="w-full rounded-md border-slate-300 p-2 border text-sm" />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-semibold text-slate-500 mb-1">Âè£ËØ≠ (Speaking)</label>
                                                    <textarea rows={2} value={phase.focusSpeaking} onChange={(e) => handlePhaseChange(phase.id, "focusSpeaking", e.target.value)} className="w-full rounded-md border-slate-300 p-2 border text-sm" />
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Materials - WITH TOGGLE & PRESET */}
                                    <div className="md:col-span-2 bg-brand-50/50 p-5 rounded-lg border border-brand-100">
                                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                                            <div className="flex items-center">
                                                <div className="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                                    <input
                                                        type="checkbox"
                                                        name={`toggle-materials-${phase.id}`}
                                                        id={`toggle-materials-${phase.id}`}
                                                        checked={phase.showMaterials}
                                                        onChange={(e) => handlePhaseChange(phase.id, "showMaterials", e.target.checked)}
                                                        className="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer checked:right-0 right-5"
                                                    />
                                                    <label htmlFor={`toggle-materials-${phase.id}`} className={`toggle-label block overflow-hidden h-5 rounded-full cursor-pointer ${phase.showMaterials ? 'bg-brand-500' : 'bg-slate-300'}`}></label>
                                                </div>
                                                <label htmlFor={`toggle-materials-${phase.id}`} className="text-sm font-semibold text-brand-800 flex items-center cursor-pointer select-none">
                                                    <BookOpen className="w-4 h-4 mr-2" />
                                                    ÂåÖÂê´ÊïôËæÖÊùêÊñô‰∏éËØæÂêé‰ªªÂä°
                                                </label>
                                            </div>

                                            {phase.showMaterials && (
                                                <div className="relative w-full sm:w-64">
                                                    <select
                                                        onChange={(e) => applyMaterialPreset(phase.id, e.target.value)}
                                                        className="w-full text-xs rounded-md border-brand-200 shadow-sm p-1.5 border bg-white pl-8 focus:ring-brand-500 focus:border-brand-500"
                                                        defaultValue=""
                                                    >
                                                        <option value="" disabled>‚ú® Âø´ÈÄüÂ°´ÂÖÖ (ÈÄâÊã©Ê®°Êùø)</option>
                                                        {Object.keys(materialPresets).map(key => (
                                                            <option key={key} value={key}>{key}</option>
                                                        ))}
                                                    </select>
                                                    <ListChecks className="w-3.5 h-3.5 absolute left-2.5 top-2.5 text-brand-400" />
                                                </div>
                                            )}
                                        </div>

                                        {phase.showMaterials && (
                                            <div className="flex flex-col sm:flex-row gap-5 animate-in fade-in slide-in-from-top-2 duration-300">
                                                <div className="hidden sm:block flex-shrink-0">
                                                    <div className="w-24 h-32 bg-brand-100 rounded-md flex items-center justify-center text-5xl shadow-sm border border-brand-200 transform -rotate-2 text-brand-600">
                                                        üìö
                                                    </div>
                                                </div>
                                                <div className="flex-grow">
                                                    <textarea
                                                        rows={4}
                                                        value={phase.teachingMaterialTasks}
                                                        onChange={(e) => handlePhaseChange(phase.id, "teachingMaterialTasks", e.target.value)}
                                                        placeholder={teachingPlaceholder}
                                                        className="w-full rounded-md border-brand-200 shadow-sm focus:border-brand-500 focus:ring-brand-500 p-2 border bg-white"
                                                    />
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </section>

                    {/* Section 3: Pricing Table */}
                    <section className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div className="border-b border-slate-100 bg-slate-50/50 px-6 py-4 flex justify-between items-center">
                            <div className="flex items-center">
                                <span className="flex items-center justify-center w-8 h-8 rounded-full bg-brand-100 text-brand-700 font-bold text-sm mr-3">
                                    3
                                </span>
                                <h2 className="text-lg font-semibold text-slate-800">
                                    ËØæÊó∂‰∏éË¥πÁî®
                                </h2>
                            </div>
                            <button
                                type="button"
                                onClick={addPricingRow}
                                className="inline-flex items-center px-4 py-2 border border-transparent text-sm leading-4 font-medium rounded-lg text-brand-700 bg-brand-50 hover:bg-brand-100 transition-colors"
                            >
                                <Plus className="h-4 w-4 mr-1.5" /> Ê∑ªÂä†Ë¥πÁî®Ë°å
                            </button>
                        </div>

                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-200">
                                <thead className="bg-slate-50">
                                    <tr>
                                        <th scope="col" className="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Èò∂ÊÆµ</th>
                                        <th scope="col" className="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">ÁßëÁõÆ</th>
                                        <th scope="col" className="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">ÂçïÊ¨°Êó∂Èïø(h)</th>
                                        <th scope="col" className="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">ËØæÊ¨°</th>
                                        <th scope="col" className="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">ÊÄªÊó∂Èïø(h)</th>
                                        <th scope="col" className="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Âçï‰ª∑(ÂÖÉ/h)</th>
                                        <th scope="col" className="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Â∞èËÆ°</th>
                                        <th scope="col" className="relative px-6 py-4"><span className="sr-only">Delete</span></th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-slate-200">
                                    {pricing.map((row) => (
                                        <tr key={row.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="px-4 py-3">
                                                <input
                                                    type="text"
                                                    value={row.phase}
                                                    onChange={(e) => handlePricingChange(row.id, "phase", e.target.value)}
                                                    className="w-full text-sm border-slate-300 rounded p-1.5 border"
                                                />
                                            </td>
                                            <td className="px-4 py-3">
                                                <select
                                                    value={row.subject}
                                                    onChange={(e) => handlePricingChange(row.id, "subject", e.target.value)}
                                                    className="w-full text-sm border-slate-300 rounded p-1.5 border bg-white"
                                                >
                                                    {(!subjectOptions || !subjectOptions.length) && (
                                                        <option value="">ËØ∑ÈÄâÊã©ÁßëÁõÆ</option>
                                                    )}
                                                    {Array.from(new Set([...(subjectOptions || []), row.subject].filter(Boolean))).map(subject => (
                                                        <option key={subject} value={subject}>{subject}</option>
                                                    ))}
                                                </select>
                                            </td>
                                            <td className="px-4 py-3">
                                                <input
                                                    type="number"
                                                    step="0.5"
                                                    value={row.duration}
                                                    onChange={(e) => handlePricingChange(row.id, "duration", e.target.value)}
                                                    className="w-20 text-sm border-slate-300 rounded p-1.5 border"
                                                />
                                            </td>
                                            <td className="px-4 py-3">
                                                <input
                                                    type="number"
                                                    value={row.count}
                                                    onChange={(e) => handlePricingChange(row.id, "count", Number(e.target.value))}
                                                    className="w-20 text-sm border-slate-300 rounded p-1.5 border"
                                                />
                                            </td>
                                            <td className="px-4 py-3">
                                                <input
                                                    type="number"
                                                    readOnly
                                                    value={row.totalDuration}
                                                    className="w-20 text-sm border-slate-200 bg-slate-50 rounded p-1.5 border text-slate-500 cursor-not-allowed"
                                                />
                                            </td>
                                            <td className="px-4 py-3">
                                                <select
                                                    value={row.unitPrice}
                                                    onChange={(e) => handlePricingChange(row.id, "unitPrice", Number(e.target.value))}
                                                    className="w-24 text-sm border-slate-300 rounded p-1.5 border bg-white"
                                                >
                                                    <option value={800}>800</option>
                                                    <option value={750}>750</option>
                                                    <option value={700}>700</option>
                                                    <option value={680}>680</option>
                                                </select>
                                            </td>
                                            <td className="px-6 py-3 whitespace-nowrap text-sm text-slate-700 font-medium">
                                                <div className="flex items-center">
                                                    <span className="text-gray-500 mr-1">¬•</span>
                                                    <input
                                                        type="number"
                                                        value={row.subtotal}
                                                        onChange={(e) => handlePricingChange(row.id, "subtotal", Number(e.target.value))}
                                                        className="w-24 text-sm border-slate-300 rounded p-1.5 border font-medium"
                                                    />
                                                </div>
                                            </td>
                                            <td className="px-6 py-3 whitespace-nowrap text-right text-sm font-medium">
                                                <button
                                                    type="button"
                                                    onClick={() => removePricingRow(row.id)}
                                                    className="text-slate-400 hover:text-red-600 transition-colors"
                                                >
                                                    <Trash2 className="w-4 h-4" />
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                    <tr className="bg-brand-50/30 font-bold">
                                        <td colSpan={6} className="px-6 py-4 text-right text-sm text-brand-900">
                                            ÂêàËÆ°
                                        </td>
                                        <td className="px-6 py-4 text-left text-base text-brand-700">
                                            ¬•{calculateTotal().toLocaleString()}
                                        </td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    {/* Action Button */}
                    <div className="flex justify-center pt-8 pb-20">
                        <button
                            type="submit"
                            disabled={isGenerating}
                            className={`
                flex items-center justify-center px-10 py-4 text-lg font-medium rounded-full shadow-xl text-white 
                ${isGenerating ? 'bg-slate-400 cursor-not-allowed' : 'bg-brand-600 hover:bg-brand-700 hover:shadow-2xl hover:scale-105 transform transition-all duration-200'}
              `}
                        >
                            {isGenerating ? (
                                <>
                                    <Calculator className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" />
                                    Ê≠£Âú®‰øùÂ≠ò...
                                </>
                            ) : (
                                <>
                                    <Wand2 className="-ml-1 mr-3 h-6 w-6" />
                                    ‰øùÂ≠òÊñπÊ°à
                                </>
                            )}
                        </button>
                    </div>
                </form>
            </div>
        );
    };

    // --- APP ROOT ---
    const App = ({ serverData }) => {
        const [isGenerating, setIsGenerating] = useState(false);

        // Use server data if provided, otherwise use defaults for new plan
        const initialData = serverData || {
            student: {
                name: "",
                currentGradeAndPlan: "",
                examDate: "",
                examType: "IELTS",
                targetTotalScore: "6.5",
                targetSubScore: "6.0"
            },
            phases: [
                {
                    id: crypto.randomUUID(),
                    name: "Á¨¨‰∏ÄÈò∂ÊÆµÔºöÂü∫Á°ÄÂ∑©Âõ∫",
                    timeRange: "",
                    weeklySchedule: "",
                    lessonLength: "1.5Â∞èÊó∂",
                    showFocus: true,
                    showMaterials: true,
                    focusListening: "",
                    focusReading: "",
                    focusWriting: "",
                    focusSpeaking: "",
                    teachingMaterialTasks: ""
                }
            ],
            pricing: []
        };

        const handleGenerate = async (data) => {
            setIsGenerating(true);
            try {
                const response = await fetch('/api/course-plans', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('ÊñπÊ°à‰øùÂ≠òÊàêÂäüÔºÅPDF Âç≥Â∞ÜÂºÄÂßã‰∏ãËΩΩ...');
                    // Automatically trigger PDF download
                    window.location.href = `/api/course-plans/${result.id}/pdf`;
                } else {
                    alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                }
            } catch (error) {
                console.error(error);
                alert('ÁΩëÁªúÈîôËØØ');
            } finally {
                setIsGenerating(false);
            }
        };

        return React.createElement(StudyPlanForm, {
            initialData: initialData,
            onGenerate: handleGenerate,
            isGenerating: isGenerating
        });
    };

    // Receive data from server (Jinja2 template)
    const serverInitialData = {{ initial_data | safe if initial_data else 'null' }};

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App, { serverData: serverInitialData }));
</script>
{% endblock %}
