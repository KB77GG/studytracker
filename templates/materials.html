{% extends "base.html" %}

{% block title %}ææ–™åº“ç®¡ç†{% endblock %}

{% block content_dashboard %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <!-- Tabs -->
                    <ul class="nav nav-tabs card-header-tabs" id="materialTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="materials-tab" data-toggle="tab" href="#materials"
                                role="tab">
                                ğŸ“š æ•™è¾…ææ–™
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="dictation-tab" data-toggle="tab" href="#dictation" role="tab">
                                ğŸ§ å¬å†™è¯åº“
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="materialTabContent">
                        <!-- æ•™è¾…ææ–™ Tab -->
                        <div class="tab-pane fade show active" id="materials" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">ææ–™åˆ—è¡¨</h5>
                                <button class="btn btn-primary" onclick="window.location.href='/materials/create'">
                                    <i class="fas fa-plus"></i> åˆ›å»ºæ–°ææ–™
                                </button>
                            </div>
                            <!-- ç­›é€‰æ  -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <select class="form-control" id="typeFilter" onchange="filterMaterials()">
                                        <option value="">å…¨éƒ¨ç±»å‹</option>
                                        <option value="grammar">è¯­æ³•ç»ƒä¹ </option>
                                        <option value="translation">ç¿»è¯‘ç»ƒä¹ </option>
                                        <option value="speaking">å£è¯­æœ—è¯»</option>
                                        <option value="writing">å†™ä½œè®­ç»ƒ</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="searchInput" placeholder="æœç´¢ææ–™æ ‡é¢˜..."
                                        onkeyup="filterMaterials()">
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-secondary btn-block" onclick="loadMaterials()">
                                        <i class="fas fa-sync"></i> åˆ·æ–°
                                    </button>
                                </div>
                            </div>

                            <!-- ææ–™åˆ—è¡¨ -->
                            <div id="materialsList">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">åŠ è½½ä¸­...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å¬å†™è¯åº“ Tab -->
                        <div class="tab-pane fade" id="dictation" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">å¬å†™è¯åº“</h5>
                                <button class="btn btn-success" data-toggle="modal" data-target="#uploadBookModal">
                                    <i class="fas fa-upload"></i> ä¸Šä¼ Excelè¯åº“
                                </button>
                            </div>

                            <!-- è¯åº“åˆ—è¡¨ -->
                            <div id="dictationBooksList">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-success" role="status">
                                        <span class="sr-only">åŠ è½½ä¸­...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ä¸Šä¼ è¯åº“ Modal -->
<div class="modal fade" id="uploadBookModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ“š ä¸Šä¼ å¬å†™è¯åº“</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="uploadBookForm">
                    <div class="form-group">
                        <label>è¯åº“åç§° <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="bookTitle" placeholder="å¦‚ï¼šé›…æ€ç‹è¯­æ–™åº“ ç« 3-1" required>
                    </div>
                    <div class="form-group">
                        <label>è¯åº“æè¿°</label>
                        <textarea class="form-control" id="bookDescription" rows="2" placeholder="å¯é€‰ï¼Œç®€çŸ­æè¿°"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Excelæ–‡ä»¶ <span class="text-danger">*</span></label>
                        <input type="file" class="form-control-file" id="bookFile" accept=".xlsx,.xls" required>
                        <small class="text-muted">
                            Exceléœ€åŒ…å«åˆ—ï¼šå•è¯ã€éŸ³æ ‡(å¯é€‰)ã€é‡Šä¹‰(å¯é€‰)<br>
                            ç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆè‹±/ç¾åŒç‰ˆæœ¬å‘éŸ³
                        </small>
                    </div>
                </form>
                <div id="uploadProgress" style="display:none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                    </div>
                    <p class="text-center mt-2">æ­£åœ¨å¤„ç†å¹¶ç”ŸæˆéŸ³é¢‘ï¼Œè¯·ç¨å€™...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" onclick="uploadBook()">
                    <i class="fas fa-upload"></i> ä¸Šä¼ å¹¶ç”ŸæˆéŸ³é¢‘
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let allMaterials = [];
    let allBooks = [];

    // åŠ è½½ææ–™åˆ—è¡¨
    async function loadMaterials() {
        const typeFilter = document.getElementById('typeFilter').value;
        const searchInput = document.getElementById('searchInput').value;

        try {
            let url = '/api/materials?';
            if (typeFilter) url += `type=${typeFilter}&`;
            if (searchInput) url += `search=${encodeURIComponent(searchInput)}`;

            const response = await fetch(url, {
                credentials: 'include'
            });
            const data = await response.json();

            if (data.ok) {
                allMaterials = data.materials;
                renderMaterials(allMaterials);
            } else {
                showError('åŠ è½½å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            showError('ç½‘ç»œé”™è¯¯ï¼š' + err.message);
        }
    }

    // åŠ è½½å¬å†™è¯åº“åˆ—è¡¨
    async function loadDictationBooks() {
        try {
            const response = await fetch('/api/dictation/books', {
                credentials: 'include'
            });
            const data = await response.json();

            if (data.ok) {
                allBooks = data.books;
                renderDictationBooks(allBooks);
            } else {
                showError('åŠ è½½è¯åº“å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            showError('ç½‘ç»œé”™è¯¯ï¼š' + err.message);
        }
    }

    // æ¸²æŸ“å¬å†™è¯åº“åˆ—è¡¨
    function renderDictationBooks(books) {
        const container = document.getElementById('dictationBooksList');

        if (books.length === 0) {
            container.innerHTML = `
            <div class="text-center py-5 text-muted">
                <i class="fas fa-headphones fa-3x mb-3"></i>
                <p>æš‚æ— è¯åº“ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ä¸Šä¼ Excel</p>
            </div>
        `;
            return;
        }

        let html = '<div class="list-group">';
        books.forEach(b => {
            html += `
            <div class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">
                        <span class="badge badge-success mr-2">ğŸ§ å¬å†™</span>
                        ${b.title}
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewDictationBook(${b.id})">
                            <i class="fas fa-eye"></i> æŸ¥çœ‹
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="createDictationTask(${b.id})">
                            <i class="fas fa-paper-plane"></i> å‘å¸ƒä»»åŠ¡
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteDictationBook(${b.id})">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                    </div>
                </div>
                <p class="mb-1 text-muted">${b.description || 'æš‚æ— è¯´æ˜'}</p>
                <small>
                    <i class="fas fa-list-ol"></i> ${b.word_count} è¯ | 
                    <i class="fas fa-calendar"></i> ${b.created_at ? b.created_at.split('T')[0] : ''}
                    ${b.creator ? ' | <i class="fas fa-user"></i> ' + b.creator : ''}
                </small>
            </div>
        `;
        });
        html += '</div>';

        container.innerHTML = html;
    }

    // ä¸Šä¼ è¯åº“
    async function uploadBook() {
        const title = document.getElementById('bookTitle').value.trim();
        const description = document.getElementById('bookDescription').value.trim();
        const fileInput = document.getElementById('bookFile');

        if (!title) {
            alert('è¯·è¾“å…¥è¯åº“åç§°');
            return;
        }
        if (!fileInput.files.length) {
            alert('è¯·é€‰æ‹©Excelæ–‡ä»¶');
            return;
        }

        const formData = new FormData();
        formData.append('title', title);
        formData.append('description', description);
        formData.append('file', fileInput.files[0]);

        // Show progress
        document.getElementById('uploadBookForm').style.display = 'none';
        document.getElementById('uploadProgress').style.display = 'block';

        try {
            const response = await fetch('/api/dictation/books', {
                method: 'POST',
                credentials: 'include',
                body: formData
            });
            const data = await response.json();

            if (data.ok) {
                alert(`æˆåŠŸåˆ›å»ºè¯åº“ï¼å…± ${data.book.word_count} ä¸ªå•è¯`);
                $('#uploadBookModal').modal('hide');
                loadDictationBooks();
                // Reset form
                document.getElementById('uploadBookForm').reset();
            } else {
                alert('ä¸Šä¼ å¤±è´¥ï¼š' + (data.message || data.error));
            }
        } catch (err) {
            alert('ç½‘ç»œé”™è¯¯ï¼š' + err.message);
        } finally {
            document.getElementById('uploadBookForm').style.display = 'block';
            document.getElementById('uploadProgress').style.display = 'none';
        }
    }

    // æŸ¥çœ‹è¯åº“
    function viewDictationBook(id) {
        // TODO: Implement view page
        alert('è¯åº“è¯¦æƒ…é¡µé¢å¼€å‘ä¸­...');
    }

    // ä»è¯åº“åˆ›å»ºä»»åŠ¡
    function createDictationTask(id) {
        window.location.href = `/tasks/create?dictation_book_id=${id}`;
    }

    // åˆ é™¤è¯åº“
    async function deleteDictationBook(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯åº“å—ï¼Ÿç›¸å…³éŸ³é¢‘ä¹Ÿä¼šè¢«åˆ é™¤ã€‚')) return;

        try {
            const response = await fetch(`/api/dictation/books/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            const data = await response.json();

            if (data.ok) {
                alert('åˆ é™¤æˆåŠŸï¼');
                loadDictationBooks();
            } else {
                showError('åˆ é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            showError('ç½‘ç»œé”™è¯¯ï¼š' + err.message);
        }
    }

    // æ¸²æŸ“ææ–™åˆ—è¡¨
    function renderMaterials(materials) {
        const container = document.getElementById('materialsList');

        if (materials.length === 0) {
            container.innerHTML = `
            <div class="text-center py-5 text-muted">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>æš‚æ— ææ–™</p>
            </div>
        `;
            return;
        }

        const typeLabels = {
            'grammar': 'è¯­æ³•',
            'translation': 'ç¿»è¯‘',
            'speaking': 'å£è¯­',
            'writing': 'å†™ä½œ'
        };

        const typeColors = {
            'grammar': 'primary',
            'translation': 'success',
            'speaking': 'warning',
            'writing': 'info'
        };

        let html = '<div class="list-group">';
        materials.forEach(m => {
            html += `
            <div class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">
                        <span class="badge badge-${typeColors[m.type] || 'secondary'} mr-2">
                            ${typeLabels[m.type] || m.type}
                        </span>
                        ${m.title}
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewMaterial(${m.id})">
                            <i class="fas fa-eye"></i> æŸ¥çœ‹
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="createTaskFromMaterial(${m.id})">
                            <i class="fas fa-paper-plane"></i> å‘å¸ƒä»»åŠ¡
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editMaterial(${m.id})">
                            <i class="fas fa-edit"></i> ç¼–è¾‘
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMaterial(${m.id})">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                    </div>
                </div>
                <p class="mb-1 text-muted">${m.description || 'æš‚æ— è¯´æ˜'}</p>
                <small>
                    <i class="fas fa-list-ol"></i> ${m.question_count} é¢˜ | 
                    <i class="fas fa-calendar"></i> ${m.created_at}
                </small>
            </div>
        `;
        });
        html += '</div>';

        container.innerHTML = html;
    }

    // ç­›é€‰ææ–™
    function filterMaterials() {
        loadMaterials();
    }

    // æŸ¥çœ‹ææ–™è¯¦æƒ…
    function viewMaterial(id) {
        window.location.href = `/materials/${id}`;
    }

    // ç¼–è¾‘ææ–™
    function editMaterial(id) {
        window.location.href = `/materials/${id}/edit`;
    }

    // ä»ææ–™åˆ›å»ºä»»åŠ¡
    function createTaskFromMaterial(id) {
        window.location.href = `/tasks/create?material_id=${id}`;
    }

    // åˆ é™¤ææ–™
    async function deleteMaterial(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä»½ææ–™å—ï¼Ÿ')) return;

        try {
            const response = await fetch(`/api/materials/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            const data = await response.json();

            if (data.ok) {
                alert('åˆ é™¤æˆåŠŸï¼');
                loadMaterials();
            } else {
                showError('åˆ é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            showError('ç½‘ç»œé”™è¯¯ï¼š' + err.message);
        }
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message) {
        alert(message);
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function () {
        loadMaterials();

        // Load dictation books when tab is clicked
        document.getElementById('dictation-tab').addEventListener('click', function () {
            loadDictationBooks();
        });
    });
</script>

<style>
    .list-group-item {
        transition: all 0.2s;
    }

    .list-group-item:hover {
        background-color: #f8f9fa;
        transform: translateX(5px);
    }

    .nav-tabs .nav-link {
        font-weight: 500;
    }

    .nav-tabs .nav-link.active {
        background-color: #fff;
        border-bottom-color: #fff;
    }
</style>
{% endblock %}