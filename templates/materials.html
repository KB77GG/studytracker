{% extends "base.html" %}

{% block title %}ææ–™åº“ç®¡ç†{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">ğŸ“š ææ–™åº“ç®¡ç†</h4>
                    <button class="btn btn-primary" onclick="window.location.href='/materials/create'">
                        <i class="fas fa-plus"></i> åˆ›å»ºæ–°ææ–™
                    </button>
                </div>
                <div class="card-body">
                    <!-- ç­›é€‰æ  -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select class="form-control" id="typeFilter" onchange="filterMaterials()">
                                <option value="">å…¨éƒ¨ç±»å‹</option>
                                <option value="grammar">è¯­æ³•ç»ƒä¹ </option>
                                <option value="translation">ç¿»è¯‘ç»ƒä¹ </option>
                                <option value="speaking">å£è¯­æœ—è¯»</option>
                                <option value="writing">å†™ä½œè®­ç»ƒ</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="searchInput" placeholder="æœç´¢ææ–™æ ‡é¢˜..."
                                onkeyup="filterMaterials()">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-secondary btn-block" onclick="loadMaterials()">
                                <i class="fas fa-sync"></i> åˆ·æ–°
                            </button>
                        </div>
                    </div>

                    <!-- ææ–™åˆ—è¡¨ -->
                    <div id="materialsList">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let allMaterials = [];

    // åŠ è½½ææ–™åˆ—è¡¨
    async function loadMaterials() {
        const typeFilter = document.getElementById('typeFilter').value;
        const searchInput = document.getElementById('searchInput').value;

        try {
            let url = '/api/materials?';
            if (typeFilter) url += `type=${typeFilter}&`;
            if (searchInput) url += `search=${encodeURIComponent(searchInput)}`;

            const response = await fetch(url);
            const data = await response.json();

            if (data.ok) {
                allMaterials = data.materials;
                renderMaterials(allMaterials);
            } else {
                showError('åŠ è½½å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            showError('ç½‘ç»œé”™è¯¯ï¼š' + err.message);
        }
    }

    // æ¸²æŸ“ææ–™åˆ—è¡¨
    function renderMaterials(materials) {
        const container = document.getElementById('materialsList');

        if (materials.length === 0) {
            container.innerHTML = `
            <div class="text-center py-5 text-muted">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>æš‚æ— ææ–™</p>
            </div>
        `;
            return;
        }

        const typeLabels = {
            'grammar': 'è¯­æ³•',
            'translation': 'ç¿»è¯‘',
            'speaking': 'å£è¯­',
            'writing': 'å†™ä½œ'
        };

        const typeColors = {
            'grammar': 'primary',
            'translation': 'success',
            'speaking': 'warning',
            'writing': 'info'
        };

        let html = '<div class="list-group">';
        materials.forEach(m => {
            html += `
            <div class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">
                        <span class="badge badge-${typeColors[m.type] || 'secondary'} mr-2">
                            ${typeLabels[m.type] || m.type}
                        </span>
                        ${m.title}
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewMaterial(${m.id})">
                            <i class="fas fa-eye"></i> æŸ¥çœ‹
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="createTaskFromMaterial(${m.id})">
                            <i class="fas fa-paper-plane"></i> å‘å¸ƒä»»åŠ¡
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editMaterial(${m.id})">
                            <i class="fas fa-edit"></i> ç¼–è¾‘
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMaterial(${m.id})">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                    </div>
                </div>
                <p class="mb-1 text-muted">${m.description || 'æš‚æ— è¯´æ˜'}</p>
                <small>
                    <i class="fas fa-list-ol"></i> ${m.question_count} é¢˜ | 
                    <i class="fas fa-calendar"></i> ${m.created_at}
                </small>
            </div>
        `;
        });
        html += '</div>';

        container.innerHTML = html;
    }

    // ç­›é€‰ææ–™
    function filterMaterials() {
        loadMaterials();
    }

    // æŸ¥çœ‹ææ–™è¯¦æƒ…
    function viewMaterial(id) {
        window.location.href = `/materials/${id}`;
    }

    // ç¼–è¾‘ææ–™
    function editMaterial(id) {
        window.location.href = `/materials/${id}/edit`;
    }

    // ä»ææ–™åˆ›å»ºä»»åŠ¡
    function createTaskFromMaterial(id) {
        window.location.href = `/tasks/create?material_id=${id}`;
    }

    // åˆ é™¤ææ–™
    async function deleteMaterial(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä»½ææ–™å—ï¼Ÿ')) return;

        try {
            const response = await fetch(`/api/materials/${id}`, {
                method: 'DELETE'
            });
            const data = await response.json();

            if (data.ok) {
                alert('åˆ é™¤æˆåŠŸï¼');
                loadMaterials();
            } else {
                showError('åˆ é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            showError('ç½‘ç»œé”™è¯¯ï¼š' + err.message);
        }
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message) {
        alert(message);
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function () {
        loadMaterials();
    });
</script>

<style>
    .list-group-item {
        transition: all 0.2s;
    }

    .list-group-item:hover {
        background-color: #f8f9fa;
        transform: translateX(5px);
    }
</style>
{% endblock %}