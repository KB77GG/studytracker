{% extends "base.html" %}
{% block content %}{% endblock %}
{% block content_dashboard %}
{% set evidence_policy_labels = {
'text': '文字稿',
'image': '截图/照片',
'audio': '音频',
'required': '需上传证据',
'optional': '可选'
} %}
<h2>教师工作台</h2>

<div class="teacher-toolbar">
  <form method="get" class="date-picker">
    <label for="planDate">查看日期</label>
    <input id="planDate" type="date" name="date" value="{{ selected_date }}">
    <button type="submit">跳转</button>
  </form>
</div>

<div class="teacher-grid">
  <section class="card plan-builder">
    <h3>创建 / 更新计划</h3>
    {% if students %}
    <form id="planForm">
      <div class="form-row">
        <label>学生</label>
        <select id="planStudent" name="student_id" required>
          <option value="">请选择学生</option>
          {% for stu in students %}
          <option value="{{ stu.id }}">{{ stu.full_name }}{% if stu.nickname %}（{{ stu.nickname }}）{% endif %}</option>
          {% endfor %}
        </select>
      </div>
      <div class="guardian-token" id="guardianTokenBox" hidden>
        <span class="token-label">家长查看链接：</span>
        <input type="text" readonly id="guardianTokenValue">
        <div class="token-actions">
          <button type="button" id="copyTokenBtn">复制链接</button>
          <button type="button" id="refreshTokenBtn">刷新链接</button>
        </div>
      </div>
      <div class="form-row">
        <label>计划日期</label>
        <input type="date" id="planDateInput" name="plan_date" value="{{ selected_date }}" required>
      </div>
      <div class="form-row">
        <label>备注</label>
        <textarea id="planNotes" name="notes" rows="2" placeholder="可选：写给学生的提示或重点"></textarea>
      </div>
      <div class="form-row check-row">
        <label>
          <input type="checkbox" id="planReplace" name="replace">
          若已有计划，覆盖并重新生成
        </label>
      </div>
      <hr>
      <div class="plan-builder-catalog">
        <div class="catalog-panel">
          <h4>任务库</h4>
          <input type="search" id="taskSearch" placeholder="搜索：考试体系 / 模块 / 任务名">
          <div class="catalog-list" id="catalogList">
            <!-- filled by JS -->
          </div>
        </div>
        <div class="selected-panel">
          <h4>计划任务</h4>
          <p class="muted">点击任务库中的“添加”按钮即可加入。可在此调整顺序、时长或说明。</p>
          <ul id="selectedTasks" class="selected-list">
            <!-- filled by JS -->
          </ul>
          <div class="selected-summary" id="selectedSummary">共 0 项，计划用时 0 分钟</div>
        </div>
      </div>
      <div class="form-actions">
        <button type="submit">保存计划</button>
      </div>
    </form>
    {% else %}
    <p>当前没有可管理的学生，请先在用户管理中设置学生档案并关联教师。</p>
    {% endif %}
  </section>

  <section class="card pending-review">
    <h3>待审核提交</h3>
    {% if pending_items %}
    <div class="pending-list">
      {% for item in pending_items %}
      <article class="pending-item" data-item-id="{{ item.id }}">
        <header>
          <strong>{{ item.plan.student.full_name }}</strong>
          <span class="muted">{{ item.plan.plan_date }}</span>
        </header>
        <div class="pending-body">
          <div class="pending-task">{{ item.module }} · {{ item.task_name }}</div>
          {% if item.custom_title %}<div class="muted">备注：{{ item.custom_title }}</div>{% endif %}
          {% if item.instructions %}<div class="muted">目标说明：{{ item.instructions }}</div>{% endif %}
          <div class="pending-meta">
            计划 {{ item.planned_minutes }} 分 ｜ 实际 {{ (item.actual_seconds or 0) // 60 }} 分
            {% if item.manual_minutes %}（手动填写 {{ item.manual_minutes }} 分）{% endif %}
          </div>
          <div class="muted small">证据要求：{{ evidence_policy_labels.get(item.evidence_policy or 'optional', '可选') }}</div>
          {% if item.student_reset_count %}
          <div class="muted small">学生曾撤回 {{ item.student_reset_count }} 次</div>
          {% endif %}
          {% if item.student_comment %}
          <div class="pending-comment">学生反馈：{{ item.student_comment }}</div>
          {% endif %}
          {% set evidences = item.evidences | selectattr("is_deleted", "equalto", False) | list %}
          {% if evidences %}
          <ul class="pending-evidence">
            {% for ev in evidences %}
            <li>
              {% if ev.file_type == 'text' %}
              文字稿 {{ loop.index }}：{{ ev.text_content or '（无内容）' }}
              {% else %}
              证据 {{ loop.index }} · {{ ev.file_type|upper }}
              <a href="{{ url_for('teacher_download_evidence', evidence_id=ev.id) }}" target="_blank"
                rel="noopener">下载</a>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="muted">无证据文件</div>
          {% endif %}
        </div>
        <footer>
          <textarea class="review-comment" placeholder="评语（可选）"></textarea>
          <div class="review-actions">
            <button type="button" class="btn-review" data-status="approved">通过</button>
            <button type="button" class="btn-review" data-status="partial">部分完成</button>
            <button type="button" class="btn-review" data-status="rejected">未完成</button>
          </div>
        </footer>
      </article>
      {% endfor %}
    </div>
    {% else %}
    <p class="muted">暂无待审核任务。</p>
    {% endif %}
  </section>
</div>

<section class="card plan-overview">
  <h3>当天计划概览</h3>
  {% if plans %}
  {% for plan in plans %}
  <article class="plan-card">
    <header>
      <div>
        <strong>{{ plan.student.full_name }}</strong>
        <span class="muted">（{{ plan.plan_date }}）</span>
      </div>
      {% if plan.notes %}
      <div class="plan-notes">{{ plan.notes }}</div>
      {% endif %}
    </header>
    <table class="plan-table">
      <thead>
        <tr>
          <th>#</th>
          <th>任务</th>
          <th>计划</th>
          <th>实际</th>
          <th>学生状态</th>
          <th>审核状态</th>
          <th>证据</th>
        </tr>
      </thead>
      <tbody>
        {% for item in plan.items | selectattr("is_deleted", "equalto", False) | list %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>
            <div>{{ item.module }} · {{ item.task_name }}</div>
            {% if item.custom_title %}<div class="muted">{{ item.custom_title }}</div>{% endif %}
            {% if item.instructions %}<div class="muted">{{ item.instructions }}</div>{% endif %}
            <div class="muted small">证据要求：{{ evidence_policy_labels.get(item.evidence_policy or 'optional', '可选') }}
            </div>
          </td>
          <td>{{ item.planned_minutes }} 分</td>
          <td>{{ (item.actual_seconds or 0) // 60 }} 分{% if item.manual_minutes %}（手动 {{ item.manual_minutes }} 分）{%
            endif %}</td>
          <td>
            {% if item.student_status == item.STUDENT_SUBMITTED %}
            <span class="badge status-done">已提交</span>
            {% elif item.student_status == item.STUDENT_IN_PROGRESS %}
            <span class="badge status-progress">进行中</span>
            {% else %}
            <span class="badge status-pending">未开始</span>
            {% endif %}
            {% if item.student_reset_count %}
            <div class="muted small">已撤回 {{ item.student_reset_count }} 次</div>
            {% endif %}
          </td>
          <td>
            {% if item.review_status == item.REVIEW_APPROVED %}
            <span class="badge status-done">通过</span>
            {% elif item.review_status == item.REVIEW_PARTIAL %}
            <span class="badge status-progress">部分</span>
            {% elif item.review_status == item.REVIEW_REJECTED %}
            <span class="badge status-pending">未完成</span>
            {% else %}
            <span class="badge status-pending">待审核</span>
            {% endif %}
            {% if item.review_comment %}
            <div class="muted small">评语：{{ item.review_comment }}</div>
            {% endif %}
          </td>
          <td>
            {% set evidences = item.evidences | selectattr("is_deleted", "equalto", False) | list %}
            {% if evidences %}
            <ul class="evidence-list">
              {% for ev in evidences %}
              <li>
                {% if ev.file_type == 'text' %}
                文字稿：{{ ev.text_content or '（无内容）' }}
                {% else %}
                <a href="{{ url_for('teacher_download_evidence', evidence_id=ev.id) }}" target="_blank"
                  rel="noopener">证据 {{ loop.index }}</a>
                {% endif %}
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <span class="muted">无</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </article>
  {% endfor %}
  {% else %}
  <p class="muted">该日暂无计划。</p>
  {% endif %}
</section>

<script>
  const catalogData = {{ catalog_payload| tojson }};
  const studentsPayload = {{ students_payload| tojson }};
  const tokenMap = {{ token_map| tojson }};

  const catalogListEl = document.getElementById('catalogList');
  const selectedListEl = document.getElementById('selectedTasks');
  const summaryEl = document.getElementById('selectedSummary');
  const planForm = document.getElementById('planForm');
  const planStudent = document.getElementById('planStudent');
  const guardianTokenBox = document.getElementById('guardianTokenBox');
  const guardianTokenValue = document.getElementById('guardianTokenValue');
  const refreshTokenBtn = document.getElementById('refreshTokenBtn');
  const copyTokenBtn = document.getElementById('copyTokenBtn');
  const taskSearch = document.getElementById('taskSearch');

  let selectedItems = [];
  const createUid = () => (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : `uid_${Date.now()}_${Math.random().toString(16).slice(2)}`;

  function renderCatalog(list) {
    catalogListEl.innerHTML = '';
    if (!list.length) {
      catalogListEl.innerHTML = '<p class="muted">没有匹配的任务。</p>';
      return;
    }
    list.forEach(item => {
      const el = document.createElement('div');
      el.className = 'catalog-item';
      el.innerHTML = `
      <div class="catalog-info">
        <strong>${item.exam_system} · ${item.module}</strong>
        <div>${item.task_name}</div>
        ${item.description ? `<div class="muted small">${item.description}</div>` : ''}
      </div>
      <button type="button" data-id="${item.id}">添加</button>
    `;
      el.querySelector('button').addEventListener('click', () => addItem(item));
      catalogListEl.appendChild(el);
    });
  }

  function addItem(catalogItem) {
    const newItem = {
      uid: createUid(),
      catalog_id: catalogItem.id,
      exam_system: catalogItem.exam_system,
      module: catalogItem.module,
      task_name: catalogItem.task_name,
      planned_minutes: catalogItem.default_minutes || 30,
      instructions: '',
      custom_title: ''
    };
    selectedItems.push(newItem);
    renderSelected();
  }

  function renderSelected() {
    selectedListEl.innerHTML = '';
    let total = 0;
    selectedItems.forEach((item, index) => {
      total += Number(item.planned_minutes || 0);
      const li = document.createElement('li');
      li.className = 'selected-item';
      li.dataset.uid = item.uid;
      li.innerHTML = `
      <div class="selected-header">
        <span>${index + 1}. ${item.exam_system} · ${item.module}</span>
        <strong>${item.task_name}</strong>
      </div>
      <div class="selected-controls">
        <label>计划分钟
          <input type="number" min="0" value="${item.planned_minutes}">
        </label>
        <label>自定义标题
          <input type="text" value="${item.custom_title || ''}">
        </label>
        <label>说明
          <input type="text" value="${item.instructions || ''}">
        </label>
      </div>
      <div class="selected-actions">
        <button type="button" data-action="up">上移</button>
        <button type="button" data-action="down">下移</button>
        <button type="button" data-action="remove" class="danger">删除</button>
      </div>
    `;
      const [minutesInput, titleInput, instructionsInput] = li.querySelectorAll('input');
      minutesInput.addEventListener('change', e => {
        const val = Number(e.target.value || 0);
        item.planned_minutes = val >= 0 ? val : 0;
        renderSelected();
      });
      titleInput.addEventListener('input', e => item.custom_title = e.target.value.trim());
      instructionsInput.addEventListener('input', e => item.instructions = e.target.value.trim());
      li.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => handleSelectedAction(item.uid, btn.dataset.action));
      });
      selectedListEl.appendChild(li);
    });
    summaryEl.textContent = `共 ${selectedItems.length} 项，计划用时 ${total} 分钟`;
  }

  function handleSelectedAction(uid, action) {
    const idx = selectedItems.findIndex(it => it.uid === uid);
    if (idx === -1) return;
    if (action === 'remove') {
      selectedItems.splice(idx, 1);
    } else if (action === 'up' && idx > 0) {
      [selectedItems[idx - 1], selectedItems[idx]] = [selectedItems[idx], selectedItems[idx - 1]];
    } else if (action === 'down' && idx < selectedItems.length - 1) {
      [selectedItems[idx + 1], selectedItems[idx]] = [selectedItems[idx], selectedItems[idx + 1]];
    }
    renderSelected();
  }

  function filterCatalog() {
    const keyword = (taskSearch.value || '').toLowerCase().trim();
    if (!keyword) {
      renderCatalog(catalogData);
      return;
    }
    const filtered = catalogData.filter(item =>
      [item.exam_system, item.module, item.task_name, item.description]
        .join(' ')
        .toLowerCase()
        .includes(keyword)
    );
    renderCatalog(filtered);
  }

  if (taskSearch) {
    taskSearch.addEventListener('input', () => {
      window.clearTimeout(taskSearch._timer);
      taskSearch._timer = setTimeout(filterCatalog, 150);
    });
  }

  if (planForm) {
    planForm.addEventListener('submit', async e => {
      e.preventDefault();
      if (!selectedItems.length) {
        alert('请先从任务库中添加至少一项任务。');
        return;
      }
      const studentId = planStudent.value;
      if (!studentId) {
        alert('请选择学生。');
        return;
      }
      const payload = {
        student_id: studentId,
        plan_date: document.getElementById('planDateInput').value,
        notes: document.getElementById('planNotes').value.trim(),
        replace: document.getElementById('planReplace').checked,
        items: selectedItems.map(item => ({
          catalog_id: item.catalog_id,
          planned_minutes: item.planned_minutes,
          instructions: item.instructions,
          custom_title: item.custom_title
        }))
      };
      try {
        const res = await fetch('/api/plans', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!data.ok) {
          alert('保存失败：' + (data.error || 'unknown'));
          return;
        }
        window.location.reload();
      } catch (err) {
        console.error(err);
        alert('保存失败，请稍后再试。');
      }
    });
  }

  function updateGuardianTokenDisplay(studentId) {
    const info = studentsPayload.find(x => String(x.id) === String(studentId));
    if (!info) {
      guardianTokenBox.hidden = true;
      return;
    }
    const baseUrl = window.location.origin;
    const token = info.token;
    if (token) {
      guardianTokenValue.value = `${baseUrl}/parent/report/${token}`;
    } else {
      guardianTokenValue.value = '尚未生成链接';
    }
    guardianTokenBox.hidden = false;
  }

  if (planStudent) {
    planStudent.addEventListener('change', () => {
      updateGuardianTokenDisplay(planStudent.value);
    });
  }

  if (copyTokenBtn) {
    copyTokenBtn.addEventListener('click', () => {
      if (!guardianTokenValue.value) {
        alert('暂无可复制的链接');
        return;
      }
      navigator.clipboard.writeText(guardianTokenValue.value).then(() => {
        copyTokenBtn.textContent = '已复制';
        setTimeout(() => copyTokenBtn.textContent = '复制链接', 1500);
      });
    });
  }

  if (refreshTokenBtn) {
    refreshTokenBtn.addEventListener('click', async () => {
      const studentId = planStudent.value;
      if (!studentId) {
        alert('请先选择学生');
        return;
      }
      try {
        const res = await fetch(`/api/students/${studentId}/guardian-token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'refresh' })
        });
        const data = await res.json();
        if (!data.ok) {
          alert('生成失败：' + (data.error || 'unknown'));
          return;
        }
        const target = studentsPayload.find(x => String(x.id) === String(studentId));
        if (target) {
          target.token = data.token;
        }
        guardianTokenValue.value = `${window.location.origin}/parent/report/${data.token}`;
      } catch (err) {
        console.error(err);
        alert('生成失败，请稍后再试。');
      }
    });
  }

  document.querySelectorAll('.pending-item .btn-review').forEach(btn => {
    btn.addEventListener('click', async () => {
      const container = btn.closest('.pending-item');
      const comment = container.querySelector('.review-comment').value.trim();
      const itemId = container.dataset.itemId;
      const status = btn.dataset.status;
      btn.disabled = true;
      try {
        const res = await fetch(`/api/plan-items/${itemId}/review`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status, comment })
        });
        const data = await res.json();
        if (!data.ok) {
          alert('审核失败：' + (data.error || 'unknown'));
          btn.disabled = false;
          return;
        }
        container.classList.add('reviewed');
        container.querySelectorAll('button').forEach(b => b.disabled = true);
        container.querySelector('.review-actions').innerHTML = `<span class="muted">已提交：${status}</span>`;
      } catch (err) {
        console.error(err);
        alert('审核失败，请稍后再试。');
        btn.disabled = false;
      }
    });
  });

  renderCatalog(catalogData);
  renderSelected();
  {% if students %}
  updateGuardianTokenDisplay(planStudent.value);
  {% endif %}
</script>
{% endblock %}