{% extends "base.html" %}

{% block page_title %}ä½œä¸šè¯¦æƒ…ä¸æ‰¹æ”¹{% endblock %}
{% block page_subtitle %}Grading / {{ task.student_name }}{% endblock %}

{% block header_actions %}
<a href="{{ url_for('grading_list') }}" class="btn btn-outline">è¿”å›åˆ—è¡¨</a>
{% endblock %}

{% block content_dashboard %}
<div class="grid-layout">
    <!-- Left Column: Student Submission -->
    <div class="submission-panel">
        <div class="card">
            <div class="card-header">
                <h3>å­¦ç”Ÿæäº¤å†…å®¹</h3>
                <span class="text-muted">{{ task.submitted_at.strftime('%Y-%m-%d %H:%M') if task.submitted_at else ''
                    }}</span>
            </div>
            <div class="card-body">
                <!-- Task Info -->
                <div class="info-group">
                    <label>ä»»åŠ¡æè¿°</label>
                    <p class="info-text">{{ task.detail }}</p>
                </div>

                <!-- Student Note -->
                {% if task.student_note %}
                <div class="info-group">
                    <label>å­¦ç”Ÿç•™è¨€</label>
                    <div class="student-note-box">
                        {{ task.student_note }}
                    </div>
                </div>
                {% endif %}

                <!-- Evidence: Photos -->
                {% if evidence_photos %}
                <div class="info-group">
                    <label>å›¾ç‰‡è¯æ®</label>
                    <div class="evidence-grid">
                        {% for photo in evidence_photos %}
                        <div class="evidence-item">
                            <a href="{{ photo }}" target="_blank">
                                <img src="{{ photo }}" alt="Evidence">
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Evidence: Audio (if any, usually in feedback_audio for now or separate field?) -->
                <!-- Note: Current Task model stores audio in feedback_audio? No, that's teacher feedback. 
             Student audio might be in evidence_photos (as mp3 url) or we need to check how it's stored.
             Based on miniprogram.py, audio is stored in PlanEvidence table for PlanItem, 
             but for Task it seems mixed in evidence_photos or not explicitly handled?
             Let's assume evidence_photos might contain audio urls too, or we check file extension.
        -->
            </div>
        </div>
    </div>

    <!-- Right Column: Grading Form -->
    <div class="grading-panel">
        <div class="card">
            <div class="card-header">
                <h3>è¯„åˆ†ä¸åé¦ˆ</h3>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('grading_submit', task_id=task.id) }}">

                    <!-- Score / Accuracy -->
                    <div class="form-group">
                        <label for="accuracy">æ­£ç¡®ç‡ / å¾—åˆ† (%)</label>
                        <div class="input-group">
                            <input type="number" id="accuracy" name="accuracy" class="form-control"
                                value="{{ task.accuracy or '' }}" step="0.5" min="0" max="100">
                            <span class="input-suffix">%</span>
                        </div>
                        <small class="form-text text-muted">å¯¹äºå®Œæˆç±»ä»»åŠ¡ï¼Œå¯ç›´æ¥å¡« 100</small>
                    </div>

                    <!-- Completion Rate -->
                    <div class="form-group">
                        <label for="completion_rate">å®Œæˆåº¦ (%)</label>
                        <div class="input-group">
                            <input type="number" id="completion_rate" name="completion_rate" class="form-control"
                                value="{{ task.completion_rate or 100 }}" step="1" min="0" max="100">
                            <span class="input-suffix">%</span>
                        </div>
                    </div>

                    <!-- Feedback Text -->
                    <div class="form-group">
                        <label for="feedback_text">æ•™å¸ˆè¯„è¯­</label>
                        <textarea id="feedback_text" name="feedback_text" class="form-control" rows="6"
                            placeholder="è¯·è¾“å…¥è¯¦ç»†çš„åé¦ˆæ„è§...">{{ task.feedback_text or '' }}</textarea>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <button type="button" class="btn btn-xs btn-outline" onclick="insertFeedback('åšå¾—å¾ˆå¥½ï¼ç»§ç»­ä¿æŒã€‚')">ğŸ‘
                            åšå¾—å¾ˆå¥½</button>
                        <button type="button" class="btn btn-xs btn-outline"
                            onclick="insertFeedback('æ³¨æ„å•è¯æ‹¼å†™ï¼Œä¸‹æ¬¡ç»†å¿ƒä¸€ç‚¹ã€‚')">ğŸ“ æ³¨æ„æ‹¼å†™</button>
                        <button type="button" class="btn btn-xs btn-outline" onclick="insertFeedback('å‘éŸ³å¾ˆæ¸…æ™°ï¼Œè¯­è°ƒè‡ªç„¶ã€‚')">ğŸ¤
                            å‘éŸ³æ¸…æ™°</button>
                    </div>

                    <div class="form-actions mt-4">
                        <button type="submit" class="btn btn-primary btn-block">æäº¤è¯„åˆ†</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function insertFeedback(text) {
        const textarea = document.getElementById('feedback_text');
        textarea.value += (textarea.value ? '\n' : '') + text;
    }
</script>

<style>
    .grid-layout {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 20px;
    }

    @media (max-width: 768px) {
        .grid-layout {
            grid-template-columns: 1fr;
        }
    }

    .student-note-box {
        background: #f8fafc;
        padding: 10px;
        border-radius: 4px;
        border-left: 3px solid #64748b;
        color: #334155;
    }

    .evidence-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
    }

    .evidence-item img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #e2e8f0;
        cursor: zoom-in;
    }

    .quick-actions {
        margin-top: 10px;
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }

    .input-group {
        display: flex;
        align-items: center;
    }

    .input-suffix {
        padding: 0 10px;
        background: #f1f5f9;
        border: 1px solid #cbd5e1;
        border-left: none;
        height: 38px;
        /* Match input height */
        display: flex;
        align-items: center;
        border-radius: 0 4px 4px 0;
    }

    .input-group .form-control {
        border-radius: 4px 0 0 4px;
    }
</style>
{% endblock %}