{% extends "base.html" %}

{% block title %}{{ 'ç¼–è¾‘' if material else 'åˆ›å»º' }}ææ–™{% endblock %}

{% block content_dashboard %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">{{ 'ğŸ“ ç¼–è¾‘ææ–™' if material else 'â• åˆ›å»ºæ–°ææ–™' }}</h4>
                </div>
                <div class="card-body">
                    <form id="materialForm">
                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>æ ‡é¢˜ *</label>
                                    <input type="text" class="form-control" id="title" required
                                        value="{{ material.title if material else '' }}"
                                        placeholder="ä¾‹å¦‚ï¼šä¸»è°“ä¸€è‡´-either/orç»“æ„">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>ç±»å‹ *</label>
                                    <select class="form-control" id="type" required onchange="handleTypeChange()">
                                        <option value="">é€‰æ‹©ç±»å‹</option>
                                        <option value="grammar" {{ 'selected' if material and material.type=='grammar'
                                            else '' }}>è¯­æ³•ç»ƒä¹ </option>
                                        <option value="writing_logic" {{ 'selected' if material and
                                            material.type=='writing_logic' else '' }}>å†™ä½œé€»è¾‘é“¾è®­ç»ƒ</option>
                                        <option value="speaking_reading" {{ 'selected' if material and
                                            material.type=='speaking_reading' else '' }}>å£è¯­æœ—è¯»ææ–™</option>
                                        <option value="speaking_part1" {{ 'selected' if material and
                                            material.type=='speaking_part1' else '' }}>å£è¯­é¢˜åº“Part1</option>
                                        <option value="speaking_part2" {{ 'selected' if material and
                                            material.type=='speaking_part2' else '' }}>å£è¯­é¢˜åº“Part2</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>çŸ¥è¯†ç‚¹è¯´æ˜</label>
                            <textarea class="form-control" id="description" rows="3"
                                placeholder="ç²˜è´´çŸ¥è¯†ç‚¹è¯´æ˜ï¼ˆå¦‚ï¼šEither...or è¿æ¥ä¸»è¯­æ—¶ï¼Œè°“è¯­åŠ¨è¯ä¸é è¿‘çš„ä¸»è¯­ä¿æŒä¸€è‡´...ï¼‰">{{ material.description if material else '' }}</textarea>
                        </div>

                        <hr>

                        <!-- Grammar (è¯­æ³•ç»ƒä¹ ) - Original import method -->
                        <div id="grammarInput" style="display: none;">
                            <div class="form-group">
                                <label class="font-weight-bold">é¢˜ç›®å¯¼å…¥æ–¹å¼</label>
                                <div class="btn-group d-block" role="group">
                                    <button type="button" class="btn btn-outline-primary" onclick="showTab('paste')">
                                        <i class="fas fa-clipboard"></i> ä»Wordå¤åˆ¶ç²˜è´´
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="showTab('manual')">
                                        <i class="fas fa-keyboard"></i> æ‰‹åŠ¨æ·»åŠ 
                                    </button>
                                </div>
                            </div>

                            <div id="pasteTab" style="display: block;">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5>æ­¥éª¤1ï¼šç²˜è´´é¢˜ç›®</h5>
                                        <textarea class="form-control mb-3" id="pastedQuestions" rows="15"
                                            placeholder="ç²˜è´´Wordé¢˜ç›®å†…å®¹ï¼Œä¾‹å¦‚ï¼š&#10;&#10;1. Either the mayor or the council members ___ expected...&#10;   A. is&#10;   B. are&#10;   C. was&#10;   D. be&#10;&#10;2. Neither the students nor the teacher ___ ready.&#10;   A. is&#10;   B. are&#10;   ..."></textarea>
                                        <button type="button" class="btn btn-success" onclick="parseQuestions()">
                                            <i class="fas fa-lightbulb"></i> æ™ºèƒ½è¯†åˆ«é¢˜ç›®
                                        </button>

                                        <hr>

                                        <h5>æ­¥éª¤2ï¼šç²˜è´´ç­”æ¡ˆ</h5>
                                        <textarea class="form-control mb-3" id="pastedAnswers" rows="8"
                                            placeholder="ç²˜è´´ç­”æ¡ˆåˆ—è¡¨ï¼Œä¾‹å¦‚ï¼š&#10;&#10;1. B&#10;2. A&#10;3. C&#10;..."></textarea>
                                        <button type="button" class="btn btn-success" onclick="parseAnswers()">
                                            <i class="fas fa-check"></i> åŒ¹é…ç­”æ¡ˆ
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div id="manualTab" style="display: none;">
                                <button type="button" class="btn btn-primary mb-3" onclick="addQuestion()">
                                    <i class="fas fa-plus"></i> æ·»åŠ é¢˜ç›®
                                </button>
                            </div>
                        </div>

                        <!-- Writing Logic (å†™ä½œé€»è¾‘é“¾è®­ç»ƒ) -->
                        <div id="writingLogicInput" style="display: none;">
                            <div class="form-group">
                                <label class="font-weight-bold">å®Œæ•´èŒƒæ–‡</label>
                                <textarea class="form-control" id="essayFull" rows="10"
                                    placeholder="ç²˜è´´å®Œæ•´èŒƒæ–‡ï¼ˆParagraph 1-4ï¼‰..."></textarea>
                            </div>

                            <div class="form-group">
                                <label class="font-weight-bold">å¡«ç©ºç‰ˆï¼ˆå¸¦æ ‡ç­¾ï¼‰</label>
                                <textarea class="form-control" id="essayBlank" rows="10"
                                    placeholder="ç²˜è´´å¡«ç©ºç‰ˆæœ¬ï¼Œä¾‹å¦‚ï¼š&#10;ã€èƒŒæ™¯ã€‘Remote work has expanded due to __________ and global health crises.&#10;ã€ç«‹åœºã€‘I believe this is a largely __________ development..."></textarea>
                            </div>

                            <div class="form-group">
                                <label class="font-weight-bold">ç­”æ¡ˆåˆ—è¡¨ï¼ˆç”¨ / åˆ†éš”ï¼‰</label>
                                <textarea class="form-control" id="essayAnswers" rows="3"
                                    placeholder="digital technology / positive / workâ€“life balance / productivity / environment / ..."></textarea>
                            </div>
                        </div>

                        <!-- Speaking Reading (å£è¯­æœ—è¯»ææ–™) -->
                        <div id="speakingReadingInput" style="display: none;">
                            <div class="form-group">
                                <label class="font-weight-bold">è¯æ±‡è¡¨è¾¾</label>
                                <textarea class="form-control" id="vocabulary" rows="6"
                                    placeholder="ç²˜è´´è¯æ±‡è¡¨è¾¾ï¼Œä¾‹å¦‚ï¼š&#10;Â· be into / be fond of / be crazy about â†’ å–œæ¬¢&#10;Â· chill out / wind down â†’ æ”¾æ¾&#10;..."></textarea>
                            </div>

                            <div class="form-group">
                                <label class="font-weight-bold">å¥å‹è¡¨è¾¾</label>
                                <textarea class="form-control" id="sentencePatterns" rows="6"
                                    placeholder="ç²˜è´´å¥å‹è¡¨è¾¾ï¼Œä¾‹å¦‚ï¼š&#10;Â· One of my biggest hobbies isâ€¦, because it helps me toâ€¦&#10;Â· Whenever I feel stressed, I usuallyâ€¦&#10;..."></textarea>
                            </div>

                            <div class="form-group">
                                <label class="font-weight-bold">ç¤ºèŒƒæ®µè½</label>
                                <textarea class="form-control" id="sampleParagraph" rows="8"
                                    placeholder="ç²˜è´´ç¤ºèŒƒæ®µè½..."></textarea>
                            </div>
                        </div>

                        <!-- Speaking Part 1 (å£è¯­é¢˜åº“Part1) -->
                        <div id="speakingPart1Input" style="display: none;">
                            <div class="form-group">
                                <label class="font-weight-bold">é—®é¢˜åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªé—®é¢˜ï¼‰</label>
                                <textarea class="form-control" id="part1Questions" rows="10"
                                    placeholder="ç²˜è´´é—®é¢˜åˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªé—®é¢˜ï¼Œä¾‹å¦‚ï¼š&#10;What sort of things do you find difficult to remember?&#10;What do you do when you need to remember something important?&#10;Did you find it easier to remember things when you were a child?&#10;..."></textarea>
                                <small class="form-text text-muted">æç¤ºï¼šæ¯ä¸ªé—®é¢˜ä¼šè¢«æ‹†åˆ†ä¸ºç‹¬ç«‹çš„æ¡ç›®ï¼Œå¯ä»¥å•ç‹¬åˆ†é…ç»™å­¦ç”Ÿ</small>
                            </div>
                        </div>

                        <!-- Speaking Part 2 (å£è¯­é¢˜åº“Part2) -->
                        <div id="speakingPart2Input" style="display: none;">
                            <div class="form-group">
                                <label class="font-weight-bold">è¯é¢˜å¡ç‰‡</label>
                                <textarea class="form-control" id="part2Topic" rows="10"
                                    placeholder="ç²˜è´´è¯é¢˜å¡ç‰‡ï¼Œä¾‹å¦‚ï¼š&#10;Describe an area of science (physics, biology, psychology, etc.) that you are interested in.&#10;You should say:&#10;o What it is&#10;o When you knew it&#10;o How you learnt it&#10;o And explain why you are interested in it"></textarea>
                            </div>
                        </div>

                        <hr>

                        <!-- é¢˜ç›®åˆ—è¡¨é¢„è§ˆ -->
                        <div class="form-group">
                            <label class="font-weight-bold">é¢˜ç›®åˆ—è¡¨ <span id="questionCount"
                                    class="badge badge-info">0</span></label>
                            <div id="questionsList" class="border rounded p-3"
                                style="max-height: 500px; overflow-y: auto;">
                                <p class="text-muted text-center">æš‚æ— é¢˜ç›®</p>
                            </div>
                        </div>

                        <!-- æäº¤æŒ‰é’® -->
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> ä¿å­˜ææ–™
                            </button>
                            <a href="/materials" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times"></i> å–æ¶ˆ
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize questions array (empty for create, pre-filled for edit)
    let questions = [];

    {% if questions_json %}
    // Edit mode: load existing questions
    try {
        questions = {{ questions_json | safe }
    };
    // Render questions immediately after page loads
    document.addEventListener('DOMContentLoaded', function () {
        renderQuestions();
    });
    } catch (e) {
        console.error('Failed to parse questions:', e);
    }
    {% endif %}

    // Handle material type change
    function handleTypeChange() {
        const type = document.getElementById('type').value;

        // Hide all input areas
        document.getElementById('grammarInput').style.display = 'none';
        document.getElementById('writingLogicInput').style.display = 'none';
        document.getElementById('speakingReadingInput').style.display = 'none';
        document.getElementById('speakingPart1Input').style.display = 'none';
        document.getElementById('speakingPart2Input').style.display = 'none';

        // Show the selected type's input area
        if (type === 'grammar') {
            document.getElementById('grammarInput').style.display = 'block';
        } else if (type === 'writing_logic') {
            document.getElementById('writingLogicInput').style.display = 'block';
        } else if (type === 'speaking_reading') {
            document.getElementById('speakingReadingInput').style.display = 'block';
        } else if (type === 'speaking_part1') {
            document.getElementById('speakingPart1Input').style.display = 'block';
        } else if (type === 'speaking_part2') {
            document.getElementById('speakingPart2Input').style.display = 'block';
        }
    }

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function showTab(tab) {
        document.getElementById('pasteTab').style.display = tab === 'paste' ? 'block' : 'none';
        document.getElementById('manualTab').style.display = tab === 'manual' ? 'block' : 'none';
    }

    // æ™ºèƒ½è¯†åˆ«é¢˜ç›®
    async function parseQuestions() {
        const text = document.getElementById('pastedQuestions').value.trim();
        if (!text) {
            alert('è¯·å…ˆç²˜è´´é¢˜ç›®å†…å®¹');
            return;
        }

        try {
            const response = await fetch('/api/materials/parse', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text }),
                credentials: 'include'
            });
            const data = await response.json();

            if (data.ok) {
                questions = data.questions;
                renderQuestions();
                alert(`æˆåŠŸè¯†åˆ« ${questions.length} é“é¢˜ç›®ï¼`);
            } else {
                alert('è¯†åˆ«å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            alert('ç½‘ç»œé”™è¯¯ï¼š' + err.message);
        }
    }

    // åŒ¹é…ç­”æ¡ˆ
    async function parseAnswers() {
        const text = document.getElementById('pastedAnswers').value.trim();
        if (!text) {
            alert('è¯·å…ˆç²˜è´´ç­”æ¡ˆåˆ—è¡¨');
            return;
        }

        if (questions.length === 0) {
            alert('è¯·å…ˆè¯†åˆ«é¢˜ç›®');
            return;
        }

        try {
            const response = await fetch('/api/materials/parse-answers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text }),
                credentials: 'include'
            });
            const data = await response.json();

            if (data.ok) {
                // åŒ¹é…ç­”æ¡ˆåˆ°é¢˜ç›®
                console.log('Parsed answers:', data.answers);
                questions.forEach(q => {
                    // å°è¯•åŒ¹é… sequence (å¯èƒ½æ˜¯æ•°å­—æˆ–å­—ç¬¦ä¸²)
                    const key = String(q.sequence);
                    console.log(`Matching question ${key}:`, data.answers[key]);

                    if (data.answers[key]) {
                        q.reference_answer = data.answers[key];
                    } else if (data.answers[q.sequence]) {
                        q.reference_answer = data.answers[q.sequence];
                    }
                });
                renderQuestions();
                alert('ç­”æ¡ˆåŒ¹é…æˆåŠŸï¼');
            } else {
                alert('åŒ¹é…å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            alert('ç½‘ç»œé”™è¯¯ï¼š' + err.message);
        }
    }

    // æ¸²æŸ“é¢˜ç›®åˆ—è¡¨
    function renderQuestions() {
        const container = document.getElementById('questionsList');
        document.getElementById('questionCount').textContent = questions.length;

        if (questions.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">æš‚æ— é¢˜ç›®</p>';
            return;
        }

        let html = '';
        questions.forEach((q, index) => {
            html += `
            <div class="card mb-2">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h6>é¢˜ç›® ${q.sequence}</h6>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeQuestion(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <p class="mb-2">${q.content}</p>
                    ${q.options ? q.options.map(opt => `
                        <div class="ml-3">
                            <small class="badge badge-light">${opt.key}</small> ${opt.text}
                        </div>
                    `).join('') : ''}
                    <small class="text-success">
                        <strong>å‚è€ƒç­”æ¡ˆï¼š</strong>${q.reference_answer || 'æœªè®¾ç½®'}
                    </small>
                </div>
            </div>
        `;
        });

        container.innerHTML = html;
    }

    // ç§»é™¤é¢˜ç›®
    function removeQuestion(index) {
        if (confirm('ç¡®å®šåˆ é™¤è¿™é“é¢˜ç›®å—ï¼Ÿ')) {
            questions.splice(index, 1);
            renderQuestions();
        }
    }

    // æäº¤è¡¨å•
    document.getElementById('materialForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const title = document.getElementById('title').value.trim();
        const type = document.getElementById('type').value;
        const description = document.getElementById('description').value.trim();

        if (!title || !type) {
            alert('è¯·å¡«å†™æ ‡é¢˜å’Œç±»å‹');
            return;
        }

        let payload = {
            title,
            type,
            description
        };

        // Collect data based on material type
        if (type === 'grammar') {
            // Grammar: use existing questions array
            if (questions.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€é“é¢˜ç›®');
                return;
            }
            payload.questions = questions;

        } else if (type === 'writing_logic') {
            // Writing logic chain
            const essayFull = document.getElementById('essayFull').value.trim();
            const essayBlank = document.getElementById('essayBlank').value.trim();
            const essayAnswers = document.getElementById('essayAnswers').value.trim();

            if (!essayFull || !essayBlank || !essayAnswers) {
                alert('è¯·å¡«å†™å®Œæ•´èŒƒæ–‡ã€å¡«ç©ºç‰ˆå’Œç­”æ¡ˆåˆ—è¡¨');
                return;
            }

            payload.essay_full = essayFull;
            payload.essay_blank = essayBlank;
            payload.essay_answers = essayAnswers;

        } else if (type === 'speaking_reading') {
            // Speaking reading material
            const vocabulary = document.getElementById('vocabulary').value.trim();
            const sentencePatterns = document.getElementById('sentencePatterns').value.trim();
            const sampleParagraph = document.getElementById('sampleParagraph').value.trim();

            if (!vocabulary && !sentencePatterns && !sampleParagraph) {
                alert('è¯·è‡³å°‘å¡«å†™ä¸€é¡¹å†…å®¹');
                return;
            }

            payload.vocabulary = vocabulary;
            payload.sentence_patterns = sentencePatterns;
            payload.sample_paragraph = sampleParagraph;

        } else if (type === 'speaking_part1') {
            // Speaking Part 1 questions
            const part1Questions = document.getElementById('part1Questions').value.trim();

            if (!part1Questions) {
                alert('è¯·å¡«å†™é—®é¢˜åˆ—è¡¨');
                return;
            }

            payload.part1_questions = part1Questions;

        } else if (type === 'speaking_part2') {
            // Speaking Part 2 topic card
            const part2Topic = document.getElementById('part2Topic').value.trim();

            if (!part2Topic) {
                alert('è¯·å¡«å†™è¯é¢˜å¡ç‰‡');
                return;
            }

            payload.part2_topic = part2Topic;
        } else {
            alert('æœªçŸ¥çš„ææ–™ç±»å‹');
            return;
        }

        // Detect edit mode by checking if material exists
        const isEditMode = {{ 'true' if material else 'false' }
    };
    const materialId = {{ material.id if material else 'null' }};

    const url = isEditMode ? `/api/materials/${materialId}` : '/api/materials';
    const method = isEditMode ? 'PUT' : 'POST';

    try {
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            credentials: 'include'
        });
        const data = await response.json();

        if (data.ok) {
            alert('ä¿å­˜æˆåŠŸï¼');
            window.location.href = '/materials';
        } else {
            alert('ä¿å­˜å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (err) {
        alert('ç½‘ç»œé”™è¯¯ï¼š' + err.message);
    }
    });
</script>
{% endblock %}