{% extends "base.html" %}

{% block title %}{{ 'ç¼–è¾‘' if material else 'åˆ›å»º' }}ææ–™{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">{{ 'ğŸ“ ç¼–è¾‘ææ–™' if material else 'â• åˆ›å»ºæ–°ææ–™' }}</h4>
                </div>
                <div class="card-body">
                    <form id="materialForm">
                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>æ ‡é¢˜ *</label>
                                    <input type="text" class="form-control" id="title" required
                                        value="{{ material.title if material else '' }}"
                                        placeholder="ä¾‹å¦‚ï¼šä¸»è°“ä¸€è‡´-either/orç»“æ„">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>ç±»å‹ *</label>
                                    <select class="form-control" id="type" required>
                                        <option value="">é€‰æ‹©ç±»å‹</option>
                                        <option value="grammar" {{ 'selected' if material and material.type=='grammar'
                                            else '' }}>è¯­æ³•ç»ƒä¹ </option>
                                        <option value="translation" {{ 'selected' if material and
                                            material.type=='translation' else '' }}>ç¿»è¯‘ç»ƒä¹ </option>
                                        <option value="speaking" {{ 'selected' if material and material.type=='speaking'
                                            else '' }}>å£è¯­æœ—è¯»</option>
                                        <option value="writing" {{ 'selected' if material and material.type=='writing'
                                            else '' }}>å†™ä½œè®­ç»ƒ</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>çŸ¥è¯†ç‚¹è¯´æ˜</label>
                            <textarea class="form-control" id="description" rows="3"
                                placeholder="ç²˜è´´çŸ¥è¯†ç‚¹è¯´æ˜ï¼ˆå¦‚ï¼šEither...or è¿æ¥ä¸»è¯­æ—¶ï¼Œè°“è¯­åŠ¨è¯ä¸é è¿‘çš„ä¸»è¯­ä¿æŒä¸€è‡´...ï¼‰">{{ material.description if material else '' }}</textarea>
                        </div>

                        <hr>

                        <!-- é¢˜ç›®å¯¼å…¥æ–¹å¼ -->
                        <div class="form-group">
                            <label class="font-weight-bold">é¢˜ç›®å¯¼å…¥æ–¹å¼</label>
                            <div class="btn-group d-block" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="showTab('paste')">
                                    <i class="fas fa-clipboard"></i> ä»Wordå¤åˆ¶ç²˜è´´
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="showTab('manual')">
                                    <i class="fas fa-keyboard"></i> æ‰‹åŠ¨æ·»åŠ 
                                </button>
                            </div>
                        </div>

                        <!-- ç²˜è´´å¯¼å…¥æ ‡ç­¾é¡µ -->
                        <div id="pasteTab" style="display: block;">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5>æ­¥éª¤1ï¼šç²˜è´´é¢˜ç›®</h5>
                                    <textarea class="form-control mb-3" id="pastedQuestions" rows="15"
                                        placeholder="ç²˜è´´Wordé¢˜ç›®å†…å®¹ï¼Œä¾‹å¦‚ï¼š&#10;&#10;1. Either the mayor or the council members ___ expected...&#10;   A. is&#10;   B. are&#10;   C. was&#10;   D. be&#10;&#10;2. Neither the students nor the teacher ___ ready.&#10;   A. is&#10;   B. are&#10;   ..."></textarea>
                                    <button type="button" class="btn btn-success" onclick="parseQuestions()">
                                        <i class="fas fa-lightbulb"></i> æ™ºèƒ½è¯†åˆ«é¢˜ç›®
                                    </button>

                                    <hr>

                                    <h5>æ­¥éª¤2ï¼šç²˜è´´ç­”æ¡ˆ</h5>
                                    <textarea class="form-control mb-3" id="pastedAnswers" rows="8"
                                        placeholder="ç²˜è´´ç­”æ¡ˆåˆ—è¡¨ï¼Œä¾‹å¦‚ï¼š&#10;&#10;1. B&#10;2. A&#10;3. C&#10;..."></textarea>
                                    <button type="button" class="btn btn-success" onclick="parseAnswers()">
                                        <i class="fas fa-check"></i> åŒ¹é…ç­”æ¡ˆ
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- æ‰‹åŠ¨æ·»åŠ æ ‡ç­¾é¡µ -->
                        <div id="manualTab" style="display: none;">
                            <button type="button" class="btn btn-primary mb-3" onclick="addQuestion()">
                                <i class="fas fa-plus"></i> æ·»åŠ é¢˜ç›®
                            </button>
                        </div>

                        <hr>

                        <!-- é¢˜ç›®åˆ—è¡¨é¢„è§ˆ -->
                        <div class="form-group">
                            <label class="font-weight-bold">é¢˜ç›®åˆ—è¡¨ <span id="questionCount"
                                    class="badge badge-info">0</span></label>
                            <div id="questionsList" class="border rounded p-3"
                                style="max-height: 500px; overflow-y: auto;">
                                <p class="text-muted text-center">æš‚æ— é¢˜ç›®</p>
                            </div>
                        </div>

                        <!-- æäº¤æŒ‰é’® -->
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> ä¿å­˜ææ–™
                            </button>
                            <a href="/materials" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times"></i> å–æ¶ˆ
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let questions = [];

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function showTab(tab) {
        document.getElementById('pasteTab').style.display = tab === 'paste' ? 'block' : 'none';
        document.getElementById('manualTab').style.display = tab === 'manual' ? 'block' : 'none';
    }

    // æ™ºèƒ½è¯†åˆ«é¢˜ç›®
    async function parseQuestions() {
        const text = document.getElementById('pastedQuestions').value.trim();
        if (!text) {
            alert('è¯·å…ˆç²˜è´´é¢˜ç›®å†…å®¹');
            return;
        }

        try {
            const response = await fetch('/api/materials/parse', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text }),
                credentials: 'include'
            });
            const data = await response.json();

            if (data.ok) {
                questions = data.questions;
                renderQuestions();
                alert(`æˆåŠŸè¯†åˆ« ${questions.length} é“é¢˜ç›®ï¼`);
            } else {
                alert('è¯†åˆ«å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            alert('ç½‘ç»œé”™è¯¯ï¼š' + err.message);
        }
    }

    // åŒ¹é…ç­”æ¡ˆ
    async function parseAnswers() {
        const text = document.getElementById('pastedAnswers').value.trim();
        if (!text) {
            alert('è¯·å…ˆç²˜è´´ç­”æ¡ˆåˆ—è¡¨');
            return;
        }

        if (questions.length === 0) {
            alert('è¯·å…ˆè¯†åˆ«é¢˜ç›®');
            return;
        }

        try {
            const response = await fetch('/api/materials/parse-answers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text }),
                credentials: 'include'
            });
            const data = await response.json();

            if (data.ok) {
                // åŒ¹é…ç­”æ¡ˆåˆ°é¢˜ç›®
                questions.forEach(q => {
                    if (data.answers[q.sequence]) {
                        q.reference_answer = data.answers[q.sequence];
                    }
                });
                renderQuestions();
                alert('ç­”æ¡ˆåŒ¹é…æˆåŠŸï¼');
            } else {
                alert('åŒ¹é…å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            alert('ç½‘ç»œé”™è¯¯ï¼š' + err.message);
        }
    }

    // æ¸²æŸ“é¢˜ç›®åˆ—è¡¨
    function renderQuestions() {
        const container = document.getElementById('questionsList');
        document.getElementById('questionCount').textContent = questions.length;

        if (questions.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">æš‚æ— é¢˜ç›®</p>';
            return;
        }

        let html = '';
        questions.forEach((q, index) => {
            html += `
            <div class="card mb-2">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h6>é¢˜ç›® ${q.sequence}</h6>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeQuestion(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <p class="mb-2">${q.content}</p>
                    ${q.options ? q.options.map(opt => `
                        <div class="ml-3">
                            <small class="badge badge-light">${opt.key}</small> ${opt.text}
                        </div>
                    `).join('') : ''}
                    <small class="text-success">
                        <strong>å‚è€ƒç­”æ¡ˆï¼š</strong>${q.reference_answer || 'æœªè®¾ç½®'}
                    </small>
                </div>
            </div>
        `;
        });

        container.innerHTML = html;
    }

    // ç§»é™¤é¢˜ç›®
    function removeQuestion(index) {
        if (confirm('ç¡®å®šåˆ é™¤è¿™é“é¢˜ç›®å—ï¼Ÿ')) {
            questions.splice(index, 1);
            renderQuestions();
        }
    }

    // æäº¤è¡¨å•
    document.getElementById('materialForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const title = document.getElementById('title').value.trim();
        const type = document.getElementById('type').value;
        const description = document.getElementById('description').value.trim();

        if (!title || !type) {
            alert('è¯·å¡«å†™æ ‡é¢˜å’Œç±»å‹');
            return;
        }

        if (questions.length === 0) {
            alert('è¯·è‡³å°‘æ·»åŠ ä¸€é“é¢˜ç›®');
            return;
        }

        const payload = {
            title,
            type,
            description,
            questions
        };

        try {
            const response = await fetch('/api/materials', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                credentials: 'include'
            });
            const data = await response.json();

            if (data.ok) {
                alert('ä¿å­˜æˆåŠŸï¼');
                window.location.href = '/materials';
            } else {
                alert('ä¿å­˜å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            alert('ç½‘ç»œé”™è¯¯ï¼š' + err.message);
        }
    });
</script>
{% endblock %}