{% extends "base.html" %}
{% block content %}{% endblock %}
{% block content_dashboard %}
<h2>用户管理</h2>

<!-- 学生档案管理区域 -->
<div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
  <h3>学生档案管理</h3>
  <p style="color: #666; font-size: 14px;">学生创建后可通过微信小程序绑定使用，无需设置账号密码</p>

  <form method="POST" style="margin: 20px 0;">
    <input type="hidden" name="action" value="create_student">
    <label>学生姓名：</label>
    <input type="text" name="full_name" placeholder="请输入学生姓名" required>
    <button type="submit" style="background: #667eea;">➕ 添加学生</button>
  </form>

  <table class="user-table" style="margin-top: 20px;">
    <thead>
      <tr>
        <th>ID</th>
        <th>姓名</th>
        <th>绑定状态</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      {% for s in students %}
      <tr>
        <td>{{ s.id }}</td>
        <td>{{ s.full_name }}</td>
        <td>
          {% if s.user_id and s.user and s.user.wechat_openid %}
          <span style="color: green;">✓ 已绑定微信</span>
          {% elif s.user_id %}
          <span style="color: orange;">⚠ 已绑定账号</span>
          {% else %}
          <span style="color: gray;">未绑定</span>
          {% endif %}
        </td>
        <td>
          <form method="POST" style="display: inline;" onsubmit="return confirm('确定删除学生档案 {{ s.full_name }} 吗？');">
            <input type="hidden" name="action" value="delete_student">
            <input type="hidden" name="student_id" value="{{ s.id }}">
            <button type="submit" class="delete-btn" style="padding: 4px 8px;">删除</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<hr>

<!-- 系统用户管理区域 -->
<h3>系统用户管理</h3>
<p style="color: #666; font-size: 14px;">管理教师、助教、管理员等系统用户账号</p>

<form method="POST" class="user-form">
  <input type="hidden" name="action" value="create">
  <label>用户名：</label>
  <input type="text" name="username" required>
  <label>密码：</label>
  <input type="password" name="password" required>
  <label>角色：</label>
  <select name="role">
    <option value="teacher">老师</option>
    <option value="assistant">助教</option>
    <option value="course_planner">排课专员</option>
    <option value="admin">管理员</option>
  </select>
  <button type="submit">创建用户</button>
</form>

<table class="user-table" style="margin-top: 20px;">
  <thead>
    <tr>
      <th>ID</th>
      <th>用户名</th>
      <th>角色</th>
      <th>排课教师ID</th>
      <th>状态</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    {% for u in users %}
    <tr data-user-id="{{ u.id }}">
      <td>{{ u.id }}</td>
      <td>{{ u.username }}</td>
      <td>{{ u.role }}</td>
      <td>
        {% if u.role == 'teacher' %}
        <input type="number" class="sched-input" data-uid="{{ u.id }}" value="{{ u.scheduler_teacher_id or '' }}" style="width: 120px;">
        {% else %}
        —
        {% endif %}
      </td>
      <td class="status-cell">{{ "启用" if u.is_active else "停用" }}</td>
      <td>
        {% if u.id != current_user.id %}
        <button type="button" class="toggle-btn" data-uid="{{ u.id }}">
          {{ "停用" if u.is_active else "启用" }}
        </button>
        <button type="button" class="delete-btn" data-uid="{{ u.id }}">删除</button>
        <button type="button" class="pwd-btn" data-uid="{{ u.id }}">修改密码</button>
        {% else %}
        <em>当前登录用户</em>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // 启用/停用
    const buttons = document.querySelectorAll('.toggle-btn');
    buttons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const uid = btn.dataset.uid;
        try {
          const resp = await fetch(`/api/users/${uid}/toggle`, { method: 'POST' });
          const data = await resp.json();
          if (!data.ok) { alert('操作失败：' + (data.error || '')); return; }
          const isActive = data.user.is_active;
          btn.textContent = isActive ? '停用' : '启用';
          const row = btn.closest('tr');
          row.querySelector('.status-cell').textContent = isActive ? '启用' : '停用';
        } catch (e) { alert('网络错误，请稍后再试'); }
      });
    });

    // 删除
    const delBtns = document.querySelectorAll('.delete-btn');
    delBtns.forEach(btn => {
      btn.addEventListener('click', async () => {
        const uid = btn.dataset.uid;
        if (!confirm('确定删除该用户吗？')) return;
        try {
          const resp = await fetch(`/api/users/${uid}/delete`, { method: 'POST' });
          const data = await resp.json();
          if (!data.ok) { alert('删除失败：' + (data.error || '')); return; }
          const row = btn.closest('tr');
          row.parentNode.removeChild(row);
        } catch (e) { alert('网络错误，请稍后再试'); }
      });
    });

    // 修改密码
    const pwdBtns = document.querySelectorAll('.pwd-btn');
    pwdBtns.forEach(btn => {
      btn.addEventListener('click', async () => {
        const uid = btn.dataset.uid;
        const newPwd = prompt('请输入新密码（至少 6 位）：');
        if (newPwd === null) return;
        const trimmed = (newPwd || '').trim();
        if (trimmed.length < 6) { alert('密码太短，请重新输入（至少 6 位）'); return; }
        try {
          const resp = await fetch(`/api/users/${uid}/password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ new_password: trimmed })
          });
          const data = await resp.json();
          if (!data.ok) { alert('修改失败：' + (data.error || '')); return; }
          alert('密码已更新');
        } catch (e) { alert('网络错误，请稍后再试'); }
      });
    });

    // 设置排课教师ID
    const schedInputs = document.querySelectorAll('.sched-input');
    schedInputs.forEach(input => {
      input.addEventListener('change', async () => {
        const uid = input.dataset.uid;
        const val = input.value;
        try {
          const resp = await fetch(`/api/users/${uid}/scheduler_teacher`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ scheduler_teacher_id: val })
          });
          const data = await resp.json();
          if (!data.ok) {
            alert('保存失败：' + (data.error || ''));
          } else {
            alert('已保存');
          }
        } catch (e) { alert('网络错误，请稍后再试'); }
      });
    });
  });
</script>
{% endblock %}
