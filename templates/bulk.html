

{% extends "base.html" %}
{% block content %}
<h2>批量添加任务</h2>

<div class="card">
  <p style="margin:0 0 8px;">
    每行一条，格式：<code>学生名 | 类别 | 任务描述 | 备注(可选)</code>
  </p>
  <p style="margin:0 0 12px; color:var(--muted);">
    示例：<br>
    张三 | 基础-四级词汇 | 四级词汇 Day3<br>
    李四 | 雅思-听力-精听 | TPO1 S3 精听 | 家里环境安静
  </p>

  <form method="post">
    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
      <label>日期：</label>
      <input type="date" name="date" value="{{ today }}">
      <label>默认状态：</label>
      <select name="status">
        <option value="pending">未开始</option>
        <option value="progress">进行中</option>
        <option value="done">已完成</option>
      </select>
    </div>

    <textarea name="lines" rows="10" style="width:100%;"></textarea>

    <div style="display:flex; gap:8px; margin-top:10px;">
      <button type="submit" name="action" value="preview">预览</button>
      <button type="submit" name="action" value="create">直接创建</button>
      <a class="btn-secondary" href="{{ url_for('tasks_page') }}">返回任务列表</a>
    </div>
  </form>
</div>

{% if msg %}
  <div class="alert">{{ msg }}</div>
{% endif %}

{% if preview and preview|length %}
  <h3 style="margin-top:18px;">预览（{{ preview|length }} 条）</h3>
  <table class="task-table">
    <tr><th>#</th><th>学生</th><th>类别</th><th>任务</th><th>备注</th></tr>
    {% for it in preview %}
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ it.student }}</td>
      <td>{{ it.category }}</td>
      <td>{{ it.detail }}</td>
      <td>{{ it.note }}</td>
    </tr>
    {% endfor %}
  </table>
  <form method="post" style="margin-top:10px;">
    <input type="hidden" name="date" value="{{ today }}">
    <input type="hidden" name="status" value="pending">
    <textarea name="lines" style="display:none;">{% for it in preview -%}
{{ it.student }} | {{ it.category }} | {{ it.detail }}{% if it.note %} | {{ it.note }}{% endif %}
{%- endfor %}</textarea>
    <button type="submit" name="action" value="create">确认创建这些任务</button>
  </form>
{% endif %}
{% endblock %}