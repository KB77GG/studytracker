name: Deploy to Alibaba Cloud

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # è®¾ç½®é”™è¯¯ç«‹å³åœæ­¢
            set -e
            
            echo "ğŸš€ Starting deployment..."
            cd /root/apps/studytracker
            
            # 1. æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¦ Pulling latest code..."
            git pull origin main
            
            # 2. å®‰è£…ç³»ç»Ÿä¾èµ– (è™½ç„¶é€šå¸¸ä¸éœ€è¦æ¯æ¬¡éƒ½è·‘ï¼Œä½†ä¸ºäº†ä¿é™©èµ·è§ä¿ç•™)
            # æ³¨æ„ï¼šapt-get update å¯èƒ½ä¼šæ¯”è¾ƒæ…¢ï¼Œå¦‚æœæ²¡æœ‰æ–°ä¾èµ–å¯ä»¥æ³¨é‡Šæ‰
            # apt-get update && apt-get install -y python3-pip python3-cffi python3-brotli libpango-1.0-0 libpangoft2-1.0-0 fonts-noto-cjk
            
            # 3. æ›´æ–° Python ç¯å¢ƒ
            echo "ğŸ Installing Python dependencies..."
            .venv/bin/pip install -r requirements.txt
            
            # 4. æ‰§è¡Œæ•°æ®åº“è¿ç§» (æŒ‰éœ€å¢åŠ æ–°çš„è„šæœ¬)
            echo "ğŸ—„ï¸ Running migrations..."
            .venv/bin/python3 create_plan_table.py
            .venv/bin/python3 add_feedback_column.py
            .venv/bin/python3 add_explanation_column.py
            .venv/bin/python3 add_dictation_book_id.py
            
            # 5. é‡å¯æœåŠ¡
            echo "ğŸ”„ Restarting service..."
            systemctl restart studytracker
            
            echo "âœ… Deployment successful!"
