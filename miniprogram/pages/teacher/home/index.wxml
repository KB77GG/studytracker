<view class="page">
  <view class="header">
    <view class="title">老师课表</view>
    <view class="actions">
      <button class="sub-btn" size="mini" disabled="{{hasSubscribed}}" bindtap="requestSubscribe">
        {{hasSubscribed ? '已订阅提醒' : '订阅提醒'}}
      </button>
      <view class="view-switch">
        <button class="switch-btn {{viewMode==='list' ? 'active' : ''}}" size="mini" data-mode="list" bindtap="switchView">列表</button>
        <button class="switch-btn {{viewMode==='calendar' ? 'active' : ''}}" size="mini" data-mode="calendar" bindtap="switchView">日历</button>
      </view>
      <view class="range-switch">
        <button class="range-btn {{viewDays===7?'active':''}}" size="mini" data-days="7" bindtap="switchRange">7天</button>
        <button class="range-btn {{viewDays===30?'active':''}}" size="mini" data-days="30" bindtap="switchRange">30天</button>
      </view>
    </view>
  </view>

  <view wx:if="{{bindRequired}}" class="bind-panel">
    <view class="bind-title">绑定排课老师ID</view>
    <view class="bind-desc">请填写排课系统中的老师ID，绑定后即可查看课表。</view>
    <view class="bind-form">
      <input class="bind-input" type="number" placeholder="排课系统老师ID" model:value="{{schedulerTeacherId}}" />
      <button class="bind-btn" size="mini" loading="{{bindLoading}}" disabled="{{bindLoading}}" bindtap="bindSchedulerTeacher">
        绑定
      </button>
    </view>
  </view>

  <view wx:else>
    <view wx:if="{{loading}}" class="loading">加载中...</view>
    <view wx:else>
      <block wx:if="{{viewMode === 'calendar'}}">
        <view wx:if="{{monthDays.length === 0}}" class="empty">暂无课表</view>
        <view wx:else class="calendar-view">
          <view class="month-header">
            <text class="month-title">{{monthLabel}}</text>
          </view>
          <view class="week-header">
            <text class="week-cell" wx:for="{{weekHeaders}}" wx:key="*this">{{item}}</text>
          </view>
          <view class="month-grid">
            <view class="month-cell {{item.isPlaceholder ? 'placeholder' : ''}} {{item.date === selectedDate ? 'active' : ''}} {{item.isToday ? 'today' : ''}}" wx:for="{{monthDays}}" wx:key="index" wx:for-item="item" data-date="{{item.date}}" bindtap="selectDay">
              <text class="cell-date">{{item.dayNum}}</text>
              <view class="calendar-dots" wx:if="{{item.dots && item.dots.length}}">
                <view class="calendar-dot" wx:for="{{item.dots}}" wx:key="*this" wx:for-item="dot" style="background: {{dot}};"></view>
              </view>
              <text class="calendar-count" wx:if="{{item.count}}">{{item.count}}</text>
            </view>
          </view>

          <view class="day-detail">
            <view class="detail-header">
              <text class="detail-date">{{selectedDate}}</text>
              <text class="detail-count">{{selectedItems.length}}节</text>
            </view>
            <block wx:if="{{selectedItems.length === 0}}">
              <view class="empty">当天暂无课程</view>
            </block>
            <block wx:for="{{selectedItems}}" wx:key="schedule_id">
              <view class="detail-card" style="border-left-color: {{item.accentColor}};">
                <view class="detail-time" style="color: {{item.accentColor}};">{{item.timeRange}}</view>
                <view class="detail-main">
                  <text class="detail-title">{{item.course_name}}</text>
                  <text class="detail-meta">学生 {{item.student_name || '—'}}</text>
                  <text class="detail-meta">老师 {{item.teacher_name || '—'}}</text>
                </view>
                <view class="detail-footer">
                  <text class="feedback-tag {{item.feedback ? 'done' : ''}}">{{item.feedback ? '已反馈' : '待反馈'}}</text>
                  <button
                    class="feedback-btn {{item.feedback ? 'done' : ''}}"
                    size="mini"
                    data-schedule-uid="{{item.schedule_uid}}"
                    data-schedule-id="{{item.schedule_id}}"
                    data-student-id="{{item.student_id}}"
                    data-student-name="{{item.student_name}}"
                    data-course-name="{{item.course_name}}"
                    data-start-time="{{item.start_time}}"
                    data-end-time="{{item.end_time}}"
                    data-teacher-name="{{item.teacher_name}}"
                    data-schedule-date="{{item.schedule_date}}"
                    data-feedback-text="{{item.feedback ? item.feedback.text : ''}}"
                    data-feedback-image="{{item.feedback ? item.feedback.image : ''}}"
                    bindtap="openFeedback"
                  >
                    {{item.feedback ? '修改反馈' : '上课反馈'}}
                  </button>
                </view>
              </view>
            </block>
          </view>
        </view>
      </block>
      <block wx:else>
        <block wx:if="{{schedules.length === 0}}">
          <view class="empty">暂无课表</view>
        </block>
        <block wx:for="{{schedules}}" wx:key="date">
          <view class="group">
            <view class="group-title">
              <text class="group-date">{{item.date}}</text>
              <text class="group-count">{{item.count}}节</text>
            </view>
            <view class="card" wx:for="{{item.items}}" wx:key="schedule_id" style="border-left-color: {{item.accentColor}};">
              <view class="card-head">
                <view class="course-dot" style="background: {{item.accentColor}};"></view>
                <text class="course-title">{{item.course_name}}</text>
                <view class="time-pill" style="background: {{item.accentBg}}; color: {{item.accentColor}};">
                  {{item.timeRange}}
                </view>
              </view>
              <view class="meta-row">
                <view class="meta-item">
                  <text class="meta-label">学生</text>
                  <text class="meta-value">{{item.student_name || '—'}}</text>
                </view>
                <view class="meta-item">
                  <text class="meta-label">老师</text>
                  <text class="meta-value">{{item.teacher_name || '—'}}</text>
                </view>
              </view>
              <view class="card-footer">
                <text class="feedback-tag {{item.feedback ? 'done' : ''}}">{{item.feedback ? '已反馈' : '待反馈'}}</text>
                <button
                  class="feedback-btn {{item.feedback ? 'done' : ''}}"
                  size="mini"
                  data-schedule-uid="{{item.schedule_uid}}"
                  data-schedule-id="{{item.schedule_id}}"
                  data-student-id="{{item.student_id}}"
                  data-student-name="{{item.student_name}}"
                  data-course-name="{{item.course_name}}"
                  data-start-time="{{item.start_time}}"
                  data-end-time="{{item.end_time}}"
                  data-teacher-name="{{item.teacher_name}}"
                  data-schedule-date="{{item.schedule_date}}"
                  data-feedback-text="{{item.feedback ? item.feedback.text : ''}}"
                  data-feedback-image="{{item.feedback ? item.feedback.image : ''}}"
                  bindtap="openFeedback"
                >
                  {{item.feedback ? '修改反馈' : '上课反馈'}}
                </button>
              </view>
            </view>
          </view>
        </block>
      </block>
    </view>
  </view>

  <view class="bottom-nav">
    <view class="nav-item active">课表</view>
    <view class="nav-item" bindtap="goStats">课时统计</view>
  </view>
</view>
