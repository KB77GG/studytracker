<view class="page">
  <view class="header">
    <view class="title">老师课表</view>
    <view class="actions">
      <button class="sub-btn" size="mini" disabled="{{hasSubscribed}}" bindtap="requestSubscribe">
        {{hasSubscribed ? '已订阅提醒' : '订阅提醒'}}
      </button>
      <view class="range-switch">
        <button class="range-btn {{viewDays===7?'active':''}}" size="mini" data-days="7" bindtap="switchRange">7天</button>
        <button class="range-btn {{viewDays===30?'active':''}}" size="mini" data-days="30" bindtap="switchRange">30天</button>
      </view>
    </view>
  </view>

  <view class="view-switch">
    <button class="switch-btn {{viewMode==='week'?'active':''}}" size="mini" data-mode="week" bindtap="switchView">周视图</button>
    <button class="switch-btn {{viewMode==='list'?'active':''}}" size="mini" data-mode="list" bindtap="switchView">列表</button>
  </view>

  <view wx:if="{{bindRequired}}" class="bind-panel">
    <view class="bind-title">绑定排课老师ID</view>
    <view class="bind-desc">请填写排课系统中的老师ID，绑定后即可查看课表。</view>
    <view class="bind-form">
      <input class="bind-input" type="number" placeholder="排课系统老师ID" model:value="{{schedulerTeacherId}}" />
      <button class="bind-btn" size="mini" loading="{{bindLoading}}" disabled="{{bindLoading}}" bindtap="bindSchedulerTeacher">
        绑定
      </button>
    </view>
  </view>

  <view wx:else>
    <view wx:if="{{loading}}" class="loading">加载中...</view>
    <view wx:else>
      <block wx:if="{{viewMode === 'week'}}">
        <view wx:if="{{weekDays.length === 0}}" class="empty">暂无课表</view>
        <view wx:else class="calendar-view">
          <view class="calendar-row">
            <view class="calendar-day {{item.date === selectedDate ? 'active' : ''}} {{item.isToday ? 'today' : ''}}" wx:for="{{weekDays}}" wx:key="date" wx:for-item="item" data-date="{{item.date}}" bindtap="selectDay">
              <text class="calendar-weekday">{{item.weekday}}</text>
              <text class="calendar-date">{{item.dayNum}}</text>
              <view class="calendar-dots" wx:if="{{item.dots.length}}">
                <view class="calendar-dot" wx:for="{{item.dots}}" wx:key="*this" wx:for-item="dot" style="background: {{dot}};"></view>
              </view>
              <text class="calendar-count" wx:if="{{item.count}}">{{item.count}}</text>
            </view>
          </view>

          <view class="day-detail">
            <view class="detail-header">
              <text class="detail-date">{{selectedDate}}</text>
              <text class="detail-count">{{selectedItems.length}}节</text>
            </view>
            <block wx:if="{{selectedItems.length === 0}}">
              <view class="empty">当天暂无课程</view>
            </block>
            <block wx:for="{{selectedItems}}" wx:key="schedule_id">
              <view class="detail-card" style="border-left-color: {{item.accentColor}};">
                <view class="detail-time" style="color: {{item.accentColor}};">{{item.timeRange}}</view>
                <view class="detail-main">
                  <text class="detail-title">{{item.course_name}}</text>
                  <text class="detail-meta">学生 {{item.student_name || '—'}}</text>
                  <text class="detail-meta">老师 {{item.teacher_name || '—'}}</text>
                </view>
              </view>
            </block>
          </view>
        </view>
      </block>
      <block wx:else>
        <block wx:if="{{schedules.length === 0}}">
          <view class="empty">暂无课表</view>
        </block>
        <block wx:for="{{schedules}}" wx:key="date">
          <view class="group">
            <view class="group-title">
              <text class="group-date">{{item.date}}</text>
              <text class="group-count">{{item.count}}节</text>
            </view>
            <view class="card" wx:for="{{item.items}}" wx:key="schedule_id" style="border-left-color: {{item.accentColor}};">
              <view class="card-head">
                <view class="course-dot" style="background: {{item.accentColor}};"></view>
                <text class="course-title">{{item.course_name}}</text>
                <view class="time-pill" style="background: {{item.accentBg}}; color: {{item.accentColor}};">
                  {{item.timeRange}}
                </view>
              </view>
              <view class="meta-row">
                <view class="meta-item">
                  <text class="meta-label">学生</text>
                  <text class="meta-value">{{item.student_name || '—'}}</text>
                </view>
                <view class="meta-item">
                  <text class="meta-label">老师</text>
                  <text class="meta-value">{{item.teacher_name || '—'}}</text>
                </view>
              </view>
            </view>
          </view>
        </block>
      </block>
    </view>
  </view>
</view>
