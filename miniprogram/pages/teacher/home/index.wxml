<view class="page">
  <view class="header">
    <view class="title">老师课表</view>
    <view class="actions">
      <button class="sub-btn" size="mini" disabled="{{hasSubscribed}}" bindtap="requestSubscribe">
        {{hasSubscribed ? '已订阅提醒' : '订阅提醒'}}
      </button>
      <view class="range-switch">
        <button class="range-btn {{viewDays===7?'active':''}}" size="mini" data-days="7" bindtap="switchRange">7天</button>
        <button class="range-btn {{viewDays===30?'active':''}}" size="mini" data-days="30" bindtap="switchRange">30天</button>
      </view>
    </view>
  </view>

  <view class="view-switch">
    <button class="switch-btn {{viewMode==='week'?'active':''}}" size="mini" data-mode="week" bindtap="switchView">周视图</button>
    <button class="switch-btn {{viewMode==='list'?'active':''}}" size="mini" data-mode="list" bindtap="switchView">列表</button>
  </view>

  <view wx:if="{{bindRequired}}" class="bind-panel">
    <view class="bind-title">绑定排课老师ID</view>
    <view class="bind-desc">请填写排课系统中的老师ID，绑定后即可查看课表。</view>
    <view class="bind-form">
      <input class="bind-input" type="number" placeholder="排课系统老师ID" model:value="{{schedulerTeacherId}}" />
      <button class="bind-btn" size="mini" loading="{{bindLoading}}" disabled="{{bindLoading}}" bindtap="bindSchedulerTeacher">
        绑定
      </button>
    </view>
  </view>

  <view wx:else>
    <view wx:if="{{loading}}" class="loading">加载中...</view>
    <view wx:else>
      <block wx:if="{{viewMode === 'week'}}">
        <view wx:if="{{schedules.length === 0}}" class="empty">暂无课表</view>
        <view wx:else class="week-view">
          <scroll-view scroll-x class="week-scroll">
            <view class="week-row">
              <view class="time-col">
                <view class="day-header time-header">时间</view>
                <view class="time-slot" wx:for="{{timeSlots}}" wx:key="*this" wx:for-item="slot" style="height: {{hourHeight}}rpx;">
                  {{slot}}
                </view>
              </view>
              <view class="day-col" wx:for="{{weekDays}}" wx:key="date" wx:for-item="day">
                <view class="day-header">{{day.label}}</view>
                <view class="day-grid" style="height: {{gridHeight}}rpx;">
                  <view class="grid-line" wx:for="{{timeSlots}}" wx:key="*this" wx:for-item="slot" style="height: {{hourHeight}}rpx;"></view>
                  <view class="schedule-block" wx:for="{{day.items}}" wx:key="schedule_id" wx:for-item="item" style="{{item.style}}">
                    <text class="block-time">{{item.timeLabel}}</text>
                    <text class="block-title">{{item.course_name}}</text>
                    <text class="block-meta">学生 {{item.student_name || '—'}}</text>
                    <text class="block-meta">老师 {{item.teacher_name || '—'}}</text>
                    <button class="feedback-btn" size="mini" data-id="{{item.schedule_id}}" bindtap="handleFeedback">添加反馈</button>
                  </view>
                </view>
              </view>
            </view>
          </scroll-view>
        </view>
      </block>
      <block wx:else>
        <block wx:if="{{schedules.length === 0}}">
          <view class="empty">暂无课表</view>
        </block>
        <block wx:for="{{schedules}}" wx:key="date">
          <view class="group">
            <view class="group-title">
              <text class="group-date">{{item.date}}</text>
              <text class="group-count">{{item.count}}节</text>
            </view>
            <view class="card" wx:for="{{item.items}}" wx:key="schedule_id" style="border-left-color: {{item.accentColor}};">
              <view class="card-head">
                <view class="course-dot" style="background: {{item.accentColor}};"></view>
                <text class="course-title">{{item.course_name}}</text>
                <view class="time-pill" style="background: {{item.accentBg}}; color: {{item.accentColor}};">
                  {{item.timeRange}}
                </view>
              </view>
              <view class="meta-row">
                <view class="meta-item">
                  <text class="meta-label">学生</text>
                  <text class="meta-value">{{item.student_name || '—'}}</text>
                </view>
                <view class="meta-item">
                  <text class="meta-label">老师</text>
                  <text class="meta-value">{{item.teacher_name || '—'}}</text>
                </view>
              </view>
            </view>
          </view>
        </block>
      </block>
    </view>
  </view>
</view>
