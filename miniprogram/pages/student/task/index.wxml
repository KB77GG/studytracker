<view class="container">
  <view class="task-header">
    <text class="task-title">{{task.task_name}}</text>
    <text class="task-module">{{task.module}}</text>
  </view>

  <view class="task-info-card">
    <view class="info-row">
      <text class="label">è®¡åˆ’æ—¶é•¿</text>
      <text class="value">{{task.planned_minutes}} åˆ†é’Ÿ</text>
    </view>
    <view class="info-row">
      <text class="label">ä»»åŠ¡è¯´æ˜</text>
      <text class="value">{{task.instructions || 'æš‚æ— è¯´æ˜'}}</text>
    </view>
    <view class="info-row">
      <text class="label">çŠ¶æ€</text>
      <text class="value status-{{task.status}}">{{statusText}}</text>
    </view>
  </view>

  <!-- Timer Display -->
  <view class="timer-card" wx:if="{{timerRunning}}">
    <view class="timer-header">
      <text class="timer-icon">â±ï¸</text>
      <text class="timer-label">å½“å‰è®¡æ—¶</text>
    </view>
    <view class="timer-display">
      <text class="timer-time">{{displayTime}}</text>
      <text class="timer-target">/ {{plannedTime}}</text>
    </view>
    <view class="timer-actions">
      <view class="timer-btn pause" catchtap="pauseTimer">æš‚åœ</view>
      <view class="timer-btn stop" catchtap="stopTimer">ç»“æŸ</view>
    </view>
  </view>


  <!-- å­¦ä¹ ææ–™åŒºåŸŸ -->
  <view class="material-card" wx:if="{{task.material}}">
    <view class="section-title">ğŸ“š å­¦ä¹ ææ–™</view>
    
    <!-- 1. è¯­æ³•ç»ƒä¹  / ç¿»è¯‘ç»ƒä¹  -->
    <view wx:if="{{task.material.type === 'grammar' || task.material.type === 'translation'}}">
      <view class="question-item" wx:for="{{task.material.questions}}" wx:key="id">
        <text class="question-content">{{index + 1}}. {{item.content}}</text>
        <view class="options" wx:if="{{item.options && item.options.length > 0}}">
          <view class="option-item" wx:for="{{item.options}}" wx:for-item="opt" wx:key="key">
            <text>{{opt.key}}. {{opt.text}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 2. å†™ä½œé€»è¾‘é“¾ -->
    <view wx:if="{{task.material.type === 'writing_logic'}}">
      <view class="material-section">
        <text class="subtitle">å®Œæ•´èŒƒæ–‡</text>
        <text class="content-text" user-select>{{task.material.questions[0].content}}</text>
      </view>
      <view class="material-section">
        <text class="subtitle">å¡«ç©ºç»ƒä¹ </text>
        <text class="content-text" user-select>{{task.material.questions[0].hint}}</text>
      </view>
    </view>

    <!-- 3. å£è¯­æœ—è¯» -->
    <view wx:if="{{task.material.type === 'speaking_reading'}}">
      <view class="material-section">
        <view class="subtitle">è¯æ±‡è¡¨è¾¾</view>
        <view class="word-cloud">
          <text class="word-tag" wx:for="{{vocabularyWords}}" wx:key="index" bindtap="playWord" data-word="{{item}}">
            {{item}}
          </text>
        </view>
      </view>

      <view class="material-section">
        <view class="subtitle">å¥å‹è¡¨è¾¾</view>
        <view class="word-cloud">
          <text class="word-tag" wx:for="{{sentenceWords}}" wx:key="index" bindtap="playWord" data-word="{{item}}">
            {{item}}
          </text>
        </view>
      </view>

      <view class="material-section">
        <view class="subtitle">ç¤ºèŒƒæ®µè½</view>
        <view class="word-cloud">
          <text class="word-tag" wx:for="{{paragraphWords}}" wx:key="index" bindtap="playWord" data-word="{{item}}">
            {{item}}
          </text>
        </view>
      </view>
    </view>

    <!-- 4. å£è¯­ Part 1 -->
    <view wx:if="{{task.material.type === 'speaking_part1'}}">
      <view class="question-list">
        <view class="question-item" wx:for="{{task.material.questions}}" wx:key="id">
          <text class="question-content">{{index + 1}}. {{item.content}}</text>
        </view>
      </view>
    </view>

    <!-- 5. å£è¯­ Part 2 -->
    <view wx:if="{{task.material.type === 'speaking_part2'}}">
      <view class="topic-card">
        <text class="content-text" user-select>{{task.material.questions[0].content}}</text>
      </view>
    </view>
  </view>

  <!-- è€å¸ˆåé¦ˆ (ä»…å·²å®Œæˆæ˜¾ç¤º) -->
  <view class="feedback-card" wx:if="{{task.status === 'completed'}}">
    <view class="section-title">ğŸ‘©â€ğŸ« è€å¸ˆåé¦ˆ</view>
    
    <!-- æ‰¹æ³¨å›¾ç‰‡ -->
    <view class="feedback-image" wx:if="{{task.feedback_image}}">
      <text class="label">æ‰¹æ³¨å›¾ç‰‡</text>
      <image src="{{baseUrl}}{{task.feedback_image}}" mode="aspectFit" bindtap="previewFeedbackImage" class="annotated-image"></image>
    </view>
    
    <!-- è¯­éŸ³åé¦ˆ -->
    <view class="feedback-audio" wx:if="{{task.feedback_audio}}">
      <text class="label">è¯­éŸ³åé¦ˆ</text>
      <view class="audio-player">
        <button class="btn-play-feedback" bindtap="playFeedbackAudio" size="mini">
          {{playingFeedback ? 'æš‚åœ' : 'æ’­æ”¾'}}
        </button>
      </view>
    </view>
    
    <view class="info-row" wx:if="{{task.accuracy !== null}}">
      <text class="label">æ­£ç¡®ç‡</text>
      <text class="value highlight">{{task.accuracy}}%</text>
    </view>
    <view class="info-row" wx:if="{{task.completion_rate !== null}}">
      <text class="label">å®Œæˆç‡</text>
      <text class="value highlight">{{task.completion_rate}}%</text>
    </view>
    <view class="info-row" wx:if="{{task.teacher_note}}">
      <text class="label">è¯„è¯­</text>
      <text class="value">{{task.teacher_note}}</text>
    </view>
  </view>

  <!-- å½•éŸ³åŒºåŸŸ (ä»…å£è¯­ä»»åŠ¡æ˜¾ç¤º) -->
  <view class="upload-section" wx:if="{{showAudio}}">
    <text class="section-title">ğŸ“¢ å£è¯­å½•éŸ³</text>
    <view class="audio-recorder" wx:if="{{task.status !== 'submitted' && task.status !== 'completed'}}">
      <button class="record-btn {{recording ? 'recording' : ''}}" 
              bindtouchstart="startRecord" 
              bindtouchend="stopRecord">
        {{recording ? 'æ¾å¼€ç»“æŸ' : 'æŒ‰ä½å½•éŸ³'}}
      </button>
      <text class="duration" wx:if="{{recordDuration > 0}}">{{recordDuration}}ç§’</text>
    </view>
    
    <view class="audio-list" wx:if="{{audioFiles.length > 0}}">
      <view class="audio-item" wx:for="{{audioFiles}}" wx:key="index">
        <text class="audio-name">å½•éŸ³ {{index + 1}}</text>
        <button class="btn-play" size="mini" bindtap="playAudio" data-url="{{item}}">æ’­æ”¾</button>
        <button class="btn-delete" size="mini" bindtap="deleteAudio" data-index="{{index}}" wx:if="{{task.status !== 'submitted' && task.status !== 'completed'}}">åˆ é™¤</button>
      </view>
    </view>
  </view>

  <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
  <view class="upload-section">
    <text class="section-title">ğŸ“· ä½œä¸šç…§ç‰‡</text>
    <view class="image-grid">
      <view class="image-item" wx:for="{{images}}" wx:key="index">
        <image src="{{item}}" mode="aspectFill" bindtap="previewImage" data-url="{{item}}"></image>
        <icon type="clear" size="20" class="delete-icon" bindtap="deleteImage" data-index="{{index}}" wx:if="{{task.status !== 'submitted' && task.status !== 'completed'}}"></icon>
      </view>
      <view class="image-item add-btn" bindtap="chooseImage" wx:if="{{images.length < 9 && task.status !== 'submitted' && task.status !== 'completed'}}">
        <text>+</text>
      </view>
    </view>
  </view>

  <!-- å¤‡æ³¨ -->
  <view class="upload-section">
    <text class="section-title">ğŸ’¬ å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</text>
    <textarea class="note-input" placeholder="å†™ä¸‹ä½ çš„å­¦ä¹ ç¬”è®°æˆ–é‡åˆ°çš„é—®é¢˜..." model:value="{{note}}" maxlength="300" disabled="{{task.status === 'submitted' || task.status === 'completed'}}"></textarea>
  </view>

  <!-- æäº¤æŒ‰é’® -->
  <view class="action-buttons" wx:if="{{task.status !== 'submitted' && task.status !== 'completed'}}">
    <button class="btn-submit" bindtap="submitTask" disabled="{{submitting}}">
      {{submitting ? 'æäº¤ä¸­...' : 'æäº¤ä»»åŠ¡'}}
    </button>
  </view>
  <view class="action-buttons" wx:elif="{{task.status === 'submitted'}}">
    <button class="btn-submit" disabled>å·²æäº¤ï¼Œç­‰å¾…è€å¸ˆå®¡æ ¸</button>
  </view>

  <!-- æ’’èŠ±ç‰¹æ•ˆ Canvas -->
  <canvas type="2d" id="confetti" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; display: {{showConfetti ? 'block' : 'none'}}"></canvas>
</view>
