<view class="container">
  <view class="hero">
    <text class="brand">HAMMER</text>
    <text class="subtitle">口语对练 · 逻辑梳理 · 高分改写</text>
  </view>

  <view class="chat-toolbar">
    <button class="toolbar-btn" bindtap="openSessionDrawer">会话记录</button>
    <button class="toolbar-btn primary" bindtap="startNewSession">新对话</button>
  </view>

  <view class="card">
    <view class="section-title">模式设置</view>
    <view class="tabs">
      <view class="tab {{currentPart==='Part1' ? 'active' : ''}}" data-part="Part1" bindtap="switchPart">Part 1</view>
      <view class="tab {{currentPart==='Part2' ? 'active' : ''}}" data-part="Part2" bindtap="switchPart">Part 2</view>
      <view class="tab {{currentPart==='Part3' ? 'active' : ''}}" data-part="Part3" bindtap="switchPart">Part 3</view>
    </view>

    <view class="source-row">
      <view class="pill {{sourceMode==='assigned' ? 'active' : ''}}" data-mode="assigned" bindtap="switchSource">已布置</view>
      <view class="pill {{sourceMode==='random' ? 'active' : ''}}" data-mode="random" bindtap="switchSource">随机</view>
      <text class="source-tip" wx:if="{{sourceMode==='assigned' && assignedCount===0}}">暂无已布置题目，自动使用随机题</text>
    </view>

    <view class="source-row">
      <view class="pill {{inputMode==='standard' ? 'active' : ''}}" data-mode="standard" bindtap="switchInputMode">标准评估</view>
      <view class="pill {{inputMode==='oral_sdk' ? 'active' : ''}}" data-mode="oral_sdk" bindtap="switchInputMode">发音增强(beta)</view>
      <text class="source-tip" wx:if="{{inputMode==='oral_sdk' && oralWarrantLoading}}">正在获取口语凭证...</text>
      <text class="source-tip" wx:if="{{inputMode==='oral_sdk' && oralEngineStatus}}">{{oralEngineStatus}}</text>
    </view>

    <view class="framework" wx:if="{{currentPart !== 'Part1'}}">
      <text class="label">框架提示（可选）</text>
      <picker mode="selector" range="{{part2Options}}" range-key="label" bindchange="handleFrameworkChange">
        <view class="picker">{{selectedFrameworkLabel}}</view>
      </picker>
    </view>

    <view class="session-meta" wx:if="{{activeSessionId}}">
      <text>当前会话 #{{activeSessionId}}</text>
      <text class="session-meta-question">{{questionText}}</text>
    </view>

    <button class="btn-outline" bindtap="nextQuestion" loading="{{loadingQuestion}}">换一题</button>
  </view>

  <view class="card chat-card">
    <view class="section-title">对话记录</view>
    <scroll-view class="chat-scroll" scroll-y="true" scroll-top="{{chatScrollTop}}" scroll-with-animation="true">
      <view class="empty" wx:if="{{messages.length === 0}}">暂无记录，点击“换一题”开始</view>
      <view class="chat-list" wx:else>
        <view class="chat-row {{item.role}}" wx:for="{{messages}}" wx:key="index">
          <view class="bubble {{item.role}}">
            <view wx:if="{{item.role === 'system'}}">
              <text class="bubble-label">题目</text>
              <text class="bubble-text">{{item.content}}</text>
            </view>
            <view wx:elif="{{item.role === 'user'}}">
              <text class="bubble-label">我</text>
              <text class="bubble-text">{{item.content}}</text>
              <button class="btn-audio-replay" wx:if="{{item.audio_url}}" bindtap="playMessageAudio" data-url="{{item.audio_url}}">回听录音</button>
              <view class="msg-actions">
                <text class="msg-action" bindtap="reuseUserMessage" data-content="{{item.content}}">重评</text>
                <text class="msg-action danger" bindtap="deleteMessageLocal" data-index="{{index}}">删除</text>
              </view>
            </view>
            <view wx:else>
              <text class="bubble-label">反馈</text>
              <view class="assistant-block" wx:if="{{item.result && item.result.scores}}">
                <view class="assistant-title">官方评分四项</view>
                <view class="score-grid">
                  <view class="score-item">
                    <text class="score-label">F&C</text>
                    <text class="score-value">{{item.result.scores.fluency_coherence}}</text>
                  </view>
                  <view class="score-item">
                    <text class="score-label">LR</text>
                    <text class="score-value">{{item.result.scores.lexical_resource}}</text>
                  </view>
                  <view class="score-item">
                    <text class="score-label">GRA</text>
                    <text class="score-value">{{item.result.scores.grammar_range_accuracy}}</text>
                  </view>
                  <view class="score-item">
                    <text class="score-label">PR</text>
                    <text class="score-value">{{item.result.scores.pronunciation}}</text>
                  </view>
                  <view class="score-item overall">
                    <text class="score-label">Overall</text>
                    <text class="score-value">{{item.result.scores.overall}}</text>
                  </view>
                </view>
              </view>

              <view class="assistant-block" wx:if="{{item.result && item.result.criteria_feedback && item.result.criteria_feedback.fluency_coherence}}">
                <view class="assistant-title">Fluency & Coherence（含逻辑框架）</view>
                <view class="list" wx:if="{{item.result.criteria_feedback.fluency_coherence.plus.length}}">
                  <text class="list-item" wx:for="{{item.result.criteria_feedback.fluency_coherence.plus}}" wx:key="*this">+ {{item}}</text>
                </view>
                <view class="list" wx:if="{{item.result.criteria_feedback.fluency_coherence.minus.length}}">
                  <text class="list-item" wx:for="{{item.result.criteria_feedback.fluency_coherence.minus}}" wx:key="*this">- {{item}}</text>
                </view>
              </view>

              <view class="assistant-block" wx:if="{{item.result}}">
                <view class="assistant-title">逻辑梳理</view>
                <view class="logic-block" wx:if="{{item.result && item.result.logic_outline && item.result.logic_outline.zh.length}}">
                  <text class="block-title">中文</text>
                  <view class="list">
                    <text class="list-item" wx:for="{{item.result.logic_outline.zh}}" wx:key="*this">• {{item}}</text>
                  </view>
                </view>
                <view class="logic-block" wx:if="{{item.result && item.result.logic_outline && item.result.logic_outline.en.length}}">
                  <text class="block-title">English</text>
                  <view class="list">
                    <text class="list-item" wx:for="{{item.result.logic_outline.en}}" wx:key="*this">• {{item}}</text>
                  </view>
                </view>
              </view>

              <view class="assistant-block" wx:if="{{item.result}}">
                <view class="assistant-title">高分改写</view>
                <text class="rewrite">{{item.result.rewrite_high_band.paragraph}}</text>
                <view class="tts-row">
                  <button class="btn-tts" bindtap="playRewriteAudio" data-text="{{item.result.rewrite_high_band.paragraph}}" loading="{{ttsLoading}}">
                    {{ttsPlaying ? '播放中...' : '播放改写'}}
                  </button>
                </view>
                <view class="list" wx:if="{{item.result.rewrite_high_band.logic_tips.length}}">
                  <text class="list-item" wx:for="{{item.result.rewrite_high_band.logic_tips}}" wx:key="*this">• {{item}}</text>
                </view>
              </view>

              <view class="assistant-block" wx:if="{{item.result && item.result.sentence_feedback.length}}">
                <view class="assistant-title">句子纠错</view>
                <view class="feedback-card" wx:for="{{item.result.sentence_feedback}}" wx:key="index">
                  <text class="fb-original">原句：{{item.original}}</text>
                  <text class="fb-correct">修正：{{item.correction}}</text>
                  <text class="fb-note">{{item.explain_cn}}</text>
                </view>
              </view>

              <view class="assistant-block" wx:if="{{item.result && item.result.chinese_style_correction.length}}">
                <view class="assistant-title">Lexical Resource：中式表达纠正</view>
                <view class="feedback-card" wx:for="{{item.result.chinese_style_correction}}" wx:key="index">
                  <text class="fb-original">原句：{{item.original}}</text>
                  <text class="fb-correct">地道：{{item.native_like}}</text>
                  <text class="fb-note">{{item.note}}</text>
                </view>
              </view>

              <view class="assistant-block" wx:if="{{item.result && item.result.lexical_upgrade.length}}">
                <view class="assistant-title">Lexical Resource：词汇升级</view>
                <view class="feedback-card" wx:for="{{item.result.lexical_upgrade}}" wx:key="index">
                  <text class="fb-original">from：{{item.from}}</text>
                  <text class="fb-correct">to：{{item.to.join(' / ')}}</text>
                  <text class="fb-note">{{item.constraint}}</text>
                </view>
              </view>

              <view class="assistant-block" wx:if="{{item.result && item.result.criteria_feedback && item.result.criteria_feedback.pronunciation}}">
                <view class="assistant-title">Pronunciation（语音估计）</view>
                <view class="list" wx:if="{{item.result.criteria_feedback.pronunciation.plus.length}}">
                  <text class="list-item" wx:for="{{item.result.criteria_feedback.pronunciation.plus}}" wx:key="*this">+ {{item}}</text>
                </view>
                <view class="list" wx:if="{{item.result.criteria_feedback.pronunciation.minus.length}}">
                  <text class="list-item" wx:for="{{item.result.criteria_feedback.pronunciation.minus}}" wx:key="*this">- {{item}}</text>
                </view>
                <view class="list" wx:if="{{item.result.criteria_feedback.pronunciation.audio_observations.length}}">
                  <text class="list-item" wx:for="{{item.result.criteria_feedback.pronunciation.audio_observations}}" wx:key="*this">• {{item}}</text>
                </view>
                <text class="fb-note" wx:if="{{item.result.criteria_feedback.pronunciation.confidence}}">置信度：{{item.result.criteria_feedback.pronunciation.confidence}}</text>
                <text class="fb-note" wx:if="{{item.result.criteria_feedback.pronunciation.limitation_note}}">{{item.result.criteria_feedback.pronunciation.limitation_note}}</text>
              </view>

              <view class="assistant-block" wx:if="{{item.result && item.result.next_step && item.result.next_step.length}}">
                <view class="assistant-title">下一步练习建议</view>
                <view class="list">
                  <text class="list-item" wx:for="{{item.result.next_step}}" wx:key="*this">• {{item}}</text>
                </view>
              </view>
              <view class="assistant-block" wx:if="{{!item.result}}">
                <text class="bubble-text">暂无反馈内容</text>
              </view>
              <view class="msg-actions">
                <text class="msg-action" bindtap="favoriteAssistantMessage" data-index="{{index}}">收藏</text>
                <text class="msg-action danger" bindtap="deleteMessageLocal" data-index="{{index}}">删除</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <view class="session-mask" wx:if="{{sessionDrawerOpen}}" bindtap="closeSessionDrawer"></view>
  <view class="session-drawer {{sessionDrawerOpen ? 'open' : ''}}">
    <view class="session-drawer-head">
      <text class="session-drawer-title">练习记录</text>
      <text class="session-drawer-close" bindtap="closeSessionDrawer">关闭</text>
    </view>
    <button class="session-new-btn" bindtap="startNewSession">+ 新对话</button>
    <view class="session-empty" wx:if="{{sessionLoading}}">加载中...</view>
    <view class="session-empty" wx:elif="{{sessionList.length===0}}">暂无记录</view>
    <scroll-view class="session-list" scroll-y="true" wx:else>
      <view class="session-item {{item.id===activeSessionId ? 'active' : ''}}" wx:for="{{sessionList}}" wx:key="id" bindtap="openSessionFromList" data-id="{{item.id}}">
        <view class="session-item-top">
          <text class="session-part">{{item.part}}</text>
          <text class="session-time">{{item.createdLabel}}</text>
        </view>
        <text class="session-preview">{{item.preview}}</text>
      </view>
    </scroll-view>
  </view>

  <view class="composer-wrap">
    <view class="composer-card">
      <textarea
        class="composer-input"
        placeholder="输入你的回答..."
        value="{{answerText}}"
        bindinput="handleAnswerInput"
        maxlength="-1"
        auto-height
      />

      <view class="composer-record-row">
        <button class="btn-record btn-record-start" bindtap="startRecord" disabled="{{isRecording || recordBusy || uploadingAudio || transcribingAudio}}" loading="{{recordBusy && !isRecording}}">
          开始录音
        </button>
        <button class="btn-record btn-record-stop" bindtap="stopRecord" disabled="{{!isRecording || recordBusy}}" loading="{{recordBusy && isRecording}}">
          停止录音
        </button>
        <button class="btn-record btn-record-retry" bindtap="retryRecord" disabled="{{isRecording || uploadingAudio || transcribingAudio}}">
          重新练习
        </button>
      </view>

      <view class="composer-footer">
        <text class="record-tip">{{recordStatus}}</text>
        <button class="btn-send-icon" bindtap="submitEval" loading="{{loadingEval}}" disabled="{{!answerText}}">
          <text wx:if="{{!loadingEval}}" class="send-arrow">↑</text>
        </button>
      </view>
    </view>
  </view>
</view>
