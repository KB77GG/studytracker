<view class="container">
  <view class="hero">
    <text class="brand">HAMMER</text>
    <text class="subtitle">口语对练 · 逻辑梳理 · 高分改写</text>
  </view>

  <view class="card">
    <view class="section-title">模式设置</view>
    <view class="tabs">
      <view class="tab {{currentPart==='Part1' ? 'active' : ''}}" data-part="Part1" bindtap="switchPart">Part 1</view>
      <view class="tab {{currentPart==='Part2' ? 'active' : ''}}" data-part="Part2" bindtap="switchPart">Part 2</view>
      <view class="tab {{currentPart==='Part3' ? 'active' : ''}}" data-part="Part3" bindtap="switchPart">Part 3</view>
    </view>

    <view class="source-row">
      <view class="pill {{sourceMode==='assigned' ? 'active' : ''}}" data-mode="assigned" bindtap="switchSource">已布置</view>
      <view class="pill {{sourceMode==='random' ? 'active' : ''}}" data-mode="random" bindtap="switchSource">随机</view>
      <text class="source-tip" wx:if="{{sourceMode==='assigned' && assignedCount===0}}">暂无已布置题目，自动使用随机题</text>
    </view>

    <view class="framework" wx:if="{{currentPart !== 'Part1'}}">
      <text class="label">框架提示（可选）</text>
      <picker mode="selector" range="{{part2Options}}" range-key="label" bindchange="handleFrameworkChange">
        <view class="picker">{{selectedFrameworkLabel}}</view>
      </picker>
    </view>

    <button class="btn-outline" bindtap="nextQuestion" loading="{{loadingQuestion}}">换一题</button>
  </view>

  <view class="card chat-card">
    <view class="section-title">对话记录</view>
    <view class="empty" wx:if="{{messages.length === 0}}">暂无记录，点击“换一题”开始</view>
    <view class="chat-list" wx:else>
      <view class="chat-row {{item.role}}" wx:for="{{messages}}" wx:key="index">
        <view class="bubble {{item.role}}">
          <view wx:if="{{item.role === 'system'}}">
            <text class="bubble-label">题目</text>
            <text class="bubble-text">{{item.content}}</text>
          </view>
          <view wx:elif="{{item.role === 'user'}}">
            <text class="bubble-label">我</text>
            <text class="bubble-text">{{item.content}}</text>
          </view>
          <view wx:else>
            <text class="bubble-label">反馈</text>
            <view class="assistant-block" wx:if="{{item.result}}">
              <view class="assistant-title">逻辑梳理</view>
              <view class="logic-block" wx:if="{{item.result && item.result.logic_outline && item.result.logic_outline.zh.length}}">
                <text class="block-title">中文</text>
                <view class="list">
                  <text class="list-item" wx:for="{{item.result.logic_outline.zh}}" wx:key="*this">• {{item}}</text>
                </view>
              </view>
              <view class="logic-block" wx:if="{{item.result && item.result.logic_outline && item.result.logic_outline.en.length}}">
                <text class="block-title">English</text>
                <view class="list">
                  <text class="list-item" wx:for="{{item.result.logic_outline.en}}" wx:key="*this">• {{item}}</text>
                </view>
              </view>
            </view>

            <view class="assistant-block" wx:if="{{item.result}}">
              <view class="assistant-title">高分改写</view>
              <text class="rewrite">{{item.result.rewrite_high_band.paragraph}}</text>
              <view class="tts-row">
                <button class="btn-tts" bindtap="playRewriteAudio" data-text="{{item.result.rewrite_high_band.paragraph}}" loading="{{ttsLoading}}">
                  {{ttsPlaying ? '播放中...' : '播放改写'}}
                </button>
              </view>
              <view class="list" wx:if="{{item.result.rewrite_high_band.logic_tips.length}}">
                <text class="list-item" wx:for="{{item.result.rewrite_high_band.logic_tips}}" wx:key="*this">• {{item}}</text>
              </view>
            </view>

            <view class="assistant-block" wx:if="{{item.result && item.result.sentence_feedback.length}}">
              <view class="assistant-title">句子纠错</view>
              <view class="feedback-card" wx:for="{{item.result.sentence_feedback}}" wx:key="index">
                <text class="fb-original">原句：{{item.original}}</text>
                <text class="fb-correct">修正：{{item.correction}}</text>
                <text class="fb-note">{{item.explain_cn}}</text>
              </view>
            </view>

            <view class="assistant-block" wx:if="{{item.result && item.result.chinese_style_correction.length}}">
              <view class="assistant-title">中式表达纠正</view>
              <view class="feedback-card" wx:for="{{item.result.chinese_style_correction}}" wx:key="index">
                <text class="fb-original">原句：{{item.original}}</text>
                <text class="fb-correct">地道：{{item.native_like}}</text>
                <text class="fb-note">{{item.note}}</text>
              </view>
            </view>

            <view class="assistant-block" wx:if="{{item.result && item.result.lexical_upgrade.length}}">
              <view class="assistant-title">词汇升级</view>
              <view class="feedback-card" wx:for="{{item.result.lexical_upgrade}}" wx:key="index">
                <text class="fb-original">from：{{item.from}}</text>
                <text class="fb-correct">to：{{item.to.join(' / ')}}</text>
                <text class="fb-note">{{item.constraint}}</text>
              </view>
            </view>
            <view class="assistant-block" wx:else>
              <text class="bubble-text">暂无反馈内容</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <view class="card">
    <view class="section-title">我的回答</view>
    <view class="record-row">
      <button class="btn-record {{isRecording ? 'active' : ''}}" bindtap="toggleRecord" loading="{{uploadingAudio || transcribingAudio}}">
        {{isRecording ? '停止录音' : '开始录音'}}
      </button>
      <text class="record-tip">{{recordStatus}}</text>
    </view>
    <textarea class="answer" placeholder="输入你的回答..." value="{{answerText}}" bindinput="handleAnswerInput"></textarea>
    <button class="btn-primary" bindtap="submitEval" loading="{{loadingEval}}" disabled="{{!answerText}}">开始评估</button>
  </view>

</view>
