<view class="page-shell">
  <!-- è®¿å®¢æ¨¡å¼æç¤ºæ¡ -->
  <view class="guest-banner" wx:if="{{isGuest}}" style="padding-top: {{statusBarHeight + 8}}px;">
    <text class="guest-text">è®¿å®¢æ¨¡å¼æµè§ˆä¸­ Â· ç™»å½•è§£é”å…¨éƒ¨åŠŸèƒ½</text>
    <view class="guest-login-btn" bindtap="goLogin">ç™»å½•</view>
  </view>
  <view class="top-nav" style="padding-top: {{statusBarHeight + 8}}px;" catchtap="closeTransientPanels">
    <view class="nav-icon-btn" catchtap="openSessionDrawer" aria-label="æ‰“å¼€ç»ƒä¹ è®°å½•">
      <image class="header-icon" src="/assets/icons/history.svg" mode="aspectFit" />
    </view>
    <view class="nav-title-wrap">
      <text class="nav-title-brand">Hammer</text>
      <text class="nav-title-rest">Speaking</text>
    </view>
    <view class="part-selector" catchtap="openModeSheet" aria-label="åˆ‡æ¢ç»ƒä¹  Part">
      <image class="part-icon" src="/assets/icons/settings.svg" mode="aspectFit" />
      <text class="part-text">{{currentPart}}</text>
      <image class="part-chevron" src="/assets/icons/chevron-down.svg" mode="aspectFit" />
    </view>
  </view>

  <scroll-view
    class="message-scroll"
    scroll-y="true"
    enhanced="true"
    show-scrollbar="true"
    scroll-with-animation="true"
    scroll-top="{{chatScrollTop}}"
    bindscroll="onMessageScroll"
    bindtap="closeTransientPanels"
  >
    <view class="message-list">
      <view class="topic-card" wx:if="{{questionText}}" bindtap="closeTransientPanels">
        <view class="topic-header">
          <view class="topic-head-left">
            <text class="part-tag">{{currentPart}}</text>
            <text class="random-label">{{questionMeta || (sourceMode==='assigned' ? 'å·²å¸ƒç½®' : 'éšæœºé¢˜')}}</text>
          </view>
          <button class="change-btn" bindtap="nextQuestion" loading="{{loadingQuestion}}">
            <image class="change-icon" src="/assets/icons/refresh.svg" mode="aspectFit" />
            <text>æ¢é¢˜</text>
          </button>
        </view>

        <view wx:if="{{currentPart==='Part3'}}" class="topic-part3-block">
          <view class="topic-bullet" wx:for="{{part3Expanded ? topicQuestionsAll : topicQuestionsPreview}}" wx:for-item="q" wx:key="index">
            <view class="bullet-dot"></view>
            <text class="topic-bullet-text">{{q}}</text>
          </view>
          <view class="topic-expand" wx:if="{{showPart3Expand}}" bindtap="togglePart3Expand">
            <text>{{part3Expanded ? 'æ”¶èµ·' : 'å±•å¼€å…¨éƒ¨'}}</text>
            <image class="topic-expand-icon {{part3Expanded ? 'expanded' : ''}}" src="/assets/icons/chevron-down.svg" mode="aspectFit" />
          </view>
        </view>

        <view wx:else>
          <text class="topic-title">{{topicTitle}}</text>
          <text class="topic-prompt" wx:if="{{topicPromptLine}}">{{topicPromptLine}}</text>

          <view class="topic-bullets" wx:if="{{topicExpanded}}">
            <view class="topic-bullet" wx:for="{{topicCueLines}}" wx:for-item="line" wx:key="index">
              <view class="bullet-dot"></view>
              <text class="topic-bullet-text">{{line}}</text>
            </view>
          </view>

          <view class="topic-bullets" wx:else>
            <view class="topic-bullet" wx:for="{{topicCuePreview}}" wx:for-item="line" wx:key="index">
              <view class="bullet-dot"></view>
              <text class="topic-bullet-text">{{line}}</text>
            </view>
          </view>

          <view class="topic-expand" wx:if="{{showTopicExpand}}" bindtap="toggleTopicExpand">
            <text>{{topicExpanded ? 'æ”¶èµ·é¢˜ç›®' : 'å±•å¼€é¢˜ç›®'}}</text>
            <image class="topic-expand-icon {{topicExpanded ? 'expanded' : ''}}" src="/assets/icons/chevron-down.svg" mode="aspectFit" />
          </view>
        </view>
      </view>

      <view class="empty-state" wx:if="{{messages.length===0}}">å‡†å¤‡å¥½äº†å°±å¼€å§‹å›ç­”å§</view>

      <block wx:for="{{messages}}" wx:for-item="msg" wx:key="id">
        <view class="system-row" wx:if="{{msg.role==='system'}}">
          <view class="system-strip">{{msg.content}}</view>
        </view>

        <view class="bubble-row user" wx:elif="{{msg.role==='user'}}" data-id="{{msg.id}}" bindlongpress="handleMessageLongPress">
          <view class="avatar user-av">æˆ‘</view>
          <view class="bubble user">
            <text class="bubble-text">{{msg.content}}</text>
            <view class="user-meta-row">
              <button class="small-link" wx:if="{{msg.audio_url}}" bindtap="playMessageAudio" data-url="{{msg.audio_url}}">å›å¬å½•éŸ³</button>
              <text class="status-text" wx:if="{{msg.status==='sending'}}">å‘é€ä¸­...</text>
              <view class="status-text failed" wx:if="{{msg.status==='failed'}}">
                <text>{{msg.errorText || 'å‘é€å¤±è´¥'}}</text>
                <text class="retry-text" bindtap="retryMessageEval" data-id="{{msg.id}}">é‡è¯•</text>
              </view>
            </view>
          </view>
        </view>

        <view class="bubble-row ai" wx:elif="{{msg.role==='assistant' && msg.type==='typing'}}" data-id="{{msg.id}}">
          <view class="avatar ai-av">ğŸ¤–</view>
          <view class="assistant-stack">
            <view class="bubble ai typing-bubble">
              <view class="typing-dots">
                <view class="typing-dot"></view>
                <view class="typing-dot"></view>
                <view class="typing-dot"></view>
              </view>
            </view>
          </view>
        </view>

        <view class="bubble-row ai" wx:else data-id="{{msg.id}}" bindlongpress="handleMessageLongPress">
          <view class="avatar ai-av">ğŸ¤–</view>

          <view class="assistant-stack">
            <view class="bubble ai">
              <text class="bubble-text">{{msg.content || (msg.result ? 'è®©æˆ‘æ¥çœ‹çœ‹ä½ çš„å›ç­”...' : 'æš‚æ— åé¦ˆå†…å®¹')}}</text>
            </view>

            <view class="feedback-card" wx:if="{{msg.result && msg.result.scores}}">
              <view class="feedback-title">
                <text class="feedback-star">â˜†</text>
                <text>AI è¯„åˆ†åé¦ˆ</text>
              </view>
              <view class="score-row">
                <view class="score-pill"><text class="score-label">æµåˆ©åº¦</text><text class="score-val">{{msg.result.scores.fluency_coherence}}</text></view>
                <view class="score-pill"><text class="score-label">è¯æ±‡é‡</text><text class="score-val">{{msg.result.scores.lexical_resource}}</text></view>
                <view class="score-pill"><text class="score-label">è¯­æ³•</text><text class="score-val">{{msg.result.scores.grammar_range_accuracy}}</text></view>
                <view class="score-pill"><text class="score-label">å‘éŸ³</text><text class="score-val">{{msg.result.scores.pronunciation}}</text></view>
              </view>
              <text class="overall-score" wx:if="{{msg.result.scores.overall}}">Overall: {{msg.result.scores.overall}}</text>
              <text class="feedback-text">{{msg.result.summary_text || 'ç»§ç»­ä¿æŒï¼Œå»ºè®®åœ¨è¡¨è¾¾å±‚æ¬¡å’Œè¯æ±‡å¤šæ ·æ€§ä¸Šè¿›ä¸€æ­¥æå‡ã€‚'}}</text>
            </view>

            <view class="assistant-block" wx:if="{{msg.result && msg.result.criteria_feedback && msg.result.criteria_feedback.fluency_coherence}}">
              <text class="assistant-title">Fluency & Coherenceï¼ˆå«é€»è¾‘æ¡†æ¶ï¼‰</text>
              <text class="line-item" wx:for="{{msg.result.criteria_feedback.fluency_coherence.plus}}" wx:for-item="line" wx:key="*this">+ {{line}}</text>
              <text class="line-item minus" wx:for="{{msg.result.criteria_feedback.fluency_coherence.minus}}" wx:for-item="line" wx:key="*this">- {{line}}</text>
            </view>

            <view class="assistant-block" wx:if="{{msg.result && msg.result.logic_outline}}">
              <text class="assistant-title">é€»è¾‘æ¢³ç†</text>
              <text class="line-item" wx:for="{{msg.result.logic_outline.zh}}" wx:for-item="line" wx:key="*this">â€¢ {{line}}</text>
              <text class="line-item" wx:for="{{msg.result.logic_outline.en}}" wx:for-item="line" wx:key="*this">â€¢ {{line}}</text>
            </view>

            <view class="assistant-block" wx:if="{{msg.result && msg.result.rewrite_high_band && msg.result.rewrite_high_band.paragraph}}">
              <text class="assistant-title">é«˜åˆ†æ”¹å†™</text>
              <text class="bubble-text">{{msg.result.rewrite_high_band.paragraph}}</text>
              <button class="small-link" bindtap="playRewriteAudio" data-text="{{msg.result.rewrite_high_band.paragraph}}" loading="{{ttsLoading}}">{{ttsPlaying ? 'æ’­æ”¾ä¸­...' : 'æ’­æ”¾æ”¹å†™'}}</button>
              <text class="line-item" wx:for="{{msg.result.rewrite_high_band.logic_tips}}" wx:for-item="tip" wx:key="*this">â€¢ {{tip}}</text>
            </view>

            <view class="assistant-block" wx:if="{{msg.result && msg.result.sentence_feedback.length}}">
              <text class="assistant-title">å¥å­çº é”™</text>
              <view class="detail-card" wx:for="{{msg.result.sentence_feedback}}" wx:for-item="fb" wx:key="index">
                <text class="line-item">åŸå¥ï¼š{{fb.original}}</text>
                <text class="line-item highlight">ä¿®æ­£ï¼š{{fb.correction}}</text>
                <text class="line-item tip">{{fb.explain_cn}}</text>
              </view>
            </view>

            <view class="assistant-block" wx:if="{{msg.result && msg.result.chinese_style_correction.length}}">
              <text class="assistant-title">Lexical Resourceï¼šä¸­å¼è¡¨è¾¾çº æ­£</text>
              <view class="detail-card" wx:for="{{msg.result.chinese_style_correction}}" wx:for-item="fb" wx:key="index">
                <text class="line-item">åŸå¥ï¼š{{fb.original}}</text>
                <text class="line-item highlight">åœ°é“ï¼š{{fb.native_like}}</text>
                <text class="line-item tip">{{fb.note}}</text>
              </view>
            </view>

            <view class="assistant-block" wx:if="{{msg.result && msg.result.lexical_upgrade.length}}">
              <text class="assistant-title">Lexical Resourceï¼šè¯æ±‡å‡çº§</text>
              <view class="detail-card" wx:for="{{msg.result.lexical_upgrade}}" wx:for-item="lex" wx:key="index">
                <text class="line-item">fromï¼š{{lex.from}}</text>
                <text class="line-item highlight">toï¼š{{lex.to.join(' / ')}}</text>
                <text class="line-item tip">{{lex.constraint}}</text>
              </view>
            </view>

            <view class="assistant-block" wx:if="{{msg.result && msg.result.next_step.length}}">
              <text class="assistant-title">ä¸‹ä¸€æ­¥ç»ƒä¹ å»ºè®®</text>
              <text class="line-item" wx:for="{{msg.result.next_step}}" wx:for-item="step" wx:key="*this">â€¢ {{step}}</text>
            </view>
          </view>
        </view>
      </block>

      <view class="quick-reply-row" wx:if="{{quickReplies.length > 0}}">
        <view
          class="quick-reply-chip"
          wx:for="{{quickReplies}}"
          wx:key="action"
          data-action="{{item.action}}"
          bindtap="handleQuickReply"
        >
          <text>{{item.label}}</text>
        </view>
      </view>

      <view class="bottom-pad"></view>
    </view>
  </scroll-view>

  <button class="to-bottom-btn" wx:if="{{showToBottom}}" bindtap="scrollToBottom" style="transform: {{toBottomTransform}};">
    <image class="to-bottom-icon" src="/assets/icons/arrow-down.svg" mode="aspectFit" />
  </button>

  <view class="composer-wrap" style="transform: {{composerTransform}};">
    <view class="composer-panel">
      <view class="quick-actions" wx:if="{{showQuickActions}}">
        <view class="quick-item" data-action="toggle_oral" bindtap="handleQuickActionTap">{{inputMode==='oral_sdk' ? 'å‘éŸ³å¢å¼ºï¼šå¼€' : 'å‘éŸ³å¢å¼ºï¼šå…³'}}</view>
        <view class="quick-item" data-action="framework_person" bindtap="handleQuickActionTap">äººç‰©æ¡†æ¶æç¤º</view>
        <view class="quick-item" data-action="framework_place" bindtap="handleQuickActionTap">åœ°ç‚¹æ¡†æ¶æç¤º</view>
        <view class="quick-item" data-action="high_band" bindtap="handleQuickActionTap">æ’å…¥é«˜åˆ†å¥å‹</view>
        <view class="quick-item" data-action="followup" bindtap="handleQuickActionTap">è¿½é—®/çº é”™/æ¶¦è‰²</view>
      </view>

      <view class="recording-strip" wx:if="{{voiceUiMode === 'recording'}}">
        <button class="recording-btn" bindtap="handleRecordCancel" disabled="{{recordBusy}}">
          <text class="recording-btn-text">âœ•</text>
        </button>
        <view class="recording-wave-wrap">
          <view class="recording-wave">
            <view class="wave-bar" wx:for="{{waveBars}}" wx:key="index" style="height: {{item}}rpx;"></view>
          </view>
          <text class="recording-time">{{recordTimerLabel}}</text>
        </view>
        <button class="recording-btn confirm" bindtap="handleRecordConfirm" disabled="{{recordBusy}}">
          <text class="recording-btn-text">âœ“</text>
        </button>
      </view>

      <view class="composer-row" wx:else>
        <button class="input-add-btn" bindtap="toggleQuickActions" aria-label="æ›´å¤šæ“ä½œ">
          <image class="plus-icon" src="/assets/icons/plus.svg" mode="aspectFit" />
        </button>

        <view class="composer-input-wrap">
          <textarea
            class="input-field"
            placeholder="ç‚¹å‡»éº¦å…‹é£å¼€å§‹å½•éŸ³..."
            placeholder-style="color: #5A7472;"
            value="{{answerText}}"
            bindinput="handleAnswerInput"
            bindfocus="onComposerFocus"
            bindblur="onComposerBlur"
            bindkeyboardheightchange="onComposerKeyboardHeightChange"
            maxlength="-1"
            auto-height
            cursor-spacing="32"
          />
        </view>

        <button
          class="mic-btn {{isRecording ? 'recording' : ''}}"
          wx:if="{{!canSend}}"
          bindtap="onMicTap"
          disabled="{{isRecording || recordBusy || uploadingAudio || transcribingAudio}}"
          aria-label="å¼€å§‹å½•éŸ³"
        >
          <image class="mic-icon" src="/assets/icons/mic.svg" mode="aspectFit" />
        </button>

        <button
          class="send-btn {{canSend ? 'show' : ''}}"
          wx:else
          bindtap="submitEval"
          disabled="{{loadingEval || isRecording || recordBusy || uploadingAudio || transcribingAudio}}"
          loading="{{loadingEval}}"
          aria-label="å‘é€è¯„ä¼°"
        >
          <image class="send-icon" src="/assets/icons/send.svg" mode="aspectFit" />
        </button>
      </view>

      <view class="record-status-pill" wx:if="{{recordStatus}}">{{recordStatus}}</view>
      <view class="record-status-pill" wx:if="{{inputMode==='oral_sdk' && oralEngineStatus}}">{{oralEngineStatus}}</view>
    </view>
  </view>

  <view class="context-mask" wx:if="{{showContextMenu}}" bindtap="closeContextMenu"></view>
  <view class="context-menu" wx:if="{{showContextMenu}}">
    <view class="context-item" wx:for="{{contextMenuItems}}" wx:key="action" data-action="{{item.action}}" bindtap="handleContextMenuAction">
      <image class="context-icon" src="{{item.icon}}" mode="aspectFit" />
      <text class="context-label">{{item.label}}</text>
    </view>
  </view>

  <view class="sheet-mask" wx:if="{{showModeSheet}}" bindtap="closeModeSheet"></view>
  <view class="mode-sheet {{showModeSheet ? 'open' : ''}}" wx:if="{{showModeSheet}}" catchtouchmove="noop" bindtouchstart="onSheetTouchStart" bindtouchend="onSheetTouchEnd">
    <view class="sheet-handle"></view>

    <view class="sheet-section">
      <text class="sheet-label">Part</text>
      <view class="segmented">
        <view class="seg-item {{currentPart==='Part1' ? 'active' : ''}}" data-part="Part1" bindtap="switchPart">Part 1</view>
        <view class="seg-item {{currentPart==='Part2' ? 'active' : ''}}" data-part="Part2" bindtap="switchPart">Part 2</view>
        <view class="seg-item {{currentPart==='Part3' ? 'active' : ''}}" data-part="Part3" bindtap="switchPart">Part 3</view>
      </view>
    </view>

    <view class="sheet-section">
      <text class="sheet-label">é¢˜æº</text>
      <view class="segmented compact">
        <view class="seg-item {{sourceMode==='assigned' ? 'active' : ''}}" data-mode="assigned" bindtap="switchSource">å·²å¸ƒç½®</view>
        <view class="seg-item {{sourceMode==='random' ? 'active' : ''}}" data-mode="random" bindtap="switchSource">éšæœº</view>
      </view>
      <text class="sheet-tip" wx:if="{{sourceMode==='assigned' && assignedCount===0}}">æš‚æ— å·²å¸ƒç½®é¢˜ç›®ï¼Œè‡ªåŠ¨ä½¿ç”¨éšæœºé¢˜</text>
    </view>

    <view class="sheet-section" wx:if="{{currentPart!=='Part1'}}">
      <text class="sheet-label">æ¡†æ¶æç¤º</text>
      <view class="chip-wrap">
        <view class="chip {{selectedFramework==='' ? 'active' : ''}}" data-value="" bindtap="handleFrameworkTagTap">ä¸æŒ‡å®š</view>
        <view class="chip {{selectedFramework===opt.value ? 'active' : ''}}" wx:for="{{part2Options}}" wx:for-item="opt" wx:key="value" data-value="{{opt.value}}" bindtap="handleFrameworkTagTap" wx:if="{{opt.value}}">{{opt.label}}</view>
      </view>
    </view>

    <view class="sheet-actions">
      <button class="sheet-btn" bindtap="nextQuestion" loading="{{loadingQuestion}}">
        <image class="sheet-btn-icon" src="/assets/icons/refresh.svg" mode="aspectFit" />
        <text>æ¢ä¸€é¢˜</text>
      </button>
      <button class="sheet-btn ghost" bindtap="startNewSession">æ–°å¯¹è¯</button>
    </view>
  </view>

  <view class="session-mask" wx:if="{{sessionDrawerOpen}}" bindtap="closeSessionDrawer"></view>
  <view class="session-drawer {{sessionDrawerOpen ? 'open' : ''}}">
    <view class="session-drawer-head">
      <text class="session-drawer-title">ç»ƒä¹ è®°å½•</text>
      <text class="session-drawer-close" bindtap="closeSessionDrawer">å…³é—­</text>
    </view>
    <button class="session-new-btn" bindtap="startNewSession">+ æ–°å¯¹è¯</button>

    <view class="session-empty" wx:if="{{sessionLoading}}">åŠ è½½ä¸­...</view>
    <view class="session-empty" wx:elif="{{sessionList.length===0}}">æš‚æ— è®°å½•</view>

    <scroll-view class="session-list" scroll-y="true" enhanced="true" show-scrollbar="true" wx:else>
      <view class="session-item {{item.id===activeSessionId ? 'active' : ''}}" wx:for="{{sessionList}}" wx:key="id" bindtap="openSessionFromList" data-id="{{item.id}}">
        <view class="session-item-top">
          <text class="session-part">{{item.part}}</text>
          <text class="session-time">{{item.createdLabel}}</text>
        </view>
        <text class="session-preview">{{item.preview}}</text>
      </view>
    </scroll-view>
  </view>
</view>
